---
phase: 07-hd-viewport-camera
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - client/src/main.ts
  - client/src/ui/designTokens.ts
  - shared/physics.ts
  - client/src/systems/Prediction.ts
  - server/src/rooms/GameRoom.ts
autonomous: true

must_haves:
  truths:
    - "Game canvas launches at 1280x720 with pixelArt and roundPixels enabled"
    - "ARENA bounds are dynamic -- PredictionSystem and GameRoom use map-specific dimensions, not the hardcoded constant"
    - "Layout constants in designTokens.ts reflect 1280x720 canvas and viewport-relative HUD positions"
    - "Physics edge clamping uses per-map bounds on both server and client"
  artifacts:
    - path: "client/src/main.ts"
      provides: "Phaser game config at 1280x720 with pixelArt, roundPixels, FIT scaling"
      contains: "width: 1280"
    - path: "shared/physics.ts"
      provides: "ARENA constant as default with explicit comment about dynamic override"
      contains: "ARENA"
    - path: "client/src/systems/Prediction.ts"
      provides: "PredictionSystem with dynamic arena bounds constructor parameter"
      contains: "arenaBounds"
    - path: "server/src/rooms/GameRoom.ts"
      provides: "GameRoom using mapMetadata dimensions for physics edge clamping"
      contains: "mapMetadata"
    - path: "client/src/ui/designTokens.ts"
      provides: "Layout constants for 1280x720 canvas with viewport-relative HUD positions"
      contains: "width: 1280"
  key_links:
    - from: "client/src/systems/Prediction.ts"
      to: "shared/physics.ts"
      via: "ARENA import still exists as fallback, but constructor accepts override"
      pattern: "arenaBounds.*ARENA"
    - from: "server/src/rooms/GameRoom.ts"
      to: "shared/maps.ts"
      via: "mapMetadata.width/height used instead of ARENA.width/height"
      pattern: "this\\.mapMetadata\\.(width|height)"
---

<objective>
Set up the core resolution configuration (1280x720 canvas with pixel art settings) and make arena bounds dynamic so physics edge-clamping works with any map size rather than the hardcoded ARENA constant.

Purpose: This is the foundational config change that all other plans depend on. The canvas must be 1280x720 before camera zoom or UI repositioning makes sense. Dynamic arena bounds unblocks Phase 8's larger arenas.
Output: Updated game config, layout constants, and dynamic bounds in PredictionSystem + GameRoom.
</objective>

<execution_context>
@/Users/jonasbrandvik/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jonasbrandvik/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@client/src/main.ts
@client/src/ui/designTokens.ts
@shared/physics.ts
@client/src/systems/Prediction.ts
@server/src/rooms/GameRoom.ts
@shared/maps.ts
@.planning/phases/07-hd-viewport-camera/07-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update game config to 1280x720 and Layout constants</name>
  <files>client/src/main.ts, client/src/ui/designTokens.ts</files>
  <action>
**client/src/main.ts:**
Update the Phaser game config:
- `width: 1280` (was 800)
- `height: 720` (was 600)
- Add `roundPixels: true` to config (global pixel rounding)
- Keep `pixelArt: true` (already present)
- Keep `scale: { mode: Phaser.Scale.FIT, autoCenter: Phaser.Scale.CENTER_BOTH }` (already present)
- Remove the `physics` block (arcade physics is not used -- the game uses custom shared physics)

**client/src/ui/designTokens.ts:**
Update the `Layout` constant:
- `canvas: { width: 1280, height: 720 }` (was 800x600)
- `center: { x: 640, y: 360 }` (was 400x300)
- `maxContentWidth: 960` (was 640 -- scale proportionally)
- `margin: 120` (was 80 -- scale proportionally)
- Update `hud` section to use viewport-relative values suitable for 1280x720:
  - `roleReminder: { x: 15, y: 15 }` (slight adjustment)
  - `timer: { x: 640, y: 25 }` (center of 1280)
  - `ping: { x: 1250, y: 25 }` (right side of 1280)
  - `killFeed: { x: 1265, y: 70 }` (right side)
  - `cooldown: { x: 640, y: 680 }` (center-bottom)
  - `healthBarY: 695` (near bottom of 720)

These HUD values are initial positions -- Plan 05 will do the full viewport-relative conversion. For now they just need to not be off-screen at 1280x720.
  </action>
  <verify>
1. `grep -n "width: 1280" client/src/main.ts` finds the config line
2. `grep -n "height: 720" client/src/main.ts` finds the config line
3. `grep -n "roundPixels: true" client/src/main.ts` finds the config line
4. `grep -n "width: 1280" client/src/ui/designTokens.ts` finds Layout.canvas
5. `grep -n "x: 640" client/src/ui/designTokens.ts` finds Layout.center
  </verify>
  <done>Game config set to 1280x720 with roundPixels enabled. Layout constants updated for new resolution. No arcade physics block (unused).</done>
</task>

<task type="auto">
  <name>Task 2: Make arena bounds dynamic in PredictionSystem and GameRoom</name>
  <files>shared/physics.ts, client/src/systems/Prediction.ts, server/src/rooms/GameRoom.ts</files>
  <action>
**shared/physics.ts:**
Add a comment to the `ARENA` constant marking it as a default/fallback. No structural change needed -- it stays as-is for backwards compatibility:
```typescript
/** Default arena bounds. Server and client should use map-specific bounds from MapMetadata instead. */
export const ARENA = {
  width: 800,
  height: 608,
};
```

**client/src/systems/Prediction.ts:**
- Add an `arenaBounds` property: `private arenaBounds: { width: number; height: number };`
- Update constructor to accept optional arena bounds: `constructor(initialState: PlayerState, role: string, arenaBounds?: { width: number; height: number })`
- In constructor: `this.arenaBounds = arenaBounds || ARENA;`
- Replace ALL 4 occurrences of `ARENA.width` with `this.arenaBounds.width` (lines ~106, ~107, ~169, ~170)
- Replace ALL 4 occurrences of `ARENA.height` with `this.arenaBounds.height`
- Keep the `ARENA` import as it's still the fallback default

**server/src/rooms/GameRoom.ts:**
- The GameRoom already has access to `this.mapMetadata` (from `shared/maps.ts`) which has `.width` and `.height` fields
- Find the two lines that use `ARENA.width` and `ARENA.height` for edge clamping (approximately line 342-343):
  ```typescript
  player.x = Math.max(0, Math.min(ARENA.width, player.x));
  player.y = Math.max(0, Math.min(ARENA.height, player.y));
  ```
  Replace with:
  ```typescript
  player.x = Math.max(0, Math.min(this.mapMetadata.width, player.x));
  player.y = Math.max(0, Math.min(this.mapMetadata.height, player.y));
  ```
- Find the projectile bounds check that uses `ARENA.width`/`ARENA.height` (approximately line 524):
  ```typescript
  if (proj.x < 0 || proj.x > ARENA.width || proj.y < 0 || proj.y > ARENA.height)
  ```
  Replace with:
  ```typescript
  if (proj.x < 0 || proj.x > this.mapMetadata.width || proj.y < 0 || proj.y > this.mapMetadata.height)
  ```
- Remove the `ARENA` import from GameRoom.ts if it's no longer used anywhere in the file (check all usages first). Keep `PHYSICS` import.
  </action>
  <verify>
1. `grep -n "arenaBounds" client/src/systems/Prediction.ts` shows constructor param and usage
2. `grep -n "ARENA\\.width" client/src/systems/Prediction.ts` returns NO matches (all replaced with arenaBounds)
3. `grep -n "ARENA\\.height" client/src/systems/Prediction.ts` returns NO matches
4. `grep -n "mapMetadata\\.width" server/src/rooms/GameRoom.ts` shows edge-clamp usage
5. `grep -n "ARENA" server/src/rooms/GameRoom.ts` returns no import (or only if still needed elsewhere)
6. `cd server && npx tsc --noEmit` compiles without errors
  </verify>
  <done>Arena bounds are fully dynamic. PredictionSystem accepts map-specific bounds in constructor (falls back to ARENA default). GameRoom uses mapMetadata dimensions for all edge clamping and projectile bounds checks. The ARENA constant is preserved as a default but is no longer the authority.</done>
</task>

</tasks>

<verification>
- Game config at 1280x720 with roundPixels
- No hardcoded ARENA references in PredictionSystem edge clamping (uses arenaBounds)
- No hardcoded ARENA references in GameRoom edge clamping (uses mapMetadata)
- Server TypeScript compiles without errors
- Layout constants reflect 1280x720
</verification>

<success_criteria>
The game would launch at 1280x720 (though assets are still 1x at this point), and physics edge-clamping is map-aware on both client and server. This unblocks camera setup (Plan 04) and UI repositioning (Plan 05).
</success_criteria>

<output>
After completion, create `.planning/phases/07-hd-viewport-camera/07-02-SUMMARY.md`
</output>
