---
phase: 07-hd-viewport-camera
plan: 07
type: execute
wave: 1
depends_on: []
files_modified: [client/src/scenes/GameScene.ts]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Camera follows the local player for ALL roles (paran, faran, baran) every match"
    - "Match-start overview reliably fires for all 3 players including the last to join"
    - "Camera look-ahead visibly shifts in the movement direction during normal gameplay"
  artifacts:
    - path: "client/src/scenes/GameScene.ts"
      provides: "Race-condition-safe camera follow + visible look-ahead"
      contains: "pendingOverview"
  key_links:
    - from: "matchState listener"
      to: "startMatchOverview"
      via: "deferred call when mapMetadata not yet set"
      pattern: "pendingOverview"
    - from: "createTilemap"
      to: "startMatchOverview"
      via: "fires pending overview after tilemap load"
      pattern: "pendingOverview.*startMatchOverview"
    - from: "look-ahead lerp"
      to: "camera followOffset"
      via: "OFFSET_LERP >= 0.12"
      pattern: "OFFSET_LERP.*0\\.1[2-5]"
---

<objective>
Fix camera follow race condition (Tests 7 + 12) and look-ahead tuning (Test 9).

Purpose: Camera follow fails for the last player to join because `state.listen("matchState")` fires BEFORE `onStateChange.once()` sets mapMetadata in Colyseus 0.15. The look-ahead effect is invisible because OFFSET_LERP=0.04 is too slow for the game's fast direction changes.

Output: Reliable camera follow for all players in every match, visible look-ahead effect.
</objective>

<execution_context>
@/Users/jonasbrandvik/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jonasbrandvik/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-hd-viewport-camera/07-04-SUMMARY.md
@.planning/debug/camera-follow-flaky.md
@.planning/debug/camera-look-ahead-broken.md
@client/src/scenes/GameScene.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix mapMetadata race condition with deferred overview and fallback camera follow</name>
  <files>client/src/scenes/GameScene.ts</files>
  <action>
Fix the camera follow race condition where the 3rd player to join never gets camera follow because `startMatchOverview()` silently returns when `mapMetadata` is null.

**Root cause:** In Colyseus 0.15, `state.listen("matchState")` fires DURING patch processing, BEFORE `onStateChange.once()` completes. The 3rd player receives matchState='playing' in their initial state sync, so the matchState listener calls `startMatchOverview()` before `onStateChange.once()` has set `this.mapMetadata`. The guard `if (!this.mapMetadata) return` silently skips camera setup, and no fallback exists.

**Implementation (two-pronged fix):**

1. Add a `pendingOverview: boolean` member variable (initialized to `false` in `create()`).

2. In `startMatchOverview()` (~line 1221): Instead of silently returning when `!this.mapMetadata`, set `this.pendingOverview = true` and return. This defers the overview until the tilemap loads.

3. In `createTilemap()` at the END (~after line 1325, after "Tilemap created successfully"): Add a check:
   ```typescript
   // Fire deferred match overview if matchState arrived before mapMetadata
   if (this.pendingOverview) {
     this.pendingOverview = false;
     this.startMatchOverview();
   }
   ```
   This catches the race condition: mapMetadata is now set (line 218), tilemap is loaded, so `startMatchOverview()` will succeed.

4. Add a FALLBACK camera follow in `createTilemap()` right after the existing camera bounds/zoom block (~line 1319-1323). After `cam.setZoom(2)`, add:
   ```typescript
   // Fallback: if no overview animation is pending and camera isn't following anyone,
   // start following local player directly (safety net for any missed code path)
   if (!this.pendingOverview && !cam._follow && this.room) {
     const localSprite = this.playerSprites.get(this.room.sessionId);
     if (localSprite) {
       cam.startFollow(localSprite, true, 0.08, 0.08);
       cam.setDeadzone(40, 30);
     }
   }
   ```
   Note: `cam._follow` is Phaser's internal reference to the followed target (null when not following). This fallback ensures camera follow is established even if both the overview and deferred mechanisms somehow fail.

**What NOT to do:**
- Do NOT move the `onStateChange.once()` callback -- it handles map loading which is separate.
- Do NOT change the matchState listener structure -- it handles audio and status text too.
- Do NOT add a polling/interval check -- the deferred flag is cleaner.
  </action>
  <verify>
1. `grep -n "pendingOverview" client/src/scenes/GameScene.ts` shows: member declaration, reset in create(), set to true in startMatchOverview early return, checked+cleared in createTilemap.
2. `grep -n "cam._follow" client/src/scenes/GameScene.ts` shows the fallback in createTilemap.
3. No TypeScript compilation errors: `cd client && npx tsc --noEmit`
  </verify>
  <done>
- startMatchOverview defers via pendingOverview flag when mapMetadata is null
- createTilemap fires deferred overview after tilemap load
- Fallback camera follow exists in createTilemap as safety net
- All 3 players (including the last to join) get camera follow every match
  </done>
</task>

<task type="auto">
  <name>Task 2: Tune look-ahead to be visibly noticeable during normal gameplay</name>
  <files>client/src/scenes/GameScene.ts</files>
  <action>
The look-ahead effect is functionally correct but practically invisible because the lerp rates are too slow for the game's fast-paced movement dynamics.

**Changes (all in the update() method look-ahead block, ~lines 572-595):**

1. Increase `OFFSET_LERP` from `0.04` to `0.14`. This brings settling time from ~2.5s down to ~0.5s, making the effect visible during typical Paran runs (0.5-2s sustained direction).

2. In `startMatchOverview()` (~line 1241), increase camera follow lerp from `0.08` to `0.12`:
   ```typescript
   cam.startFollow(localSprite, true, 0.12, 0.12);
   ```
   Also update the fallback follow added in Task 1 to use `0.12`.

3. Reduce deadzone from `40, 30` to `20, 15` in `startMatchOverview()` (~line 1242):
   ```typescript
   cam.setDeadzone(20, 15);
   ```
   Also update the fallback deadzone added in Task 1 to use `20, 15`.
   NOTE: Do NOT change spectator deadzone (60, 45) -- that's intentionally wider for smooth spectating.

**What NOT to do:**
- Do NOT change `LOOK_AHEAD_PARAN` (60) or `LOOK_AHEAD_GUARDIAN` (30) -- the max offset distances are fine, it's the lerp speed that's the issue.
- Do NOT change the speed zoom lerp (0.03) -- that's a different system and feels correct.
- Do NOT touch spectator camera settings (lines 401, 406, 432, 454).
  </action>
  <verify>
1. `grep -n "OFFSET_LERP" client/src/scenes/GameScene.ts` shows value 0.14
2. `grep -n "startFollow.*0.12" client/src/scenes/GameScene.ts` shows the updated lerp values
3. `grep -n "setDeadzone.*20.*15" client/src/scenes/GameScene.ts` shows the reduced deadzone
4. `grep -n "setDeadzone.*60.*45" client/src/scenes/GameScene.ts` still shows spectator deadzone unchanged
5. No TypeScript compilation errors: `cd client && npx tsc --noEmit`
  </verify>
  <done>
- OFFSET_LERP is 0.14 (was 0.04) for ~3.5x faster look-ahead response
- Camera follow lerp is 0.12 (was 0.08) for snappier tracking
- Deadzone is 20x15 (was 40x30) so small movements trigger camera follow sooner
- Spectator camera settings remain unchanged at 60x45 / 0.06 lerp
- Look-ahead effect is visibly noticeable during normal Paran and Guardian movement
  </done>
</task>

</tasks>

<verification>
1. Start server and 3 browser clients. Join a lobby, ready up, start match.
2. Verify ALL 3 players have camera follow (not just the first player or Paran).
3. Refresh one browser, create new match -- verify camera follow works after reconnect/new match.
4. Play as Paran: move in one direction and observe camera shift ahead of movement.
5. Play as Guardian: move diagonally, observe subtle camera shift in movement direction.
6. Verify match-start overview animation fires reliably for all players.
</verification>

<success_criteria>
- Camera follows local player for all 3 roles in every match (Test 7: pass)
- Match-start overview fires reliably for all players including the last to join (Test 12: pass)
- Look-ahead visibly shifts camera in movement direction during normal gameplay (Test 9: pass)
</success_criteria>

<output>
After completion, create `.planning/phases/07-hd-viewport-camera/07-07-SUMMARY.md`
</output>
