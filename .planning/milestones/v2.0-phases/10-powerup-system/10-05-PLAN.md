---
phase: 10-powerup-system
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/powerups.ts
  - client/src/scenes/GameScene.ts
  - client/src/scenes/BootScene.ts
  - client/src/systems/ParticleFactory.ts
  - client/src/systems/AudioManager.ts
  - client/public/soundeffects/powerup_1.wav
autonomous: true
gap_closure: true
requirements: [PWR-01, PWR-02, PWR-03, PWR-05]

must_haves:
  truths:
    - "Powerup ground sprites render at 32x32 with a visible idle particle aura"
    - "Picking up a powerup plays the provided WAV file (assets/soundeffects/powerup_1.wav)"
    - "All three buff aura effects (speed/invincibility/projectile) are clearly visible around the player"
    - "Buff durations are 5x longer (speed 22500ms, invincibility 12500ms, projectile 27500ms)"
    - "Guardian projectile buff aura renders correctly (Number() cast prevents type mismatch)"
  artifacts:
    - path: "shared/powerups.ts"
      provides: "5x buff durations"
      contains: "speedDuration: 22500"
    - path: "client/src/systems/ParticleFactory.ts"
      provides: "Enhanced aura visibility + idle aura method"
      exports: ["createPowerupIdleAura"]
    - path: "client/src/systems/AudioManager.ts"
      provides: "WAV playback support"
      exports: ["playWAVSFX"]
    - path: "client/public/soundeffects/powerup_1.wav"
      provides: "Powerup pickup WAV asset"
  key_links:
    - from: "client/src/scenes/GameScene.ts"
      to: "ParticleFactory.createPowerupIdleAura"
      via: "powerup onAdd handler creates idle aura, onRemove destroys it"
      pattern: "particleFactory\\.createPowerupIdleAura"
    - from: "client/src/scenes/GameScene.ts"
      to: "AudioManager.playWAVSFX"
      via: "powerupCollect handler plays WAV instead of jsfxr"
      pattern: "playWAVSFX.*powerup_pickup"
    - from: "client/src/scenes/GameScene.ts"
      to: "startBuffAura"
      via: "Number(data.type) cast prevents string/number switch miss"
      pattern: "Number\\(data\\.type\\)"
---

<objective>
Fix 4 UAT gaps from Phase 10 powerup system: enlarge ground powerup sprites to 32x32 with idle particle aura, replace jsfxr pickup SFX with provided WAV file, increase all buff aura particle visibility, multiply all buff durations by 5x, and fix guardian projectile aura not rendering due to type coercion bug.

Purpose: Address all user-reported feedback from powerup system UAT testing.
Output: All 4 gaps resolved -- powerups visually prominent, correct SFX, visible auras, longer buffs.
</objective>

<execution_context>
@/Users/jonasbrandvik/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jonasbrandvik/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-powerup-system/10-UAT.md
@.planning/phases/10-powerup-system/10-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Buff durations, WAV audio pipeline, and enhanced particle auras</name>
  <files>
    shared/powerups.ts
    client/src/systems/AudioManager.ts
    client/src/systems/ParticleFactory.ts
    client/src/scenes/BootScene.ts
    client/public/soundeffects/powerup_1.wav
  </files>
  <action>
    **1. Buff durations (shared/powerups.ts):**
    Multiply all three duration values by 5:
    - `speedDuration: 4500` -> `speedDuration: 22500`
    - `invincibilityDuration: 2500` -> `invincibilityDuration: 12500`
    - `projectileDuration: 5500` -> `projectileDuration: 27500`
    No other changes to this file. BUFF_DURATIONS reads from POWERUP_CONFIG so it updates automatically.

    **2. Copy WAV asset:**
    Create `client/public/soundeffects/` directory and copy `assets/soundeffects/powerup_1.wav` into it.

    **3. WAV playback in AudioManager (client/src/systems/AudioManager.ts):**
    Add a WAV sound playback capability. Add a new `private wavSounds: Map<string, HTMLAudioElement> = new Map()` field. Add a method `registerWAV(key: string, src: string)` that creates an `HTMLAudioElement` with the given src and stores it in `wavSounds`. Add a method `playWAVSFX(key: string)` that plays the WAV by cloning the HTMLAudioElement (for overlapping playback): `const clone = wavSounds.get(key)!.cloneNode() as HTMLAudioElement; clone.volume = this.sfxVolume; clone.play().catch(() => {})`. The `playSFX` method should also check `wavSounds` as fallback if `sounds` (jsfxr) does not have the key -- this way callers can use `playSFX` uniformly. In the `playSFX` method, after the existing `if (!audio)` block, add: check wavSounds for the key and call playWAVSFX if found, then return. This avoids needing to change any call sites.

    **4. Preload WAV in BootScene (client/src/scenes/BootScene.ts):**
    In the `create()` method, after `audioManager.init()`, call `audioManager.registerWAV('powerup_pickup', 'soundeffects/powerup_1.wav')`. This overrides the jsfxr version because `playSFX` will find it in wavSounds first (due to the fallback logic added above). The Vite dev server serves files from client/public/ at the root, so 'soundeffects/powerup_1.wav' is the correct path.

    **5. Enhanced aura particles (client/src/systems/ParticleFactory.ts):**

    Update `speedAura()`:
    - `frequency: 50` -> `frequency: 25` (emit more often)
    - `lifespan: 400` -> `lifespan: 600`
    - `speed: { min: 20, max: 60 }` -> `speed: { min: 30, max: 80 }`
    - `scale: { start: 0.6, end: 0 }` -> `scale: { start: 1.0, end: 0 }`
    - `alpha: { start: 0.5, end: 0 }` -> `alpha: { start: 0.8, end: 0 }`

    Update `invincibilityAura()`:
    - `frequency: 40` -> `frequency: 20`
    - `lifespan: 500` -> `lifespan: 700`
    - `speed: { min: 30, max: 50 }` -> `speed: { min: 30, max: 60 }`
    - `scale: { start: 0.8, end: 0 }` -> `scale: { start: 1.2, end: 0 }`
    - `alpha: { start: 0.6, end: 0 }` -> `alpha: { start: 0.8, end: 0 }`

    Update `projectileAura()`:
    - `frequency: 60` -> `frequency: 20`
    - `lifespan: 350` -> `lifespan: 600`
    - `speed: { min: 15, max: 45 }` -> `speed: { min: 25, max: 60 }`
    - `scale: { start: 0.5, end: 0 }` -> `scale: { start: 1.0, end: 0 }`
    - `alpha: { start: 0.6, end: 0 }` -> `alpha: { start: 0.8, end: 0 }`

    **6. New idle aura method (client/src/systems/ParticleFactory.ts):**
    Add a `createPowerupIdleAura(followTarget: Phaser.GameObjects.Sprite, tint: number)` method that creates a gentle radial particle emitter following the ground powerup sprite. Settings:
    - frequency: 80
    - lifespan: 800
    - speed: { min: 5, max: 20 }
    - scale: { start: 0.8, end: 0 }
    - alpha: { start: 0.5, end: 0 }
    - tint: the provided color tint
    - angle: { min: 0, max: 360 }
    - follow: followTarget
    - emitting: true
    - depth: 7 (below the powerup sprite at 8)
    Track in activeTrails so it gets cleaned up by destroy(). Return the emitter.
  </action>
  <verify>
    Verify shared/powerups.ts has the 5x duration values:
    `grep "speedDuration: 22500" shared/powerups.ts`
    `grep "invincibilityDuration: 12500" shared/powerups.ts`
    `grep "projectileDuration: 27500" shared/powerups.ts`

    Verify WAV file exists:
    `ls client/public/soundeffects/powerup_1.wav`

    Verify AudioManager has registerWAV and WAV fallback in playSFX:
    `grep "registerWAV\|wavSounds\|playWAVSFX" client/src/systems/AudioManager.ts`

    Verify BootScene registers WAV:
    `grep "registerWAV.*powerup_pickup" client/src/scenes/BootScene.ts`

    Verify ParticleFactory auras are enhanced (frequency 20-25 range, alpha 0.8):
    `grep "frequency: 2[0-5]" client/src/systems/ParticleFactory.ts`
    `grep "createPowerupIdleAura" client/src/systems/ParticleFactory.ts`

    Verify no TypeScript errors:
    `cd client && npx tsc --noEmit`
    `cd server && npx tsc --noEmit`
  </verify>
  <done>
    All buff durations are 5x: speed 22500ms, invincibility 12500ms, projectile 27500ms. WAV file copied and registered in AudioManager. All three buff aura methods have increased frequency/alpha/scale/lifespan for clear visibility. New createPowerupIdleAura method exists for ground powerup particle effect. Both client and server compile without errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: GameScene powerup sprite size, idle aura tracking, and type coercion fix</name>
  <files>
    client/src/scenes/GameScene.ts
  </files>
  <action>
    **1. Powerup sprite size (32x32):**
    In the `powerups.onAdd` handler (around line 625): change `sprite.setDisplaySize(16, 16)` to `sprite.setDisplaySize(32, 32)`.
    In the reconnection `powerups.onAdd` handler (around line 1922): change `sprite.setDisplaySize(16, 16)` to `sprite.setDisplaySize(32, 32)`.

    **2. Idle aura emitter tracking:**
    Add a new class member: `private powerupIdleEmitters: Map<string, Phaser.GameObjects.Particles.ParticleEmitter> = new Map()`.
    Reset it in `create()` alongside the other powerup maps (around line 193-194): `this.powerupIdleEmitters = new Map()`.

    In the `powerups.onAdd` handler (primary, around line 621-641), AFTER creating the sprite and setting display size, add idle aura creation:
    ```
    // Idle particle aura around ground powerup for visibility
    if (this.particleFactory) {
      const idleTint = powerup.powerupType === PowerupType.SPEED ? 0x4488ff
        : powerup.powerupType === PowerupType.INVINCIBILITY ? 0xffcc00
        : 0xff4422;
      const idleEmitter = this.particleFactory.createPowerupIdleAura(sprite, idleTint);
      this.powerupIdleEmitters.set(key, idleEmitter);
    }
    ```

    In the `powerups.onRemove` handler (primary, around line 644-654), add idle emitter cleanup BEFORE the sprite destroy:
    ```
    const idleEmitter = this.powerupIdleEmitters.get(key);
    if (idleEmitter && this.particleFactory) {
      this.particleFactory.destroyTrail(idleEmitter);
      this.powerupIdleEmitters.delete(key);
    }
    ```

    Apply the SAME idle aura creation and cleanup in the reconnection onAdd/onRemove handlers (around lines 1919-1950).

    **3. Type coercion fix for guardian projectile aura:**
    In the `powerupCollect` message handler (primary, around line 690): change `this.startBuffAura(data.playerId, data.type, sprite)` to `this.startBuffAura(data.playerId, Number(data.type), sprite)`.
    In the reconnection `powerupCollect` handler (around line 1982): change `this.startBuffAura(data.playerId, data.type, sprite)` to `this.startBuffAura(data.playerId, Number(data.type), sprite)`.

    Also apply Number() cast in both `buffExpired` handlers:
    - Primary (around line 699): `this.stopBuffAura(data.playerId, Number(data.type))`
    - Reconnection (around line 1991): `this.stopBuffAura(data.playerId, Number(data.type))`

    **4. Stage cleanup for idle emitters:**
    In `cleanupStageVisuals()` (around line 2030-2034), AFTER the existing `powerupSprites` and `powerupTweens` cleanup, add:
    ```
    // Destroy powerup idle aura emitters
    this.powerupIdleEmitters.forEach((emitter) => {
      if (this.particleFactory) this.particleFactory.destroyTrail(emitter);
    });
    this.powerupIdleEmitters.clear();
    ```
    This must be BEFORE `this.clearAllBuffAuras()` and BEFORE `this.particleFactory.destroy()`.
  </action>
  <verify>
    Verify display size changes:
    `grep "setDisplaySize(32, 32)" client/src/scenes/GameScene.ts` (should find 2 occurrences)
    `grep "setDisplaySize(16, 16)" client/src/scenes/GameScene.ts` (should find 0 occurrences for powerups -- the only remaining 16,16 if any should be unrelated)

    Verify Number() casts:
    `grep "Number(data.type)" client/src/scenes/GameScene.ts` (should find 4 occurrences: 2 powerupCollect + 2 buffExpired)

    Verify idle emitter tracking:
    `grep "powerupIdleEmitters" client/src/scenes/GameScene.ts` (should find member declaration, create() reset, onAdd creation, onRemove cleanup, stage cleanup -- at least 8 occurrences)

    Verify no TypeScript errors:
    `cd client && npx tsc --noEmit`
  </verify>
  <done>
    Ground powerup sprites display at 32x32 (2x previous). Each ground powerup has a color-matched idle particle aura that is created on spawn and destroyed on collection/despawn/stage-transition. The Number() cast on data.type in both powerupCollect and buffExpired handlers (primary + reconnection paths) prevents the string/number switch-case mismatch that blocked guardian projectile aura rendering. Client compiles without errors.
  </done>
</task>

</tasks>

<verification>
1. Start server and client (`cd server && npm run dev`, `cd client && npm run dev`)
2. Create a match with 3 players
3. Wait for powerup spawns -- verify they appear at 32x32 size with visible idle particle aura around them
4. Walk over a powerup -- verify the WAV chime plays (not the old jsfxr sound)
5. After collection, verify the buff aura around the player is clearly visible (bright, frequent particles)
6. Time the buff duration -- speed boost should last ~22.5 seconds, invincibility ~12.5 seconds, projectile ~27.5 seconds
7. As a Guardian, collect a red powerup (Power Shot) -- verify the red particle aura appears around the Guardian
8. Verify stage transitions clean up all idle aura emitters with no errors
</verification>

<success_criteria>
- All 4 UAT gaps resolved: powerup sprite 32x32 with idle aura, WAV pickup SFX, visible buff auras, 5x durations, guardian projectile aura working
- No TypeScript compilation errors in client or server
- No orphaned emitters after powerup despawn or stage transition
</success_criteria>

<output>
After completion, create `.planning/phases/10-powerup-system/10-05-SUMMARY.md`
</output>
