---
phase: 11-minimap-music
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - client/src/scenes/HUDScene.ts
  - client/src/scenes/GameScene.ts
  - client/src/scenes/VictoryScene.ts
  - client/src/systems/AudioManager.ts
autonomous: true
requirements: [MMAP-01, AUD-01, AUD-02, AUD-03]
gap_closure: true

must_haves:
  truths:
    - "Kill feed label background adjusts to fit text width with no overflow"
    - "WAV SFX play correctly: one laser per shot (randomized), shoot SFX only on server-confirmed fire, hurt sounds randomized"
    - "Lobby music resumes after returning from victory screen"
  artifacts:
    - path: "client/src/scenes/HUDScene.ts"
      provides: "Dynamic-width kill feed background"
      contains: "displayWidth"
    - path: "client/src/scenes/GameScene.ts"
      provides: "Single-instance laser SFX per shot, server-confirmed only"
      contains: "stopAndPlayWAV"
    - path: "client/src/scenes/VictoryScene.ts"
      provides: "Delayed scene transition waiting for fade completion"
      contains: "fadeOutMusic.*onComplete\\|callback"
    - path: "client/src/systems/AudioManager.ts"
      provides: "stopAndPlayWAV method for exclusive SFX playback"
      contains: "stopAndPlayWAV"
  key_links:
    - from: "client/src/scenes/VictoryScene.ts"
      to: "client/src/systems/AudioManager.ts"
      via: "fadeOutMusic onComplete callback"
      pattern: "fadeOutMusic.*=>"
    - from: "client/src/scenes/GameScene.ts"
      to: "client/src/systems/AudioManager.ts"
      via: "stopAndPlayWAV for exclusive laser"
      pattern: "stopAndPlayWAV"
---

<objective>
Fix 3 UAT gaps from Phase 11 testing: (1) kill feed background overflow, (2) overlapping guardian laser SFX and shoot timing, (3) lobby music not restarting after victory screen.

Purpose: Close all remaining Phase 11 UAT issues so the phase passes acceptance testing.
Output: Patched HUDScene, GameScene, VictoryScene, and AudioManager with targeted fixes.
</objective>

<execution_context>
@/Users/jonasbrandvik/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jonasbrandvik/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-minimap-music/11-03-SUMMARY.md
@.planning/phases/11-minimap-music/11-UAT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix kill feed background overflow and lobby music restart</name>
  <files>client/src/scenes/HUDScene.ts, client/src/scenes/VictoryScene.ts</files>
  <action>
  **HUDScene.ts — Kill feed background auto-sizing (UAT test 1):**

  In `addKillFeedEntry()` (around line 522-523), the background rectangle is hardcoded to 180px width:
  ```ts
  const bg = this.add.rectangle(killFeedX, baseY, 180, 22, 0x000000, 0.5);
  ```

  Fix: Create the text FIRST, then measure its `displayWidth` to size the background. Move the text creation (lines 528-536) ABOVE the background creation. Then set the background width to `text.displayWidth + 16` (8px padding on each side). Keep the bg origin at (1, 0.5) and the text origin at (1, 0.5). The bg x stays at `killFeedX` and text x stays at `killFeedX - 8`.

  The corrected order should be:
  1. Create text at `killFeedX - 8` with origin (1, 0.5), depth 201
  2. Create bg at `killFeedX` with width `text.displayWidth + 16`, height 22, origin (1, 0.5), depth 200
  3. Continue with the rest unchanged

  Also update the `pushExistingEntries` loop — the bg.y and text.y push-down code is fine as-is since it only adjusts y position.

  **VictoryScene.ts — Lobby music restart (UAT test 11):**

  In the return-to-lobby button handler (around line 296-303), `fadeOutMusic(500)` is called and then `returnToLobby(room)` is called immediately. The LobbyScene.create() runs while the music is still fading, `isPlayingMusic()` returns true, so lobby music startup is skipped.

  Fix: Move `this.returnToLobby(room)` into the `fadeOutMusic` onComplete callback. Change:
  ```ts
  button.on('pointerdown', () => {
    if (audioManager) {
      audioManager.playWAVSFX('select_1');
      audioManager.fadeOutMusic(500);
    }
    this.returnToLobby(room);
  });
  ```
  To:
  ```ts
  button.on('pointerdown', () => {
    if (audioManager) {
      audioManager.playWAVSFX('select_1');
      audioManager.fadeOutMusic(500, () => {
        this.returnToLobby(room);
      });
    } else {
      this.returnToLobby(room);
    }
  });
  ```

  This ensures `currentMusic` is nulled BEFORE LobbyScene.create() runs, so `isPlayingMusic()` returns false and lobby music starts correctly.
  </action>
  <verify>
  1. TypeScript compiles: `cd /Users/jonasbrandvik/Projects/banger-game/client && npx tsc --noEmit`
  2. Verify kill feed bg uses `displayWidth`: grep for `displayWidth` in addKillFeedEntry
  3. Verify VictoryScene uses fadeOutMusic callback: grep for `fadeOutMusic.*=>` in VictoryScene.ts
  </verify>
  <done>Kill feed background dynamically sized to text content. Lobby music restarts after returning from victory screen because scene transition waits for fade completion.</done>
</task>

<task type="auto">
  <name>Task 2: Fix overlapping guardian laser SFX</name>
  <files>client/src/systems/AudioManager.ts, client/src/scenes/GameScene.ts</files>
  <action>
  **AudioManager.ts — Add exclusive WAV playback method:**

  Add a new method `stopAndPlayWAV(key: string)` that stops any previous instance of the same key before playing a new one. Unlike `playWAVSFX` which clones for overlap support, this method reuses the registered Audio element directly:

  ```ts
  /**
   * Play a WAV SFX, stopping any previous playback of the same key first.
   * Use for sounds that should NOT overlap (e.g., rapid-fire laser).
   */
  stopAndPlayWAV(key: string): void {
    const source = this.wavSounds.get(key);
    if (!source) return;
    source.currentTime = 0;
    source.volume = this.sfxVolume;
    source.play().catch(() => {});
  }
  ```

  Also add `stopAndPlayRandomWAV(keys: string[])` that picks a random key and calls `stopAndPlayWAV`:

  ```ts
  /**
   * Play a random WAV from a set, stopping any previous playback of that key.
   * Use for rapid-fire sounds that should not overlap.
   */
  stopAndPlayRandomWAV(keys: string[]): void {
    if (keys.length === 0) return;
    const key = keys[Math.floor(Math.random() * keys.length)];
    this.stopAndPlayWAV(key);
  }
  ```

  **GameScene.ts — Remove shoot SFX from input handler, move to server-confirmed createProjectileSprite:**

  The user reports: (a) multiple lasers playing simultaneously, (b) Paran power shot plays SFX during cooldown, (c) shoot sound desynced from cooldown. The root cause is that the input handler plays SFX optimistically based on client-side cooldown, which can drift from the server. Moving SFX to server-confirmed projectile creation fixes all three issues.

  Step 1: In the input handler (around line 921-937), REMOVE the entire shoot SFX block. Keep the `lastLocalFireTime` tracking and `localFired` event emission because the HUD cooldown bar needs them. Only remove the audioManager calls (lines 927-934). The block should become:

  ```ts
  if (input.fire && this.localRole) {
    const cooldownMs = CHARACTERS[this.localRole]?.fireRate || 200;
    const now = Date.now();
    if (now - this.lastLocalFireTime >= cooldownMs) {
      this.lastLocalFireTime = now;
      this.events.emit('localFired', { fireTime: now, cooldownMs });
    }
  }
  ```

  Step 2: In `createProjectileSprite()` (around line 1248-1260), REMOVE the `projectile.ownerId !== this.room.sessionId` guard so SFX plays for ALL projectiles (local AND remote). Use `stopAndPlayRandomWAV` for laser sounds to prevent overlap. The SFX block should become:

  ```ts
  // Play shoot sound for all projectiles (server-confirmed)
  if (this.audioManager && this.room) {
    const ownerPlayer = this.room.state.players.get(projectile.ownerId);
    if (ownerPlayer && ownerPlayer.role) {
      if (projectile.isBeam) {
        this.audioManager.playMultipleWAV(['earthquake', 'lightning']);
      } else if (ownerPlayer.role !== 'paran') {
        this.audioManager.stopAndPlayRandomWAV(['laser_1', 'laser_4', 'laser_5']);
      } else {
        this.audioManager.playSFX('paran_shoot');
      }
    }
  }
  ```

  Key changes:
  - Removed `projectile.ownerId !== this.room.sessionId` guard — now plays for local player too (server-confirmed timing)
  - Changed `playRandomWAV` to `stopAndPlayRandomWAV` for laser — prevents overlapping laser sounds
  - Beam and Paran normal shoot are fine with overlapping playback (beam is rare, paran_shoot is jsfxr)

  Step 3: Similarly update the reconnection projectile listener (around line 1966-1970) — it already calls `createProjectileSprite` so no change needed there.
  </action>
  <verify>
  1. TypeScript compiles: `cd /Users/jonasbrandvik/Projects/banger-game/client && npx tsc --noEmit`
  2. Verify no shoot SFX in input handler: grep for `playRandomWAV\|playMultipleWAV\|playSFX.*paran_shoot` near `lastLocalFireTime` — should find 0 matches
  3. Verify stopAndPlayRandomWAV used in createProjectileSprite: grep for `stopAndPlayRandomWAV` in GameScene.ts
  4. Verify stopAndPlayWAV method exists: grep for `stopAndPlayWAV` in AudioManager.ts
  </verify>
  <done>Guardian laser SFX plays one sound at a time (previous stopped before new plays). All shoot SFX triggered only on server-confirmed projectile creation, eliminating desync with cooldown. Hurt sounds already randomized via playRandomWAV with 4 distinct WAV files (hurt_1 through hurt_4).</done>
</task>

</tasks>

<verification>
1. `cd /Users/jonasbrandvik/Projects/banger-game/client && npx tsc --noEmit` — TypeScript compiles without errors
2. Kill feed background uses dynamic width based on text.displayWidth
3. VictoryScene delays returnToLobby until fadeOutMusic completes via callback
4. GameScene input handler has NO shoot SFX calls
5. GameScene createProjectileSprite plays SFX for ALL projectiles (local + remote)
6. AudioManager has stopAndPlayWAV and stopAndPlayRandomWAV methods
</verification>

<success_criteria>
- Kill feed text never overflows its background rectangle
- Only one laser sound plays at a time for guardians (no simultaneous overlap)
- Shoot SFX synchronized with actual projectile creation (server-confirmed)
- Lobby music starts playing after returning from victory screen
</success_criteria>

<output>
After completion, create `.planning/phases/11-minimap-music/11-04-SUMMARY.md`
</output>
