---
phase: 08-arena-overhaul
plan: 02
type: execute
wave: 2
depends_on: ["08-01"]
files_modified:
  - shared/obstacles.ts
  - shared/maps.ts
  - client/src/scenes/GameScene.ts
  - client/src/scenes/BootScene.ts
autonomous: true

must_haves:
  truths:
    - "Arenas render using composite tileset art with no tile bleeding or visual seams"
    - "Camera scrolls to reveal the full 1600x1216 playspace"
    - "Players spawn at map-defined locations (Paran center, Guardians in opposite quadrants)"
    - "Collision works correctly with new tile IDs (walls block movement, obstacles are destructible)"
    - "Overview animation shows the full larger arena before zooming to player"
  artifacts:
    - path: "shared/obstacles.ts"
      provides: "Updated tile ID constants (WALL=5, HEAVY=6, MEDIUM=7, LIGHT=8)"
      contains: "WALL: 5"
    - path: "shared/maps.ts"
      provides: "New map entries with 1600x1216 dimensions and spawn points"
      contains: "hedge_garden"
    - path: "client/src/scenes/GameScene.ts"
      provides: "Updated MAP_TILESET_INFO and dynamic overview zoom"
      contains: "arena_hedge"
  key_links:
    - from: "shared/obstacles.ts"
      to: "shared/collisionGrid.ts"
      via: "OBSTACLE_TILE_IDS sets used in CollisionGrid constructor"
      pattern: "OBSTACLE_TILE_IDS"
    - from: "shared/maps.ts"
      to: "server/src/rooms/GameRoom.ts"
      via: "MAPS array for map selection and spawn points"
      pattern: "MAPS\\[.*\\]"
    - from: "client/src/scenes/GameScene.ts"
      to: "client/public/tilesets/arena_*.png"
      via: "MAP_TILESET_INFO image paths loaded dynamically"
      pattern: "MAP_TILESET_INFO"
    - from: "client/src/scenes/GameScene.ts"
      to: "shared/maps.ts"
      via: "mapMetadata dimensions for camera bounds and overview zoom"
      pattern: "mapMetadata\\.width"
---

<objective>
Integrate the new composite tilesets and larger maps into the game pipeline.

Purpose: Wire the new assets from Plan 01 into the server and client so the game actually loads and plays on the new 50x38 arenas. This involves updating tile ID constants, map metadata, tileset loading paths, and the overview camera zoom calculation for the larger arena size. Also removes old maps/tilesets that are now replaced.

Output: Updated shared/obstacles.ts, shared/maps.ts, GameScene.ts (MAP_TILESET_INFO + overview zoom), cleaned up old assets
</objective>

<execution_context>
@/Users/jonasbrandvik/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jonasbrandvik/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-arena-overhaul/08-RESEARCH.md
@.planning/phases/08-arena-overhaul/08-01-SUMMARY.md
@shared/obstacles.ts (update tile IDs from 3-6 to 5-8)
@shared/maps.ts (replace 4 old entries with 3 new entries)
@client/src/scenes/GameScene.ts (MAP_TILESET_INFO + startMatchOverview zoom)
@server/src/rooms/GameRoom.ts (verify map loading path still works)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update shared tile IDs and map metadata</name>
  <files>
    shared/obstacles.ts
    shared/maps.ts
  </files>
  <action>
**shared/obstacles.ts:**

Update tile ID constants to match the new composite tileset layout where walls/obstacles are in Row 1 (tile positions 5-8 with firstgid=1):

```typescript
export const OBSTACLE_TILES = {
  WALL: 5,    // Indestructible wall (was 3)
  HEAVY: 6,   // Heavy destructible obstacle, 5 HP (was 4)
  MEDIUM: 7,  // Medium destructible obstacle, 3 HP (was 5)
  LIGHT: 8,   // Light destructible obstacle, 2 HP (was 6)
} as const;
```

The OBSTACLE_TIER_HP and OBSTACLE_TILE_IDS sets derive from these constants, so they update automatically.

**shared/maps.ts:**

Replace the 4 old map entries (test_arena, corridor_chaos, cross_fire, pillars) with 3 new entries:

```typescript
export const MAPS: MapMetadata[] = [
  {
    name: "hedge_garden",
    displayName: "Hedge Garden",
    file: "maps/hedge_garden.json",
    tileset: "arena_hedge",
    width: 1600,   // 50 * 32
    height: 1216,  // 38 * 32
    spawnPoints: {
      paran: { x: 800, y: 608 },
      guardians: [{ x: 200, y: 200 }, { x: 1400, y: 1016 }]
    }
  },
  {
    name: "brick_fortress",
    displayName: "Brick Fortress",
    file: "maps/brick_fortress.json",
    tileset: "arena_brick",
    width: 1600,
    height: 1216,
    spawnPoints: {
      paran: { x: 800, y: 608 },
      guardians: [{ x: 200, y: 200 }, { x: 1400, y: 1016 }]
    }
  },
  {
    name: "timber_yard",
    displayName: "Timber Yard",
    file: "maps/timber_yard.json",
    tileset: "arena_wood",
    width: 1600,
    height: 1216,
    spawnPoints: {
      paran: { x: 800, y: 608 },
      guardians: [{ x: 200, y: 200 }, { x: 1400, y: 1016 }]
    }
  }
];
```

**IMPORTANT:** The exact spawn point pixel values should be read from the 08-01-SUMMARY.md to match whatever the generator actually produced. If the summary lists specific spawn coordinates, use those. The values above are defaults.

Also update the `MapMetadata` interface comment to note the new dimensions.
  </action>
  <verify>
    Run: `cd server && npx tsc --noEmit` -- must compile without errors (shared code imported by server)
    Grep for old tile IDs: `grep -rn 'WALL: 3\|HEAVY: 4\|MEDIUM: 5\|LIGHT: 6' shared/` -- should return nothing
    Grep for old map names: `grep -rn 'test_arena\|corridor_chaos\|cross_fire\|pillars' shared/` -- should return nothing
  </verify>
  <done>
    - obstacles.ts has WALL=5, HEAVY=6, MEDIUM=7, LIGHT=8
    - maps.ts has 3 entries (hedge_garden, brick_fortress, timber_yard) with 1600x1216 dimensions
    - Server TypeScript compiles cleanly
    - No references to old tile IDs or old map names remain in shared/
  </done>
</task>

<task type="auto">
  <name>Task 2: Update GameScene tileset loading, overview zoom, and remove old assets</name>
  <files>
    client/src/scenes/GameScene.ts
    client/src/scenes/BootScene.ts
  </files>
  <action>
**client/src/scenes/GameScene.ts:**

1. Replace `MAP_TILESET_INFO` entries with new composite tileset mappings:
```typescript
const MAP_TILESET_INFO: Record<string, { key: string; image: string; name: string }> = {
  hedge_garden:    { key: 'tileset_hedge', image: 'tilesets/arena_hedge.png', name: 'arena_hedge' },
  brick_fortress:  { key: 'tileset_brick', image: 'tilesets/arena_brick.png', name: 'arena_brick' },
  timber_yard:     { key: 'tileset_wood',  image: 'tilesets/arena_wood.png',  name: 'arena_wood' },
};
```

2. Update `startMatchOverview()` to calculate dynamic overview zoom for the larger arenas. The current code uses `cam.setZoom(1.0)` which was fine for 800x608 arenas fitting in 1280x720 viewport. For 1600x1216, zoom=1.0 won't show the full arena. Replace with:
```typescript
// Show full arena at overview zoom (dynamically calculated)
cam.stopFollow();
const overviewZoom = Math.min(
  cam.width / this.mapMetadata.width,
  cam.height / this.mapMetadata.height
);
cam.setZoom(overviewZoom);
cam.centerOn(this.mapMetadata.width / 2, this.mapMetadata.height / 2);
```
This calculates `Math.min(1280/1600, 720/1216) = Math.min(0.8, 0.59) = 0.59` for the new arenas.

3. Also update the fallback references: change `MAP_TILESET_INFO.test_arena` fallback to `MAP_TILESET_INFO.hedge_garden` (or use `Object.values(MAP_TILESET_INFO)[0]` as a generic fallback).

**client/src/scenes/BootScene.ts:**

Check if BootScene preloads any tileset images. Based on codebase search, it does NOT (tilesets are loaded dynamically in GameScene). No changes needed to BootScene unless tileset preloading exists.

**Remove old assets:**

Delete old map JSONs and old tileset PNGs that are no longer referenced:
- `client/public/maps/test_arena.json`
- `client/public/maps/corridor_chaos.json`
- `client/public/maps/cross_fire.json`
- `client/public/maps/pillars.json`
- `client/public/tilesets/solarpunk_ruins.png`
- `client/public/tilesets/solarpunk_living.png`
- `client/public/tilesets/solarpunk_tech.png`
- `client/public/tilesets/solarpunk_mixed.png`

Use `rm` for each file. Keep `client/public/tilesets/placeholder.png` if it exists (may be referenced elsewhere).

**Verify no stale references remain:**

Grep the entire client/src/ and server/src/ directories for old map names (test_arena, corridor_chaos, cross_fire, pillars) and old tileset names (solarpunk_ruins, solarpunk_living, solarpunk_tech, solarpunk_mixed). Fix any remaining references.
  </action>
  <verify>
    Run: `cd server && npx tsc --noEmit` -- server compiles
    Run: `cd client && npx tsc --noEmit` -- client compiles (or use `npx vue-tsc --noEmit` depending on config)
    Grep for old references: `grep -rn 'test_arena\|corridor_chaos\|cross_fire\|pillars\|solarpunk_ruins\|solarpunk_living\|solarpunk_tech\|solarpunk_mixed' client/src/ server/src/` -- should return nothing
    Verify old files deleted: `ls client/public/maps/test_arena.json client/public/tilesets/solarpunk_ruins.png 2>&1` -- should say "No such file"
    Verify new tileset info: `grep -n 'hedge_garden\|brick_fortress\|timber_yard' client/src/scenes/GameScene.ts` -- should show entries
    Verify overview zoom: `grep -n 'overviewZoom\|Math.min' client/src/scenes/GameScene.ts` -- should show dynamic calculation
  </verify>
  <done>
    - MAP_TILESET_INFO has 3 entries pointing to arena_hedge/brick/wood composite tilesets
    - startMatchOverview uses dynamic zoom calculation (Math.min of canvas/arena ratios)
    - Old map JSONs and old tileset PNGs are deleted
    - No stale references to old maps/tilesets remain in source code
    - Both server and client compile cleanly
  </done>
</task>

</tasks>

<verification>
1. Start server (`cd server && npm run dev`) -- should load new map JSON without ENOENT errors
2. Start client (`cd client && npm run dev`) -- should load without console errors
3. Server logs should show "GameRoom created with map: Hedge Garden" (or Brick/Timber)
4. Client should render tiles from composite tilesets (not blank/broken)
5. Camera should scroll to reveal full 1600x1216 arena
6. Overview animation should show entire arena at zoom ~0.59 before zooming to player at zoom=2
7. Players should spawn at map-defined positions
8. Collision should work: walls block movement, Paran loses velocity on wall hit
9. Destructible obstacles should take damage and be destroyed
</verification>

<success_criteria>
- Game loads and plays on any of the 3 new arenas without errors
- Tile IDs correctly classify walls (5), heavy (6), medium (7), light (8) for collision
- Camera bounds match 1600x1216 arena dimensions
- Overview animation dynamically calculates zoom to show full arena
- All old maps and tilesets removed with no stale references
</success_criteria>

<output>
After completion, create `.planning/phases/08-arena-overhaul/08-02-SUMMARY.md`
</output>
