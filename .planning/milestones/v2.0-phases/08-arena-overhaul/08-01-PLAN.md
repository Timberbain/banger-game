---
phase: 08-arena-overhaul
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - scripts/generate-arenas.py
  - client/public/tilesets/arena_hedge.png
  - client/public/tilesets/arena_brick.png
  - client/public/tilesets/arena_wood.png
  - client/public/maps/hedge_garden.json
  - client/public/maps/brick_fortress.json
  - client/public/maps/timber_yard.json
autonomous: true

must_haves:
  truths:
    - "Three composite tileset PNGs exist at 128x96 (4 cols x 3 rows of 32x32 tiles)"
    - "Three map JSON files exist at 50x38 tiles with Ground and Walls layers"
    - "Map JSONs include tileMapping property documenting tile ID semantics"
    - "Each map has distinct obstacle layout (not copy-paste reskins)"
    - "Map JSONs use firstgid=1 convention (0=empty, 1-4=ground, 5=wall, 6-8=obstacles, 9-12=deco)"
  artifacts:
    - path: "scripts/generate-arenas.py"
      provides: "Arena asset + map generation pipeline"
    - path: "client/public/tilesets/arena_hedge.png"
      provides: "Hedge theme composite tileset"
    - path: "client/public/tilesets/arena_brick.png"
      provides: "Brick theme composite tileset"
    - path: "client/public/tilesets/arena_wood.png"
      provides: "Wood theme composite tileset"
    - path: "client/public/maps/hedge_garden.json"
      provides: "50x38 hedge-themed arena map"
    - path: "client/public/maps/brick_fortress.json"
      provides: "50x38 brick-themed arena map"
    - path: "client/public/maps/timber_yard.json"
      provides: "50x38 wood-themed arena map"
  key_links:
    - from: "scripts/generate-arenas.py"
      to: "assets/tilesets/*.png"
      via: "PIL image loading and tile extraction"
      pattern: "Image\\.open.*assets/tilesets"
    - from: "client/public/maps/*.json"
      to: "client/public/tilesets/arena_*.png"
      via: "tileset image reference in JSON"
      pattern: "arena_(hedge|brick|wood)\\.png"
---

<objective>
Generate composite tileset PNGs and arena map JSONs for 3 themed arenas.

Purpose: Create the foundational art and map data that the arena overhaul needs. Each arena theme (hedge, brick, wood) gets a single composite tileset PNG combining ground tiles + wall/obstacle tiles + decoration tiles, and a 50x38 map JSON with distinct layout, spawn points, and a tileMapping property for human readability.

Output: Python script (generate-arenas.py), 3 composite tileset PNGs (128x96), 3 map JSONs (50x38 tiles = 1600x1216px)
</objective>

<execution_context>
@/Users/jonasbrandvik/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jonasbrandvik/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-arena-overhaul/08-RESEARCH.md
@scripts/generate-assets.py (existing asset pipeline -- follow style/patterns)
@shared/obstacles.ts (tile ID constants -- new tilesets use IDs 5-8 for wall/obstacles)
@assets/tilesets/ (source tileset PNGs to extract tiles from)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create generate-arenas.py script that produces composite tilesets and map JSONs</name>
  <files>
    scripts/generate-arenas.py
    client/public/tilesets/arena_hedge.png
    client/public/tilesets/arena_brick.png
    client/public/tilesets/arena_wood.png
    client/public/maps/hedge_garden.json
    client/public/maps/brick_fortress.json
    client/public/maps/timber_yard.json
  </files>
  <action>
Create `scripts/generate-arenas.py` following the style of the existing `scripts/generate-assets.py` (PIL-based, same directory resolution pattern).

**Part A -- Composite Tileset Generation:**

For each of the 3 themes (hedge, brick, wood), create a 128x96 PNG (4 cols x 3 rows = 12 tiles at 32x32):
- Row 0 (IDs 1-4): 4 ground tile variants. Cherry-pick from `assets/tilesets/32x32 topdown tileset Spreadsheet V1-1.png` (1344x384, 42 cols x 12 rows). Select tiles that match the theme:
  - Hedge: grass/earth tones (e.g., row 0 cols 0-3 are various grass)
  - Brick: stone/cobblestone tones (e.g., row 3-4 have stone variants)
  - Wood: dirt/wood-floor tones (e.g., row 1-2 have earth/sand)
- Row 1 (IDs 5-8): wall + 3 obstacle tiers. Extract from the themed tileset:
  - `assets/tilesets/hedge_tileset.png` (128x192, 4x6 grid): Select 1 solid wall tile + 3 obstacle variants at different visual densities
  - `assets/tilesets/brick_tileset.png` (128x192, 4x6 grid): Same pattern
  - `assets/tilesets/wood_tileset.png` (128x192, 4x6 grid): Same pattern
- Row 2 (IDs 9-12): 4 decoration variants (non-solid visual interest). Extract from the themed tilesets -- pick visually distinct decorative tiles (floor details, grass tufts, cracks, etc.)

Tile extraction: Use `Image.crop((col*32, row*32, (col+1)*32, (row+1)*32))` to extract individual tiles from source spritesheets and paste into the composite.

Save to: `client/public/tilesets/arena_hedge.png`, `arena_brick.png`, `arena_wood.png`

**Part B -- Map JSON Generation:**

For each theme, generate a 50x38 Tiled-compatible JSON with:
1. `width: 50, height: 38, tilewidth: 32, tileheight: 32`
2. `properties` array with `tileMapping` string: `"1-4=ground, 5=wall, 6=heavy_obstacle, 7=medium_obstacle, 8=light_obstacle, 9-12=decoration"`
3. `tilesets` array with single entry: `firstgid: 1`, columns: 4, tilecount: 12, correct image path (e.g., `"../tilesets/arena_hedge.png"`)
4. Two layers:
   - `Ground` layer: 50x38 flat data array using IDs 1-4 with weighted random distribution (70% primary, 20% secondary, 10% tertiary/quaternary split)
   - `Walls` layer: 50x38 flat data array using 0 (empty), 5 (wall), 6 (heavy), 7 (medium), 8 (light)

**Walls layer layout rules (critical for gameplay):**
- Perimeter: solid walls (ID 5) on all 4 edges (row 0, row 37, col 0, col 49)
- Interior: each arena has a DISTINCT layout, not just reskins:
  - **Hedge Garden**: Open garden with scattered hedge clusters, 2 long corridors (horizontal, N-S), large central clearing, obstacle clusters in corners. Favors Paran speed runs through corridors.
  - **Brick Fortress**: Fortress layout with thick wall segments forming rooms/chambers, narrow doorways between areas, more walls than open space. Favors guardian positioning.
  - **Timber Yard**: Symmetric arena with wooden barriers in cross/X pattern, medium-width paths, balanced mix of open and closed areas. Balanced for both playstyles.
- Use destructible obstacles (IDs 6-8) to create strategic chokepoints. Light obstacles at corridor entrances, medium in clusters, heavy near spawn areas.
- Interior walls should NOT create sealed rooms -- every area must be reachable from every other area.

**Spawn points (embedded in map properties or used by maps.ts):**
Calculate spawn points based on layout:
- Paran: near arena center (approximately x:800, y:608 in pixels -- tile 25,19)
- Guardian 1: top-left quadrant (approximately x:200, y:200 -- tile 6,6)
- Guardian 2: bottom-right quadrant (approximately x:1400, y:1016 -- tile 43,31)
Adjust per map so spawns are never inside walls.

**Decoration layer approach:**
Instead of a separate layer, place decoration tile IDs (9-12) into the Ground layer data at ~5-10% of non-wall positions to add visual variety. This keeps the format simple (2 layers: Ground + Walls).

Save to: `client/public/maps/hedge_garden.json`, `brick_fortress.json`, `timber_yard.json`

Run the script: `cd /path/to/project && python3 scripts/generate-arenas.py`
  </action>
  <verify>
    Run: `python3 scripts/generate-arenas.py`
    Verify output files exist: `ls -la client/public/tilesets/arena_*.png client/public/maps/hedge_garden.json client/public/maps/brick_fortress.json client/public/maps/timber_yard.json`
    Check tileset dimensions: `python3 -c "from PIL import Image; [print(f, Image.open(f).size) for f in ['client/public/tilesets/arena_hedge.png','client/public/tilesets/arena_brick.png','client/public/tilesets/arena_wood.png']]"` -- should all be (128, 96)
    Check map JSON structure: `python3 -c "import json; d=json.load(open('client/public/maps/hedge_garden.json')); print(d['width'], d['height'], len(d['layers']), d['layers'][0]['name'], d['layers'][1]['name'])"` -- should print `50 38 2 Ground Walls`
    Verify perimeter walls: `python3 -c "import json; d=json.load(open('client/public/maps/hedge_garden.json')); walls=d['layers'][1]['data']; print('Top wall:', all(walls[i]==5 for i in range(50))); print('Bottom wall:', all(walls[50*37+i]==5 for i in range(50)))"` -- both True
  </verify>
  <done>
    - generate-arenas.py runs without errors and produces 6 output files (3 PNGs + 3 JSONs)
    - Each composite tileset is exactly 128x96 pixels (4x3 grid of 32x32 tiles)
    - Each map JSON is 50x38 tiles with Ground and Walls layers, tileMapping property, and correct tileset reference
    - Each map has distinct interior obstacle layout (not identical)
    - All map perimeters are solid walls (ID 5)
    - No sealed rooms in any map (all areas reachable)
  </done>
</task>

</tasks>

<verification>
1. All 6 output files exist and have correct dimensions/format
2. Composite tilesets contain visually distinct tiles from the source art (not blank/corrupt)
3. Map JSONs are valid Tiled-compatible format with firstgid=1 convention
4. Maps have perimeter walls and distinct interior layouts
5. Maps use IDs 5-8 for walls/obstacles (matching the new tile positions in composite tilesets)
</verification>

<success_criteria>
- generate-arenas.py produces 3 composite tilesets (128x96) and 3 map JSONs (50x38)
- Each map has a tileMapping property explaining tile IDs in human-readable form
- Each arena has a distinct layout (hedge=open corridors, brick=chambered fortress, wood=symmetric cross)
- All output files are saved to the correct directories under client/public/
</success_criteria>

<output>
After completion, create `.planning/phases/08-arena-overhaul/08-01-SUMMARY.md`
</output>
