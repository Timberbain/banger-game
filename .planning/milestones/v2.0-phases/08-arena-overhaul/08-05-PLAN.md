---
phase: 08-arena-overhaul
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - assets/tilesets/walls/tileset_reference.json
  - client/public/maps/hedge_garden.json
  - client/public/maps/brick_fortress.json
  - client/public/maps/timber_yard.json
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Rule 4 (top_edge_both_inners, spriteIndex=5) is reachable and selected when both SW and SE neighbors are present"
    - "Rule 1 (top_edge_se_inner, spriteIndex=2) only matches when SW is absent"
    - "Rule 5 (top_edge_sw_inner, spriteIndex=6) only matches when SE is absent"
    - "Bottom-edge tiles with NE:true, NW:false, SE:false never fall to default isolated sprite"
    - "All 3 regenerated maps use sprites 5 and 6 where appropriate instead of only sprite 2"
  artifacts:
    - path: "assets/tilesets/walls/tileset_reference.json"
      provides: "Disambiguated auto-tile rules with no subset shadowing"
      contains: "SW.*false"
    - path: "client/public/maps/hedge_garden.json"
      provides: "Regenerated map with correct tile IDs"
    - path: "client/public/maps/brick_fortress.json"
      provides: "Regenerated map with correct tile IDs"
    - path: "client/public/maps/timber_yard.json"
      provides: "Regenerated map with correct tile IDs"
  key_links:
    - from: "assets/tilesets/walls/tileset_reference.json"
      to: "scripts/generate-arenas.py"
      via: "autoTileRules array consumed by resolve_autotile()"
      pattern: "resolve_autotile.*rules"
    - from: "scripts/generate-arenas.py"
      to: "client/public/maps/*.json"
      via: "map generation output"
      pattern: "generate_map"
---

<objective>
Fix auto-tile rule shadowing bug in tileset_reference.json that causes ~235 wall tiles across 3 maps (~23%) to render with the wrong sprite variant, then regenerate all maps.

Purpose: Rule 1 (5 constraints, no SW mentioned) is a strict subset of Rule 4 (6 constraints, requires SW:true), causing first-match-wins to always select sprite 2 (SE-inner-only top edge with visible SW corner notch) instead of sprite 5 (both-inners smooth top edge). Similarly Rule 5 shadows Rule 4. A secondary gap: bottom-edge tiles with NE:true + NW:false + SE:false have no matching rule and fall to default.

Output: Fixed tileset_reference.json + 3 regenerated map JSONs with correct tile variant selection.
</objective>

<execution_context>
@/Users/jonasbrandvik/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jonasbrandvik/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/debug/autotile-wrong-variants.md
@assets/tilesets/walls/tileset_reference.json
@scripts/generate-arenas.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix auto-tile rule shadowing and missing bottom-edge rule</name>
  <files>assets/tilesets/walls/tileset_reference.json</files>
  <action>
Fix three issues in the `autoTileRules` array of tileset_reference.json:

1. **Rule 1 (ruleId=1, spriteIndex=2):** Add `"SW": false` to its neighbors object. This disambiguates it from Rule 4. Rule 1 currently has `{N:false, E:true, S:true, SE:true, W:true}` (5 constraints). After fix: `{N:false, E:true, S:true, SE:true, W:true, SW:false}` (6 constraints). This means Rule 1 now only matches the "SE inner filled, SW absent" case, which is its correct semantic meaning (top_edge_se_inner).

2. **Rule 5 (ruleId=5, spriteIndex=6):** Add `"SE": false` to its neighbors object. Rule 5 currently has `{N:false, E:true, S:true, SW:true, W:true}` (5 constraints). After fix: `{N:false, E:true, S:true, SW:true, W:true, SE:false}` (6 constraints). This means Rule 5 now only matches the "SW inner filled, SE absent" case, which is its correct semantic meaning (top_edge_sw_inner).

3. **Add missing bottom-edge rule for NE-only-inner without SE:** Add a new rule after the existing bottom-edge rules (after ruleId=44) with ruleId=46 (or append at end). This rule handles the case where S:false, N:true, E:true, W:true, NE:true, NW:false, SE:false. It should map to spriteIndex=42 (same as Rule 40, which is the NW-absent bottom edge variant -- visually correct for this case too since it's the closest match with NE present). The new rule:
```json
{
  "ruleId": 46,
  "spriteIndex": 42,
  "neighbors": {
    "N": true,
    "NE": true,
    "E": true,
    "W": true,
    "S": false,
    "NW": false,
    "SE": false
  },
  "description": "Bottom edge -- NE inner filled, NW and SE absent variant."
}
```

After making changes, verify with a Python script that:
- No rule in the autoTileRules array is a strict subset of any later rule (no shadowing)
- The new rule does not shadow or get shadowed by existing rules
  </action>
  <verify>
Run a Python verification script that loads the updated tileset_reference.json, checks all rule pairs for subset shadowing, and confirms zero shadowing pairs exist. Also verify Rule 4 (spriteIndex=5) is reachable by testing with a neighbor state of {N:false, E:true, S:true, SE:true, SW:true, W:true} and confirming it matches Rule 4 before Rule 1 or Rule 5.
  </verify>
  <done>
tileset_reference.json has no subset-shadowed rules. Rule 1 has SW:false, Rule 5 has SE:false, and a new bottom-edge rule covers the NE-only/NW-false/SE-false gap.
  </done>
</task>

<task type="auto">
  <name>Task 2: Regenerate all 3 maps and verify tile distribution improvement</name>
  <files>
    client/public/maps/hedge_garden.json
    client/public/maps/brick_fortress.json
    client/public/maps/timber_yard.json
  </files>
  <action>
Run `python3 scripts/generate-arenas.py` to regenerate all 3 map JSON files with the fixed auto-tile rules.

After regeneration, verify the fix by checking:
1. Sprite 5 (tile ID 6) and sprite 6 (tile ID 7) now appear in the Walls layer data where appropriate (previously both were 0 across all maps)
2. Sprite 2 (tile ID 3) count has decreased from the pre-fix counts (hedge=79, brick=85, timber=72) -- some of these should now be sprite 5 or 6 instead
3. No tiles use tile ID 1 (default/isolated sprite) except where genuinely isolated (should be 0-1 per map)
4. Total wall tile counts remain the same as before (hedge=465, brick=416, timber=390) -- we changed variant selection, not wall placement
5. The `spawnPoints` object still exists in each map's `properties` with valid coordinates

Print before/after comparison of sprite distribution for the top-edge family (sprites 2, 5, 6, 9) across all maps.
  </action>
  <verify>
Run `python3 -c` script that loads each regenerated map and prints:
- Count of tile ID 3 (sprite 2), ID 6 (sprite 5), ID 7 (sprite 6) in Walls layer
- Total wall tile count matches expected (465, 416, 390)
- No unexpected default tiles (ID 1 count <= 1)
- spawnPoints property exists

Confirm sprite 5 and 6 counts are non-zero in at least 2 of 3 maps.
  </verify>
  <done>
All 3 maps regenerated with correct auto-tile variant selection. Sprites 5 and 6 appear in map data. Sprite 2 count reduced. Total wall counts unchanged. Spawn points preserved.
  </done>
</task>

</tasks>

<verification>
1. No auto-tile rule in tileset_reference.json is a strict subset of any later rule
2. All 3 map JSONs load without errors and have correct layer structure (Ground, WallFronts, Walls)
3. Sprites 5 (both-inners top edge) and 6 (SW-only top edge) are used in generated maps
4. Game client can load and render maps: `cd client && npm run build` succeeds
</verification>

<success_criteria>
- tileset_reference.json rules are disambiguated (Rule 1 has SW:false, Rule 5 has SE:false, new bottom-edge rule added)
- All 3 maps regenerated with correct tile variant distribution
- ~235 previously-wrong tiles now use correct sprite variants
- Client build succeeds with regenerated maps
</success_criteria>

<output>
After completion, create `.planning/phases/08-arena-overhaul/08-05-SUMMARY.md`
</output>
