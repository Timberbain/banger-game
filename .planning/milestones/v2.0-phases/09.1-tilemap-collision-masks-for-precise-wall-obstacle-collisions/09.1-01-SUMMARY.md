---
phase: 09.1-tilemap-collision-masks
plan: 01
subsystem: collision
tags: [python, pil, collision, tileset, pipeline, json]

# Dependency graph
requires:
  - phase: 08-arena-overhaul
    provides: "Composite tilesets (256x448) and 3-layer Tiled map JSONs"
provides:
  - "Per-tileset collision rect JSON sidecar files (arena_hedge/brick/wood_collision.json)"
  - "Map JSONs with embedded collisionShapes in tilesets[0].properties"
  - "Manual override mechanism for future tile-specific corrections"
  - "Repeatable pipeline: generate-collision-masks.py then generate-arenas.py"
affects: [09.1-02-collision-grid, 09.1-03-server-client-integration]

# Tech tracking
tech-stack:
  added: []
  patterns: ["PIL alpha channel bounding box scan via getbbox()", "JSON sidecar files embedded into map metadata"]

key-files:
  created:
    - scripts/generate-collision-masks.py
    - client/public/tilesets/arena_hedge_collision.json
    - client/public/tilesets/arena_brick_collision.json
    - client/public/tilesets/arena_wood_collision.json
  modified:
    - scripts/generate-arenas.py
    - client/public/maps/hedge_garden.json
    - client/public/maps/brick_fortress.json
    - client/public/maps/timber_yard.json

key-decisions:
  - "Alpha channel isolation via split()[3] before getbbox() for accurate opaque pixel detection"
  - "Empty MANUAL_OVERRIDES dict ready for post-inspection corrections without pipeline changes"
  - "Post-generation embedding approach: generate-arenas.py reads sidecar JSONs after map generation rather than modifying generate_map_json signature"

patterns-established:
  - "Collision shape sidecar files: per-tileset JSON mapping string tile IDs to {x,y,w,h} rects"
  - "Map JSON extension: tilesets[0].properties.collisionShapes for runtime collision data"

requirements-completed: [COLL-MASK-01, COLL-MASK-02]

# Metrics
duration: 2min
completed: 2026-02-16
---

# Phase 09.1 Plan 01: Collision Shape Derivation Pipeline Summary

**PIL-based auto-derivation of per-tile collision rectangles from tileset PNGs, embedded into map JSONs via 2-script pipeline**

## Performance

- **Duration:** 2 min
- **Started:** 2026-02-16T20:20:53Z
- **Completed:** 2026-02-16T20:23:17Z
- **Tasks:** 2
- **Files modified:** 8

## Accomplishments
- Created generate-collision-masks.py that scans 3 composite tilesets and outputs per-tile collision bounding boxes
- Modified generate-arenas.py to embed collision shape data into map JSON tileset metadata
- All 3 map JSONs now contain 111 collision shapes each (110 tiles + _default fallback)
- Coverage stats: hedge 94.5% avg, brick/wood 90.4% avg -- confirms meaningful sub-tile rects exist

## Task Commits

Each task was committed atomically:

1. **Task 1: Create generate-collision-masks.py script** - `76a20b2` (feat)
2. **Task 2: Embed collision shapes in map JSONs via generate-arenas.py** - `e85d1c3` (feat)

## Files Created/Modified
- `scripts/generate-collision-masks.py` - New script: scans tileset PNGs, outputs collision rect JSON sidecars
- `client/public/tilesets/arena_hedge_collision.json` - 110 collision rects for hedge tileset (16 sub-rects)
- `client/public/tilesets/arena_brick_collision.json` - 110 collision rects for brick tileset (55 sub-rects)
- `client/public/tilesets/arena_wood_collision.json` - 110 collision rects for wood tileset (55 sub-rects)
- `scripts/generate-arenas.py` - Added collision shape embedding step after spawn validation
- `client/public/maps/hedge_garden.json` - Regenerated with collisionShapes in tileset properties
- `client/public/maps/brick_fortress.json` - Regenerated with collisionShapes in tileset properties
- `client/public/maps/timber_yard.json` - Regenerated with collisionShapes in tileset properties

## Decisions Made
- Used alpha channel isolation via `split()[3]` before `getbbox()` -- avoids false positives from non-zero color channels in transparent pixels
- Empty MANUAL_OVERRIDES dict in script -- ready for tile-specific corrections after visual inspection without changing the pipeline
- Post-generation embedding approach in generate-arenas.py -- reads map JSONs back after creation to inject collision data, keeping the core `generate_map_json()` function signature unchanged

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
None.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Collision shape data is ready for consumption by Plan 02 (CollisionGrid enhancement with sub-rect support)
- Both server and client load map JSONs that now contain `tilesets[0].properties.collisionShapes`
- Pipeline is fully repeatable: running both scripts in sequence produces identical output

## Self-Check: PASSED

All created files verified on disk, all commit hashes found in git log.

---
*Phase: 09.1-tilemap-collision-masks*
*Completed: 2026-02-16*
