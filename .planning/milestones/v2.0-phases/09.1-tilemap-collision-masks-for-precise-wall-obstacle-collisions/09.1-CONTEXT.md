# Phase 09.1: Tilemap Collision Masks for Precise Wall/Obstacle Collisions - Context

**Gathered:** 2026-02-16
**Status:** Ready for planning

<domain>
## Phase Boundary

Replace full-tile AABB collision with sub-tile rectangle collision shapes so players and projectiles collide with the visual edges of walls and obstacles, not invisible tile boundaries. The existing CollisionGrid in shared/collisionGrid.ts is the integration point. Arena layouts remain unchanged — only collision boundaries tighten to match art.

</domain>

<decisions>
## Implementation Decisions

### Collision Shape Approach
- Sub-tile rectangles: each tile type defines a single inner bounding rectangle within the 32x32 tile
- Collision rects auto-derived from tileset PNG art (tightest bounding box around non-transparent pixels)
- Manual override mechanism for specific tile types where auto-derivation produces poor results
- Collision shape data stored in map JSON metadata (not shared/ constants) — loaded at runtime by both server and client
- Uniform code path: even tiles whose auto-derived rect equals full tile use the sub-rect system (no fast-path optimization)

### Gameplay Feel Changes
- Paran wall penalty unchanged: lose ALL velocity on any wall hit, but trigger is now tighter (only actual art contact)
- Projectiles also use precise collision shapes — shots can pass through visual gaps, consistent with player collision
- Player collision radii remain unchanged — only wall/obstacle boundaries tighten
- No arena layout adjustments — visual gaps from precise collision are the intended play space

### Which Elements Get Masks
- All solid tiles get collision masks: walls, destructible obstacles (all tiers), and arena border tiles
- Only currently-solid tiles — ground and decoration tiles remain fully passable
- No new semi-solid tile types introduced

### Visual-to-Collision Gap
- Collision rect = exact opaque pixel bounding box (no padding in or out)
- Separate script for collision shape generation (not integrated into generate-arenas.py)
- Toggle-able debug visualization (e.g., F3 key) overlays collision rectangles on tiles during development

### Claude's Discretion
- Internal data format for collision shape metadata in map JSON
- How to handle the sub-rect AABB resolution algorithm changes in shared/collisionGrid.ts
- Debug visualization rendering approach (Phaser graphics overlay)
- Specific tile types that need manual overrides (determined after auto-derivation)

</decisions>

<specifics>
## Specific Ideas

- Auto-derive collision rects by scanning tileset PNGs for non-transparent pixel bounding boxes
- Allow manual overrides where auto-derivation fails (e.g., decorative pixels extending the box)
- Pipeline: separate Python script reads tilesets, generates collision data, embeds in map JSON
- Dev debug view: F3 toggles collision rect outlines on all tiles for visual verification

</specifics>

<deferred>
## Deferred Ideas

None — discussion stayed within phase scope

</deferred>

---

*Phase: 09.1-tilemap-collision-masks-for-precise-wall-obstacle-collisions*
*Context gathered: 2026-02-16*
