---
phase: 09.1-tilemap-collision-masks
plan: 02
subsystem: physics
tags: [collision, aabb, sub-rect, shared-code, backward-compatible]

# Dependency graph
requires:
  - phase: 05.1
    provides: "CollisionGrid AABB-vs-tile collision resolution"
provides:
  - "CollisionRect interface for per-tile sub-rectangle collision shapes"
  - "Sub-rect narrow-phase AABB checks in resolveCollisions (both axes)"
  - "isPointInSolidRect method for projectile point-in-subrect precision"
  - "Optional collisionShapes constructor parameter (backward compatible)"
affects: [09.1-tilemap-collision-masks, server-gameroom, client-gamescene, client-prediction]

# Tech tracking
tech-stack:
  added: []
  patterns: ["sub-rect narrow-phase collision within broad-phase tile scan", "optional parameter for backward-compatible API extension"]

key-files:
  created: []
  modified: ["shared/collisionGrid.ts"]

key-decisions:
  - "Full-tile fallback when collisionShapes not provided preserves identical behavior at all existing call sites"
  - "OOB tiles get full-tile rect in resolveCollisions via null-coalescing fallback"
  - "Broad-phase tile scan range unchanged -- only per-tile overlap test and push-out positions use sub-rects"

patterns-established:
  - "Sub-rect collision: narrow-phase AABB test against tile-local CollisionRect after broad-phase tile scan"
  - "Optional trailing constructor parameter for backward-compatible shared code extension"

requirements-completed: [COLL-MASK-03, COLL-MASK-04]

# Metrics
duration: 2min
completed: 2026-02-16
---

# Phase 09.1 Plan 02: CollisionGrid Sub-Rect Collision Summary

**Per-tile CollisionRect support in shared CollisionGrid with sub-rect AABB narrow-phase resolution and backward-compatible API**

## Performance

- **Duration:** 2 min
- **Started:** 2026-02-16T20:20:52Z
- **Completed:** 2026-02-16T20:22:35Z
- **Tasks:** 1
- **Files modified:** 1

## Accomplishments
- Added CollisionRect interface and extended TileInfo to store per-tile collision sub-rectangles
- Modified resolveCollisions to perform narrow-phase sub-rect AABB checks on both X and Y axes, pushing entities to sub-rect edges instead of full tile edges
- Added isPointInSolidRect method for projectile collision precision against sub-rect boundaries
- Maintained full backward compatibility: existing call sites compile and behave identically (full-tile fallback)

## Task Commits

Each task was committed atomically:

1. **Task 1: Extend CollisionGrid with CollisionRect and sub-rect resolution** - `ab071d5` (feat)

## Files Created/Modified
- `shared/collisionGrid.ts` - Added CollisionRect interface, extended TileInfo, optional collisionShapes constructor param, sub-rect narrow-phase in resolveCollisions, isPointInSolidRect method

## Decisions Made
- Full-tile fallback when collisionShapes not provided preserves identical behavior at all existing call sites
- OOB tiles get full-tile rect in resolveCollisions via null-coalescing fallback (consistent with isSolid treating OOB as solid)
- Broad-phase tile scan range unchanged -- only per-tile overlap test and push-out positions use sub-rects (performance neutral)

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- CollisionGrid now accepts collision shape data and uses it for precise resolution
- Ready for Plan 03+ to wire collision shape data from Tiled JSON through GameRoom/GameScene into CollisionGrid constructor
- isPointInSolidRect ready for projectile collision calls to adopt

## Self-Check: PASSED

- FOUND: shared/collisionGrid.ts
- FOUND: 09.1-02-SUMMARY.md
- FOUND: ab071d5 (Task 1 commit)

---
*Phase: 09.1-tilemap-collision-masks*
*Completed: 2026-02-16*
