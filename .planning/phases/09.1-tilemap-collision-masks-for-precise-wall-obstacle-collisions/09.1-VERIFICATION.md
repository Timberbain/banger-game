---
phase: 09.1-tilemap-collision-masks
verified: 2026-02-16T21:30:00Z
status: passed
score: 12/12
re_verification: false
---

# Phase 09.1: Tilemap Collision Masks Verification Report

**Phase Goal:** Replace full-tile AABB collision with sub-tile rectangle collision shapes so players and projectiles collide with the visual edges of walls and obstacles, not invisible tile boundaries

**Verified:** 2026-02-16T21:30:00Z
**Status:** passed
**Re-verification:** No — initial verification

## Goal Achievement

### Observable Truths

| # | Truth | Status | Evidence |
|---|-------|--------|----------|
| 1 | Each map JSON contains per-tile collision rectangles derived from the actual tileset pixel art | ✓ VERIFIED | All 3 maps contain 111 collision shapes each in `tilesets[0].properties.collisionShapes` |
| 2 | Collision rects represent the tightest opaque pixel bounding box within each 32x32 tile | ✓ VERIFIED | Sample shapes show sub-tile precision (e.g., `{x:0, y:12, w:32, h:20}` vs full-tile `{x:0, y:0, w:32, h:32}`) |
| 3 | All 3 tilesets (hedge, brick, wood) have independently derived collision shapes | ✓ VERIFIED | 3 collision sidecar JSONs exist, each with 110+ tile shapes |
| 4 | CollisionGrid stores a per-tile CollisionRect for every solid tile | ✓ VERIFIED | TileInfo extended with `collisionRect` field, constructor populates from collisionShapes param |
| 5 | resolveCollisions pushes entities to sub-rect edges (not full tile edges) | ✓ VERIFIED | Both X/Y axis resolution uses `rectLeft/Right/Top/Bottom` from sub-rect bounds |
| 6 | Projectile point-in-tile checks use isPointInSolidRect for sub-rect precision | ✓ VERIFIED | Server GameRoom uses `isPointInSolidRect(proj.x, proj.y)` at line 631 |
| 7 | Out-of-bounds tiles use full-tile collision rect as fallback | ✓ VERIFIED | OOB check returns true in isPointInSolidRect; resolveCollisions uses null-coalescing `|| fullTile` |
| 8 | The new collisionShapes parameter is optional so existing code compiles without changes | ✓ VERIFIED | Optional parameter `collisionShapes?: Record<...>` at line 60; both server/client compile clean |
| 9 | Server loads collision shapes from map JSON and passes them to CollisionGrid | ✓ VERIFIED | GameRoom extracts shapes at line 90, passes as 7th arg at line 99 |
| 10 | Client loads collision shapes from cached map data and passes them to CollisionGrid | ✓ VERIFIED | GameScene extracts shapes at line 1913, passes at line 1922 |
| 11 | Server and client pass identical collision data to CollisionGrid (deterministic prediction) | ✓ VERIFIED | Both use identical pattern: `mapJson.tilesets?.[0]?.properties?.collisionShapes || {}` |
| 12 | F3 key toggles debug overlay showing collision rectangles on all solid tiles | ✓ VERIFIED | F3 key registered at line 206, toggleDebugCollisionOverlay() renders colored rects |

**Score:** 12/12 truths verified

### Required Artifacts

| Artifact | Expected | Status | Details |
|----------|----------|--------|---------|
| `scripts/generate-collision-masks.py` | Auto-derivation of collision rects from tileset PNGs | ✓ VERIFIED | 147 lines, uses PIL `getbbox()` on alpha channel, outputs 3 JSON sidecars |
| `client/public/maps/hedge_garden.json` | Map with embedded collisionShapes | ✓ VERIFIED | Contains `collisionShapes` with 111 shapes |
| `client/public/maps/brick_fortress.json` | Map with embedded collisionShapes | ✓ VERIFIED | Contains `collisionShapes` with 111 shapes |
| `client/public/maps/timber_yard.json` | Map with embedded collisionShapes | ✓ VERIFIED | Contains `collisionShapes` with 111 shapes |
| `shared/collisionGrid.ts` | Sub-rect AABB collision resolution and point-in-subrect check | ✓ VERIFIED | 276 lines, exports CollisionRect interface, has isPointInSolidRect, sub-rect narrow-phase in resolveCollisions |
| `server/src/rooms/GameRoom.ts` | Server collision grid with sub-rect data + projectile sub-rect check | ✓ VERIFIED | Extracts collisionShapes, passes to CollisionGrid, uses isPointInSolidRect for projectiles |
| `client/src/scenes/GameScene.ts` | Client collision grid with sub-rect data + F3 debug overlay | ✓ VERIFIED | Extracts collisionShapes, passes to CollisionGrid, F3 key toggles debug overlay |
| `client/src/systems/Prediction.ts` | Prediction collision grid receives same shapes as GameScene | ✓ VERIFIED | No changes needed - receives grid by reference via setCollisionGrid |

### Key Link Verification

| From | To | Via | Status | Details |
|------|----|----|--------|---------|
| `scripts/generate-collision-masks.py` | `assets/tilesets/walls/*.png` | PIL alpha channel bounding box scan | ✓ WIRED | `getbbox()` on alpha channel at line 68 |
| `scripts/generate-arenas.py` | `client/public/maps/*.json` | Embeds collision shapes from JSON sidecar into map JSON tileset properties | ✓ WIRED | Post-generation embedding reads sidecars and injects into map JSON |
| `server/src/rooms/GameRoom.ts` | `shared/collisionGrid.ts` | CollisionGrid constructor with collisionShapes parameter | ✓ WIRED | Line 90 extracts shapes, line 99 passes as 7th arg |
| `client/src/scenes/GameScene.ts` | `shared/collisionGrid.ts` | CollisionGrid constructor with collisionShapes parameter | ✓ WIRED | Line 1913 extracts shapes, line 1922 passes as 7th arg |
| `server/src/rooms/GameRoom.ts` | `shared/collisionGrid.ts` | isPointInSolidRect for projectile collision | ✓ WIRED | Line 631 uses isPointInSolidRect for projectile wall/obstacle checks |

### Requirements Coverage

Phase 09.1 is an INSERTED phase with requirement IDs that are not formally tracked in REQUIREMENTS.md (which only covers planned v2.0 phases). The requirements are documented in PLAN frontmatter:

| Requirement | Status | Supporting Truths |
|-------------|--------|-------------------|
| COLL-MASK-01 (Plan 01) | ✓ SATISFIED | Truths 1, 2, 3 verified |
| COLL-MASK-02 (Plan 01) | ✓ SATISFIED | Truths 1, 2, 3 verified |
| COLL-MASK-03 (Plan 02) | ✓ SATISFIED | Truths 4, 5, 6, 7, 8 verified |
| COLL-MASK-04 (Plan 02) | ✓ SATISFIED | Truths 4, 5, 6, 7, 8 verified |
| COLL-MASK-05 (Plan 03) | ✓ SATISFIED | Truths 9, 10, 11, 12 verified |

**Note:** These requirement IDs are phase-local and not in .planning/REQUIREMENTS.md since this is a decimal-numbered insertion phase.

### Anti-Patterns Found

| File | Line | Pattern | Severity | Impact |
|------|------|---------|----------|--------|
| None found | - | - | - | All implementations substantive |

**Scan Results:**
- No TODO/FIXME/PLACEHOLDER comments in phase-modified files
- No empty implementations (return null/{}/)
- No console.log-only stubs
- All functions have substantive logic

### Human Verification Required

#### 1. Visual collision boundary accuracy

**Test:** Start the game, press F3 to enable debug overlay, observe colored rectangles on walls and obstacles
**Expected:** 
- Colored rectangles tightly bound the visible pixel art of each wall/obstacle tile
- No large gaps between visual art and collision boundary
- Rectangles match the intended collision region (opaque pixels only)
**Why human:** Visual accuracy assessment - automated bounding box may need manual overrides for specific tiles

#### 2. Gameplay feel with tighter collision boundaries

**Test:** Play a full match as Paran, intentionally test movement along wall edges and through narrow gaps
**Expected:**
- Paran can pass through visual gaps between wall tiles without hitting invisible boundaries
- Wall collision triggers only when visually touching the wall art (not before)
- Paran velocity penalty triggers at the correct visual moment of wall contact
- No unexpected sticking or sliding on walls
**Why human:** Gameplay feel and edge case behavior that varies with movement speed and input timing

#### 3. Projectile precision through visual gaps

**Test:** As Guardian, fire projectiles through narrow gaps between wall tiles and diagonal corridors
**Expected:**
- Projectiles pass through visual gaps without hitting invisible boundaries
- Projectiles collide with walls only when hitting visible wall art
- No projectiles mysteriously stopping in empty space
**Why human:** Projectile trajectory observation requires real-time gameplay and visual judgment

#### 4. Debug overlay persistence across stage transitions

**Test:** Enable F3 debug overlay, play through a stage transition (win condition triggers stage change)
**Expected:**
- Debug overlay clears during stage transition fade
- Debug overlay does not show stale collision data from previous arena
- F3 toggle still works after stage transition
**Why human:** Multi-stage lifecycle test requires full match flow

### Gaps Summary

None. All must-haves verified at all three levels (exists, substantive, wired). All automated checks passed.

---

_Verified: 2026-02-16T21:30:00Z_
_Verifier: Claude (gsd-verifier)_
