---
phase: 01-foundation-server-architecture
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/package.json
  - server/tsconfig.json
  - server/src/index.ts
  - server/src/config.ts
  - server/src/schema/GameState.ts
  - server/src/rooms/GameRoom.ts
autonomous: true

must_haves:
  truths:
    - "Server starts and listens on port 2567 for WebSocket connections"
    - "Server runs game loop at fixed 60Hz tick rate (16.67ms per tick)"
    - "Player state (x, y, health) is defined with Schema decorators for automatic delta sync"
    - "Players are added to state on join and removed on leave"
    - "Client inputs are queued in onMessage and processed only during fixedTick"
  artifacts:
    - path: "server/package.json"
      provides: "Server dependencies and dev scripts"
      contains: "colyseus"
    - path: "server/tsconfig.json"
      provides: "TypeScript config with experimentalDecorators"
      contains: "experimentalDecorators"
    - path: "server/src/index.ts"
      provides: "Express + Colyseus server entry point"
      exports: ["default"]
    - path: "server/src/config.ts"
      provides: "Server configuration constants (port, tick rate)"
      exports: ["SERVER_CONFIG"]
    - path: "server/src/schema/GameState.ts"
      provides: "Player and GameState Schema classes with @type decorators"
      exports: ["Player", "GameState"]
    - path: "server/src/rooms/GameRoom.ts"
      provides: "Game room with 60Hz fixed timestep, input queue, patchRate"
      exports: ["GameRoom"]
  key_links:
    - from: "server/src/index.ts"
      to: "server/src/rooms/GameRoom.ts"
      via: "gameServer.define('game_room', GameRoom)"
      pattern: "define.*game_room.*GameRoom"
    - from: "server/src/rooms/GameRoom.ts"
      to: "server/src/schema/GameState.ts"
      via: "Room<GameState> with setState"
      pattern: "Room<GameState>"
    - from: "server/src/rooms/GameRoom.ts"
      to: "setSimulationInterval"
      via: "Fixed tick loop at 60Hz"
      pattern: "setSimulationInterval"
---

<objective>
Set up the Colyseus authoritative game server with Express, TypeScript, Schema-based state, and a 60Hz fixed timestep game loop.

Purpose: This is the foundation for the entire multiplayer architecture. The server must be authoritative -- all game state lives here, clients only send inputs and receive state updates. The 60Hz fixed timestep ensures deterministic physics simulation.

Output: A runnable Colyseus server on port 2567 that accepts WebSocket connections, manages player join/leave, processes queued inputs at 60Hz, and automatically delta-syncs state to connected clients.
</objective>

<execution_context>
@/Users/jonasbrandvik/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jonasbrandvik/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-server-architecture/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create server project with Express + Colyseus + TypeScript</name>
  <files>
    server/package.json
    server/tsconfig.json
    server/src/index.ts
    server/src/config.ts
  </files>
  <action>
    Create the server/ directory and initialize the project manually (do NOT use `npm create colyseus-app` -- we need precise control over the setup).

    **server/package.json:**
    - name: "banger-server"
    - dependencies: colyseus@^0.17, @colyseus/schema (latest compatible), express@^4, @colyseus/monitor (latest)
    - devDependencies: typescript@^5, ts-node-dev@^2, @types/express, @types/node
    - scripts: "dev" = "ts-node-dev --respawn --transpile-only src/index.ts", "build" = "tsc", "start" = "node dist/index.js"

    **server/tsconfig.json:**
    - target: "es2016", module: "commonjs", outDir: "./dist"
    - experimentalDecorators: true (REQUIRED for @colyseus/schema @type decorators)
    - strict: true, esModuleInterop: true, sourceMap: true, declaration: true
    - include: ["src/**/*"], exclude: ["node_modules"]

    **server/src/config.ts:**
    - Export SERVER_CONFIG object with: port (from process.env.PORT or 2567), tickRate (60), fixedTimeStep (1000/60), patchRate (1000/60)
    - Export GAME_CONFIG with: maxPlayers (3 -- 1v2 game), playerStartHealth (100), arenaWidth (800), arenaHeight (600)

    **server/src/index.ts:**
    - Create Express app, createServer from http
    - Create Colyseus Server with the httpServer
    - Register GameRoom with gameServer.define("game_room", GameRoom)
    - Add @colyseus/monitor at route "/colyseus" for dev debugging
    - Listen on SERVER_CONFIG.port
    - Log startup message: "Banger server listening on ws://localhost:{port}"

    Run `cd server && npm install` after creating files.
  </action>
  <verify>
    Run `cd server && npx tsc --noEmit` -- should compile with zero errors.
    Run `cd server && npm run dev` (briefly, then kill) -- should print "Banger server listening on ws://localhost:2567".
  </verify>
  <done>Server project exists with all dependencies installed, TypeScript compiles cleanly, server starts and listens on port 2567.</done>
</task>

<task type="auto">
  <name>Task 2: Define Schema-based game state with Player and GameState classes</name>
  <files>
    server/src/schema/GameState.ts
  </files>
  <action>
    Create the Colyseus Schema classes that define the authoritative game state. These classes use @type() decorators for automatic delta serialization -- only changed properties are transmitted to clients.

    **server/src/schema/GameState.ts:**

    Player class (extends Schema):
    - @type("number") x: number = 0
    - @type("number") y: number = 0
    - @type("number") health: number = 100
    - @type("string") name: string = ""
    - @type("number") angle: number = 0 (facing direction in radians)
    - @type("string") role: string = "" (will be "guardian" or "paran" in later phases)
    - inputQueue: any[] = [] (NOT decorated with @type -- server-only, not synced to clients)

    GameState class (extends Schema):
    - @type({ map: Player }) players = new MapSchema<Player>()
    - @type("number") serverTime: number = 0
    - @type("string") mapName: string = "test_arena"
    - @type("number") tickCount: number = 0

    IMPORTANT: Keep property count well under 64 per class (Schema limit). Currently Player has 6 synced props and GameState has 4 -- plenty of room.

    IMPORTANT: inputQueue must NOT have @type decorator. It is server-only state used for input queuing. Syncing input queues to clients would be a security issue and waste bandwidth.

    Export both Player and GameState.
  </action>
  <verify>
    Run `cd server && npx tsc --noEmit` -- should compile with zero errors.
    Check that Player has exactly 6 @type decorated properties and GameState has 4.
  </verify>
  <done>Schema classes exist with proper @type decorators, inputQueue is server-only (not decorated), TypeScript compiles cleanly.</done>
</task>

<task type="auto">
  <name>Task 3: Implement GameRoom with 60Hz fixed timestep and input queue pattern</name>
  <files>
    server/src/rooms/GameRoom.ts
  </files>
  <action>
    Create the core GameRoom class that establishes the authoritative game loop pattern. This room processes all gameplay at a fixed 60Hz rate using Colyseus setSimulationInterval with an accumulator pattern.

    **server/src/rooms/GameRoom.ts:**

    GameRoom extends Room<GameState>:

    Class properties:
    - maxClients = GAME_CONFIG.maxPlayers (3)
    - patchRate = SERVER_CONFIG.patchRate (1000/60 -- must match tick rate for 60Hz sync)
    - autoDispose = true

    onCreate(options):
    - this.setState(new GameState())
    - Set up fixed timestep loop using setSimulationInterval:
      ```
      let elapsedTime = 0;
      this.setSimulationInterval((deltaTime) => {
        elapsedTime += deltaTime;
        while (elapsedTime >= SERVER_CONFIG.fixedTimeStep) {
          elapsedTime -= SERVER_CONFIG.fixedTimeStep;
          this.fixedTick(SERVER_CONFIG.fixedTimeStep);
        }
      });
      ```
    - Register message handler for "input" type that queues inputs (see below)
    - Log room creation

    onJoin(client, options):
    - Create new Player instance
    - Set initial position (centered in arena: GAME_CONFIG.arenaWidth/2, GAME_CONFIG.arenaHeight/2, with small random offset to avoid overlap)
    - Set player.health = GAME_CONFIG.playerStartHealth
    - Set player.name = options?.name || client.sessionId (truncated to 20 chars)
    - Add to this.state.players.set(client.sessionId, player)
    - Log join with sessionId

    onLeave(client, consented):
    - Delete from this.state.players.delete(client.sessionId)
    - Log leave with sessionId and consented flag

    onMessage handler for "input":
    - Get player from this.state.players.get(client.sessionId)
    - If no player, return silently
    - Push message to player.inputQueue (validation happens in Plan 03)
    - Cap inputQueue length at 10 to prevent memory abuse (shift oldest if over limit)

    fixedTick(deltaTime):
    - Increment this.state.tickCount
    - Update this.state.serverTime += deltaTime
    - For each player in this.state.players:
      - Drain inputQueue: while (input = player.inputQueue.shift())
      - Apply simple movement: if input.left then player.x -= 2, etc. (basic movement, will be replaced with acceleration physics in Phase 2)
      - Clamp player position within arena bounds (0 to arenaWidth, 0 to arenaHeight)

    onDispose():
    - Log room disposal

    IMPORTANT: patchRate MUST be set to 1000/60 (not left at default 50ms). Without this, clients only receive state at 20Hz despite 60Hz server tick -- the game would feel choppy.

    IMPORTANT: All gameplay state changes happen ONLY in fixedTick, never in onMessage. onMessage only queues inputs.
  </action>
  <verify>
    Run `cd server && npx tsc --noEmit` -- should compile with zero errors.
    Run `cd server && npm run dev` briefly -- server should start, log creation message, and listen for connections.
  </verify>
  <done>GameRoom runs at 60Hz fixed timestep, queues inputs from onMessage, processes them in fixedTick, patchRate matches tick rate, players join/leave correctly.</done>
</task>

</tasks>

<verification>
1. `cd server && npx tsc --noEmit` compiles with zero errors
2. `cd server && npm run dev` starts server on port 2567
3. GameState.ts has Player (6 @type props) and GameState (4 @type props) with proper exports
4. GameRoom.ts uses setSimulationInterval with accumulator pattern at 60Hz
5. GameRoom.ts sets patchRate = 1000/60
6. Input queue pattern: onMessage queues, fixedTick drains
7. @colyseus/monitor accessible at http://localhost:2567/colyseus
</verification>

<success_criteria>
- Server compiles and starts without errors
- 60Hz fixed timestep loop is running (verified by tickCount incrementing)
- Schema-based state with delta sync is configured (patchRate = 1000/60)
- Player join/leave updates state correctly
- Input queue pattern established (onMessage queues, fixedTick processes)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-server-architecture/01-01-SUMMARY.md`
</output>
