---
phase: 12-hud-icon-overhaul
plan: 02
type: execute
wave: 2
depends_on: ["12-01"]
files_modified:
  - client/src/scenes/HUDScene.ts
  - client/src/scenes/GameScene.ts
autonomous: true
requirements:
  - HUD-03
  - HUD-05
  - HUD-06

must_haves:
  truths:
    - "Kill feed entries show skull icon between killer and victim names with character-colored text"
    - "Gravestone icon appears on the arena floor at the exact location where a player died"
    - "Arena gravestones are tinted with the dead player's character color and persist for the entire stage"
    - "Death screen overlay shows a large gravestone icon and 'ELIMINATED' text, then fades out"
    - "Active powerup buffs show as potion icons with a radial timer sweep countdown overlay"
    - "Buff icons flash when about to expire (~2s before) then fade out"
    - "Remote players below 50% HP show a red tint pulse on their sprite"
    - "All HUD elements are properly positioned with no overlap at 1280x720"
  artifacts:
    - path: "client/src/scenes/HUDScene.ts"
      provides: "Kill feed with skull icons, death overlay, radial buff indicators, final layout"
    - path: "client/src/scenes/GameScene.ts"
      provides: "Arena gravestones at death locations, low-health tint pulse on remote players"
  key_links:
    - from: "client/src/scenes/HUDScene.ts"
      to: "BootScene preloaded icon_skull texture"
      via: "this.add.image() in addKillFeedEntry"
      pattern: "add\\.image.*icon_skull"
    - from: "client/src/scenes/HUDScene.ts"
      to: "BootScene preloaded icon_gravestone texture"
      via: "this.add.image() in showDeathOverlay"
      pattern: "add\\.image.*icon_gravestone"
    - from: "client/src/scenes/GameScene.ts"
      to: "BootScene preloaded icon_gravestone texture"
      via: "this.add.image() in kill event handler"
      pattern: "add\\.image.*icon_gravestone"
    - from: "client/src/scenes/HUDScene.ts"
      to: "Phaser Graphics.slice() API"
      via: "Radial timer sweep on buff indicator icons"
      pattern: "gfx\\.slice\\("
---

<objective>
Implement the remaining icon-based HUD elements: skull icons in the kill feed with colored names, arena floor gravestones, death overlay screen, radial timer sweep for powerup buff indicators, low-health sprite tint pulse on remote players, and a final positioning pass to ensure all elements fit cleanly at 1280x720.

Purpose: Completes the full HUD icon overhaul with polished combat feedback (kill feed, death, powerups) and proper layout verification.
Output: Fully icon-based HUD with kill feed skulls, arena gravestones, death overlay, radial powerup timers, and verified 1280x720 layout.
</objective>

<execution_context>
@/Users/jonasbrandvik/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jonasbrandvik/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-hud-icon-overhaul/12-RESEARCH.md
@.planning/phases/12-hud-icon-overhaul/12-01-SUMMARY.md
@client/src/scenes/HUDScene.ts
@client/src/scenes/GameScene.ts
@client/src/ui/designTokens.ts
@shared/characters.ts
@shared/powerups.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Kill feed skull icons, arena gravestones, and death overlay</name>
  <files>
    client/src/scenes/HUDScene.ts
    client/src/scenes/GameScene.ts
  </files>
  <action>
    **KILL FEED WITH SKULL ICONS (Section 3 - HUD-03):**

    1. Update the KillFeedEntry interface to hold multiple game objects instead of a single text:
       ```typescript
       interface KillFeedEntry {
         objects: Phaser.GameObjects.GameObject[]; // all text + icon objects for this entry
         bg: Phaser.GameObjects.Rectangle;
         addedAt: number;
       }
       ```

    2. Rewrite addKillFeedEntry() for the new layout:
       - Only use skull icon for actual kill entries (both killerRole and victimRole are non-empty strings)
       - For kill entries, create 3 objects right-aligned:
         a. victimText: Text with victim name in charColor(data.victimRole), fontSize 12px, monospace bold, black stroke 2px
         b. skullIcon: Image using 'icon_skull' at setDisplaySize(14, 14) -- slightly smaller than 16 for inline fit
         c. killerText: Text with killer name in charColor(data.killerRole), same style
       - Position from right: victimText (rightmost, origin 0,0.5), then skullIcon to its left (4px gap), then killerText to skull's left (4px gap)
       - Calculate total width: killerText.displayWidth + 4 + 14 + 4 + victimText.displayWidth
       - Size background rectangle to totalWidth + 16 (8px padding each side)
       - For non-kill entries (powerup spawn/collect where victimRole is empty): keep the current single text format with ">", no skull icon
       - Store all created objects in the entry.objects array
       - Set all objects to depth 201, bg to depth 200

    3. Update the push-existing-entries-down loop to move all entry.objects (not just entry.text).

    4. Update updateKillFeed() to set alpha on all entry.objects and entry.bg during fade-out. On removal, destroy all entry.objects and entry.bg.

    5. Update the excess entry removal to destroy all entry.objects.

    **DEATH OVERLAY (HUD-03):**

    6. Add new member variables:
       ```typescript
       private deathOverlayObjects: Phaser.GameObjects.GameObject[] = [];
       ```
       Reset in create().

    7. Create showDeathOverlay() method in HUDScene:
       - Large gravestone icon centered: `this.add.image(W/2, H/2 - 30, 'icon_gravestone')`
       - setDisplaySize(64, 64), setDepth(300), setAlpha(0)
       - "ELIMINATED" text below: `this.add.text(W/2, H/2 + 30, 'ELIMINATED', {...TextStyle.splash, fontSize: '36px', color: Colors.status.danger})`
       - setOrigin(0.5), setDepth(300), setAlpha(0)
       - Store both in deathOverlayObjects array
       - Fade in tween: targets both objects, alpha: 1, duration: 500
       - Fade out tween: targets both, alpha: 0, duration: 800, delay: 3000, onComplete destroys both objects and clears deathOverlayObjects

    8. Wire showDeathOverlay() to the existing localDied event handler in setupCrossSceneEvents(). The current handler body is empty -- add `this.showDeathOverlay();` inside it.

    9. Destroy deathOverlayObjects in onShutdown and in clearBuffIndicators/stage-reset path (the stage reset in matchState listener that calls clearBuffIndicators should also clear death overlay).

    **ARENA FLOOR GRAVESTONES (GameScene - HUD-03):**

    10. Add new member variable to GameScene:
        ```typescript
        private gravestoneSprites: Phaser.GameObjects.Image[] = [];
        ```
        Reset to [] in create().

    11. In GameScene, add a separate 'kill' message handler (alongside existing handlers or within the existing player death handling):
        - On 'kill' message, look up the victim's position from room.state.players by matching player.name === data.victim
        - Create gravestone sprite: `this.add.image(player.x, player.y, 'icon_gravestone')`
        - setDisplaySize(32, 32), setDepth(5) (below players at 10, above ground at 0)
        - setTint(charColorNum(data.victimRole)) -- tint with dead player's character color
        - Push to gravestoneSprites array

    12. In cleanupStageVisuals(), add cleanup for gravestone sprites:
        ```typescript
        this.gravestoneSprites.forEach(sprite => sprite.destroy());
        this.gravestoneSprites = [];
        ```
        Add this BEFORE the "Reset player sprite alpha" section.

    IMPORTANT: GameScene does not currently have an onMessage('kill') handler -- only HUDScene does. Register one in GameScene's room message listener setup area (near the onMessage('powerupCollect'), etc. block, or in the attachRoomListeners method if it exists). Do NOT duplicate the kill feed logic -- GameScene only spawns the gravestone sprite.
  </action>
  <verify>
    - No TypeScript compilation errors: cd client && npx tsc --noEmit
    - KillFeedEntry interface has objects array (not single text)
    - addKillFeedEntry creates skull icon between colored killer/victim names for kill events
    - addKillFeedEntry falls back to text-only for non-kill events (empty victimRole)
    - showDeathOverlay creates gravestone image + ELIMINATED text with fade-in/out tweens
    - localDied handler calls showDeathOverlay()
    - GameScene has gravestoneSprites array, reset in create()
    - GameScene registers 'kill' onMessage handler that spawns tinted gravestone
    - cleanupStageVisuals destroys all gravestone sprites
    - deathOverlayObjects reset in create() and cleaned up in onShutdown
  </verify>
  <done>
    Kill feed entries display "KillerName [skull] VictimName" with character-colored text for kill events, and plain text for non-kill events. Death overlay shows large gravestone + "ELIMINATED" text that fades in then out after 3s. Arena floor gravestones appear at death locations, tinted with the dead player's color, persisting for the entire stage. All cleaned up on stage transitions. No compilation errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Radial powerup indicators, low-health tint pulse, and final layout pass</name>
  <files>
    client/src/scenes/HUDScene.ts
    client/src/scenes/GameScene.ts
  </files>
  <action>
    **RADIAL TIMER SWEEP BUFF INDICATORS (Section 10 - HUD-05):**

    1. Redesign the buffIndicators Map value type to use radial timer sweep instead of linear bars:
       ```typescript
       private buffIndicators: Map<number, {
         icon: Phaser.GameObjects.Image;
         radialGfx: Phaser.GameObjects.Graphics;
         startTime: number;
         duration: number;
         flashTimer?: Phaser.Time.TimerEvent;
       }> = new Map();
       ```
       Remove the old bg/fill rectangle fields.

    2. Rewrite addBuffIndicator():
       - Position: to the right of the heart row at bottom of screen
       - Calculate heartRowRightEdge from the heart icons array (last heart x + 16 + 8px gap), or default to W/2 + 100 if no hearts
       - Icon size: 32x32 (potion icon at 2x)
       - Create the potion icon image using the SAME texture key lookup as current code (potion_speed, potion_invincibility, potion_projectile)
       - setDisplaySize(32, 32), setDepth(201)
       - Create a Graphics object for the radial sweep overlay: `this.add.graphics()`
       - setDepth(202) (above the icon)
       - Store in buffIndicators Map

    3. Rewrite repositionBuffIndicators():
       - Calculate position to the right of the heart row
       - heartRowRight = last heartIcon x + 16 (half icon width), or W/2 if no hearts
       - First buff icon at heartRowRight + 24, subsequent ones spaced 40px apart
       - y = same as heart row y (H * 0.92)
       - Position both icon and radialGfx at the same center point

    4. Rewrite updateBuffIndicators():
       - For each indicator, calculate fraction = remaining / duration (1.0 full, 0.0 empty)
       - Clear the Graphics object
       - Draw the "elapsed" portion as a semi-transparent dark overlay (clockwise drain from 12 o'clock):
         ```typescript
         const startAngle = Phaser.Math.DegToRad(-90); // 12 o'clock
         const endAngle = Phaser.Math.DegToRad(-90 + 360 * (1 - fraction)); // elapsed portion
         gfx.clear();
         if (fraction < 1) {
           gfx.fillStyle(0x000000, 0.5);
           gfx.slice(iconX, iconY, 16, startAngle, endAngle, false); // clockwise elapsed
           gfx.fillPath();
         }
         ```
       - Flash behavior: when remaining < 2000ms (2s before expiry), start a flash timer:
         Flash 5 times over 2s (400ms cycle: 200ms visible, 200ms hidden)
         Toggle icon alpha between 1 and 0.3
       - When remaining <= 0, fade out: tween icon alpha to 0 over 500ms
         (The actual removal happens via the buffExpired server message)

    5. Update removeBuffIndicator() to destroy icon and radialGfx (not bg/fill).

    6. Update clearBuffIndicators() similarly.

    7. Update onShutdown to clean up the new indicator structure.

    **LOW-HEALTH SPRITE TINT PULSE (GameScene - HUD-01 related):**

    8. Add new member variable to GameScene:
       ```typescript
       private lowHealthPulseTweens: Map<string, Phaser.Time.TimerEvent> = new Map();
       ```
       Reset in create().

    9. In handlePlayerChange() (the onChange callback for each player), add low-health tint pulse logic for REMOTE players only (sessionId !== this.localSessionId):
       - Get maxHealth from CHARACTERS[player.role]?.maxHealth || 100
       - Calculate healthPct = player.health / maxHealth
       - If healthPct < 0.5 AND healthPct > 0 AND no existing tween for this sessionId:
         Create a TimerEvent that alternates between setTint(0xff4444) and clearTint() every 300ms:
         ```typescript
         const sprite = this.playerSprites.get(sessionId);
         if (sprite) {
           let tintOn = false;
           const timer = this.time.addEvent({
             delay: 300,
             loop: true,
             callback: () => {
               const s = this.playerSprites.get(sessionId);
               if (!s) return;
               tintOn = !tintOn;
               if (tintOn) s.setTint(0xff4444);
               else s.clearTint();
             }
           });
           this.lowHealthPulseTweens.set(sessionId, timer);
         }
         ```
       - If healthPct >= 0.5 OR healthPct <= 0 AND has existing timer:
         Destroy the timer, clearTint on sprite, delete from map

    10. In cleanupStageVisuals(), clean up lowHealthPulseTweens:
        ```typescript
        this.lowHealthPulseTweens.forEach(timer => timer.destroy());
        this.lowHealthPulseTweens.clear();
        ```

    11. On player removal (onRemove), also clean up any lowHealthPulseTween for that sessionId.

    **FINAL LAYOUT POSITIONING PASS (HUD-06):**

    12. Verify and adjust all HUD element positions for clean 1280x720 layout:

        TOP AREA (reading top to bottom):
        - Timer icon + text: y = H * 0.03 (top center, ~22px) -- KEEP as-is from 12-01
        - Round score pips: y = H * 0.07 (~50px) -- from 12-01
        - Stage label: y = H * 0.09 (~65px) -- from 12-01

        TOP-RIGHT AREA:
        - Minimap: x=W-10, y=10, 180x115 -- existing, no change
        - Ping: y=133 -- existing, no change
        - Kill feed: baseY=155 -- existing, no change

        TOP-LEFT:
        - Role reminder: x=15, y=15 -- existing, no change

        BOTTOM CENTER:
        - Heart row: centered at y = H * 0.92 (~662px) -- from 12-01
        - Buff indicators: to the right of heart row, same y -- this task
        - Cooldown bar: y = H * 0.89 (~641px) -- existing, above hearts
        - Player name label: below heart row at y = H * 0.95 (~684px) -- from 12-01

        CENTER (death overlay):
        - Gravestone + ELIMINATED: centered at H/2 -- this task

    13. Test that the cooldown bar at H*0.89 doesn't overlap with the heart row at H*0.92. The gap should be about 21px which is sufficient.

    14. Ensure buff indicator positioning adapts to heart count (Paran has 15 hearts = ~510px wide, Faran/Baran have 5 hearts = ~170px). The buff icons should start after the rightmost heart.
  </action>
  <verify>
    - No TypeScript compilation errors: cd client && npx tsc --noEmit
    - buffIndicators Map value type has icon + radialGfx (no bg/fill rectangles)
    - addBuffIndicator creates potion icon Image + Graphics object
    - updateBuffIndicators uses Graphics.slice() for radial sweep
    - Flash behavior triggers at 2s remaining with 400ms cycle
    - lowHealthPulseTweens Map exists in GameScene, reset in create()
    - handlePlayerChange applies red tint pulse to remote players below 50% HP
    - cleanupStageVisuals cleans up lowHealthPulseTweens and gravestone sprites
    - Buff indicators positioned to the right of the heart row
    - No HUD elements overlap at 1280x720
  </verify>
  <done>
    Powerup buff indicators show potion icons with radial timer sweep (clockwise drain, semi-transparent dark overlay). Buffs flash at 2s before expiry. Remote players below 50% HP pulse red on their game sprite. All HUD elements properly positioned at 1280x720: timer+pips at top-center, minimap+kill feed at top-right, hearts+buffs at bottom-center, cooldown bar above hearts. No overlap, no cutoff. No compilation errors.
  </done>
</task>

</tasks>

<verification>
1. No TypeScript compilation errors: cd client && npx tsc --noEmit
2. Kill feed shows "killer [skull] victim" with colored names for kill events
3. Arena floor gravestones appear at death locations, tinted with character color
4. Gravestones persist for entire stage, cleaned up on stage transition
5. Death overlay shows large gravestone + "ELIMINATED" text, fades in/out
6. Powerup buff indicators use radial timer sweep (not linear bars)
7. Buff icons flash before expiry
8. Remote players below 50% HP have red tint pulse on their sprite
9. All HUD elements properly positioned with no overlap at 1280x720
10. Scene reuse: all new member variables reset in create()
</verification>

<success_criteria>
- Kill feed entries show skull icon inline between character-colored killer and victim names
- Non-kill feed entries (powerup spawn/collect) remain text-only
- Gravestone sprites placed at death locations, tinted with character color, persist per stage
- Death overlay with gravestone + "ELIMINATED" fades in over 0.5s, stays 3s, fades out 0.8s
- Powerup indicators show potion icons with clockwise radial timer drain
- Buff icons flash 5 times over 2s before expiry
- Remote players below 50% HP pulse red (300ms on/off cycle, 0xff4444 tint)
- No HUD element overlap at 1280x720
- No TypeScript compilation errors
- All new member variables reset in create() for scene reuse
</success_criteria>

<output>
After completion, create `.planning/phases/12-hud-icon-overhaul/12-02-SUMMARY.md`
</output>
