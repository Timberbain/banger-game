---
phase: 12-hud-icon-overhaul
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - client/public/icons/heart-full.png
  - client/public/icons/heart-empty.png
  - client/public/icons/timer.png
  - client/public/icons/skull.png
  - client/public/icons/gravestone.png
  - client/public/icons/potion-green.png
  - client/src/scenes/BootScene.ts
  - client/src/scenes/HUDScene.ts
  - client/src/scenes/GameScene.ts
autonomous: true
requirements:
  - HUD-01
  - HUD-02
  - HUD-04
  - HUD-06

must_haves:
  truths:
    - "Local player health is displayed as a row of heart icons (full/empty) instead of a colored rectangle bar"
    - "Damage to local player causes the lost heart to flash and shrink before becoming empty"
    - "Non-local players have no health bars at all in the HUD (removed)"
    - "Timer at top-center shows an hourglass icon to the left of the countdown number"
    - "Timer icon and text turn red and pulse when below 30 seconds"
    - "Round score is shown as colored dots/pips below the timer instead of text"
    - "Potion color mapping is updated: Red=Speed, Blue=Invincibility, Green=Projectile in BootScene, GameScene, and HUDScene"
  artifacts:
    - path: "client/public/icons/heart-full.png"
      provides: "Heart full icon asset"
    - path: "client/public/icons/heart-empty.png"
      provides: "Heart empty icon asset"
    - path: "client/public/icons/timer.png"
      provides: "Hourglass timer icon asset"
    - path: "client/public/icons/potion-green.png"
      provides: "Green potion icon for projectile powerup"
    - path: "client/src/scenes/BootScene.ts"
      provides: "Preloads all new icon textures and updates potion color mapping"
    - path: "client/src/scenes/HUDScene.ts"
      provides: "Heart health display, timer icon layout, round score pips"
    - path: "client/src/scenes/GameScene.ts"
      provides: "Updated POWERUP_TEXTURE color mapping"
  key_links:
    - from: "client/src/scenes/BootScene.ts"
      to: "client/public/icons/"
      via: "this.load.image() preload calls"
      pattern: "load\\.image\\('icon_"
    - from: "client/src/scenes/HUDScene.ts"
      to: "BootScene preloaded textures"
      via: "this.add.image() referencing preloaded icon keys"
      pattern: "add\\.image.*icon_heart"
    - from: "client/src/scenes/GameScene.ts"
      to: "BootScene preloaded textures"
      via: "POWERUP_TEXTURE map referencing preloaded potion keys"
      pattern: "POWERUP_TEXTURE"
---

<objective>
Copy all icon assets to the public directory, preload them in BootScene, and implement the three core HUD icon replacements: heart-based health display (local player only), hourglass+timer layout, and round score pips. Also update the potion color mapping across all files simultaneously.

Purpose: Establishes the asset pipeline and core icon-based HUD elements (health, timer, round score) that all subsequent visual work builds on.
Output: Working heart row health display, icon-enhanced timer, colored pip round score, and consistent potion color mapping.
</objective>

<execution_context>
@/Users/jonasbrandvik/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jonasbrandvik/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/12-hud-icon-overhaul/12-RESEARCH.md
@client/src/scenes/BootScene.ts
@client/src/scenes/HUDScene.ts
@client/src/scenes/GameScene.ts
@client/src/ui/designTokens.ts
@shared/characters.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Copy icon assets and update asset preloading + potion color mapping</name>
  <files>
    client/public/icons/heart-full.png
    client/public/icons/heart-empty.png
    client/public/icons/timer.png
    client/public/icons/skull.png
    client/public/icons/gravestone.png
    client/public/icons/potion-green.png
    client/src/scenes/BootScene.ts
    client/src/scenes/GameScene.ts
  </files>
  <action>
    1. Copy icon asset files from assets/icons/ to client/public/icons/:
       - assets/icons/icon001.png -> client/public/icons/heart-full.png
       - assets/icons/icon002.png -> client/public/icons/heart-empty.png
       - assets/icons/icon005.png -> client/public/icons/timer.png
       - assets/icons/icon006.png -> client/public/icons/skull.png
       - assets/icons/icon398.png -> client/public/icons/gravestone.png
       - assets/icons/icon278.png -> client/public/icons/potion-green.png

    2. In BootScene.ts preload(), add icon preload calls AFTER existing potion loads:
       ```typescript
       // HUD icon assets (32x32 PNGs)
       this.load.image('icon_heart_full', 'icons/heart-full.png');
       this.load.image('icon_heart_empty', 'icons/heart-empty.png');
       this.load.image('icon_timer', 'icons/timer.png');
       this.load.image('icon_skull', 'icons/skull.png');
       this.load.image('icon_gravestone', 'icons/gravestone.png');
       this.load.image('potion_green', 'icons/potion-green.png');
       ```

    3. Update BootScene.ts potion texture key mapping to match new color assignments:
       - potion_speed: change from 'icons/potion-blue.png' to 'icons/potion-red.png' (Red=Speed)
       - potion_invincibility: change from 'icons/potion-orange.png' to 'icons/potion-blue.png' (Blue=Invincibility)
       - potion_projectile: change from 'icons/potion-red.png' to 'icons/potion-green.png' (Green=Projectile)

    4. In GameScene.ts, the POWERUP_TEXTURE map references texture keys (potion_speed, potion_invincibility, potion_projectile) which are loaded by BootScene -- these keys stay the same, only the BootScene file paths change. Verify no file path references exist in GameScene that need updating.

    CRITICAL: The potion texture KEY names (potion_speed, potion_invincibility, potion_projectile) stay the same everywhere -- only the BootScene load paths change. This ensures GameScene, HUDScene, and all other code using these keys continues to work without modification.
  </action>
  <verify>
    - All 6 icon files exist in client/public/icons/ (ls -la client/public/icons/)
    - BootScene.ts has 6 new this.load.image() calls for icon_heart_full, icon_heart_empty, icon_timer, icon_skull, icon_gravestone, potion_green
    - BootScene potion_speed loads potion-red.png, potion_invincibility loads potion-blue.png, potion_projectile loads potion-green.png
    - No TypeScript compilation errors: cd client && npx tsc --noEmit
  </verify>
  <done>
    All 6 icon assets are in client/public/icons/. BootScene preloads them. Potion color mapping is Red=Speed, Blue=Invincibility, Green=Projectile consistently across BootScene asset loads. No compilation errors.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace health bars with heart icons, add timer icon, and implement round score pips</name>
  <files>
    client/src/scenes/HUDScene.ts
  </files>
  <action>
    **HEALTH DISPLAY (Section 1 - HUD-01):**

    1. Replace the HealthBarUI interface with a heart-based approach. The health display only shows the LOCAL player's health. Remove all non-local health bars.

    2. Add new member variables and reset them in create():
       ```typescript
       private heartIcons: Phaser.GameObjects.Image[] = [];
       private localPlayerLabel: Phaser.GameObjects.Text | null = null;
       ```

    3. Rewrite createHealthBars() -- LOCAL PLAYER ONLY:
       - Wait for state sync (100ms delay, same as current)
       - Find the local player from room.state.players using this.localSessionId
       - Calculate heartCount = Math.ceil(maxHealth / 10) where 10 HP per heart
         - Paran: 150 HP = 15 hearts, Faran/Baran: 50 HP = 5 hearts
       - Position: center the heart row at bottom-center, y = H * 0.92 (about 662px)
       - Create heartCount Image objects using 'icon_heart_full' texture
       - Each icon at setDisplaySize(32, 32), 34px spacing (32px icon + 2px gap)
       - startX = W/2 - (heartCount * 34 - 2) / 2 (centers the row)
       - Add a player name label below the heart row (current "(YOU)" label pattern)
       - Re-register onAdd/onRemove handlers to rebuild when players change (same pattern as current)
       - Remove the old HealthBarUI array usage entirely -- no bg/fill rectangles

    4. Rewrite rebuildHealthBars() to destroy old heartIcons and localPlayerLabel, then call the new creation logic.

    5. Rewrite updateHealthBars() -- LOCAL PLAYER ONLY:
       - Find local player from room.state.players
       - Calculate fullHearts = Math.ceil(currentHealth / 10)
       - For each heartIcons[i]: if i < fullHearts, texture should be 'icon_heart_full', else 'icon_heart_empty'
       - On transition from full to empty (check current texture key vs new key):
         Flash + shrink tween: { scaleX: 0.5, scaleY: 0.5, duration: 150, yoyo: true },
         set texture to 'icon_heart_empty' at tween start (onStart callback)
       - Remove all lowHealthFlashTimers logic (those were for the old rectangle bars)

    6. Remove the lowHealthFlashTimers Map entirely (cleanup in onShutdown too).

    **TIMER ICON (Section 2 - HUD-02):**

    7. Add new member variable: `private timerIcon: Phaser.GameObjects.Image | null = null;`
       Reset in create().

    8. Modify createMatchTimer():
       - Create the hourglass icon: `this.timerIcon = this.add.image(W * 0.5 - 30, H * 0.03, 'icon_timer')`
       - setDisplaySize(24, 24), setOrigin(0.5, 0.5), setDepth(200), setVisible(false)
       - Adjust timerText x position to W * 0.5 + 5 (to the right of the icon, with small gap)

    9. Modify updateMatchTimer():
       - Show/hide timerIcon alongside timerText
       - When low-time warning activates (<=30s), also tint the timerIcon red: `this.timerIcon.setTint(Colors.status.dangerNum)`
       - Add the same alpha pulse to timerIcon (include in the flash timer callback)
       - When timer resets from low-time, also clear timerIcon tint and alpha

    **ROUND SCORE PIPS (Section 9 - HUD-04):**

    10. Add new member variable: `private roundScorePipsGfx: Phaser.GameObjects.Graphics | null = null;`
        Reset in create().

    11. Modify createRoundScore():
        - Remove the old roundScoreText (Text-based "0 - 0")
        - Create a Graphics object for pips: `this.roundScorePipsGfx = this.add.graphics()`
        - Keep the stageLabel text as-is (Stage N label)
        - Keep the Schema listeners for paranStageWins, guardianStageWins, currentStage

    12. Rewrite updateRoundScore():
        - Clear the graphics, then draw:
        - Best-of-3 = 2 pips per side, centered below the timer
        - Pip layout: [P1] [P2] -- [G1] [G2] at y = H * 0.07 (between timer and stage label)
        - pipRadius = 5, pipSpacing = 16
        - Paran pips on the left: filled = Colors.char.paranNum, empty = 0x444444 at 0.6 alpha
        - Separator: thin vertical line (2px wide, 8px tall) at center, white 0.3 alpha
        - Guardian pips on the right: filled = Colors.char.faranNum (guardian color), empty = 0x444444 at 0.6 alpha
        - Call updateRoundScore() once after creation and on every Schema listener callback

    13. Update the stageLabel y-position to H * 0.09 (below the pips, was H * 0.06).

    **CLEANUP:**

    14. Clean up the HealthBarUI interface (no longer needed). Remove it entirely.
    15. Remove the HealthBar import from designTokens if no longer used in this file.
    16. Destroy timerIcon in onShutdown. Destroy roundScorePipsGfx in onShutdown.
    17. Ensure ALL new member variables are reset in create() for scene reuse safety.
  </action>
  <verify>
    - No TypeScript compilation errors: cd client && npx tsc --noEmit
    - HUDScene has heartIcons array, timerIcon, roundScorePipsGfx member variables
    - HUDScene create() resets all new member variables
    - rebuildHealthBars only creates hearts for local player (no non-local bars)
    - updateHealthBars checks texture key transition for flash+shrink animation
    - createMatchTimer creates an icon_timer Image plus offset timerText
    - updateMatchTimer shows/hides/tints/pulses both timerIcon and timerText
    - createRoundScore creates Graphics-based pips, not Text
    - updateRoundScore draws colored circles for paran/guardian wins
    - onShutdown destroys timerIcon and roundScorePipsGfx
  </verify>
  <done>
    Health display shows heart icons (filled/empty) for local player only with flash+shrink damage animation. Timer has hourglass icon to the left with synchronized low-time red pulse. Round score shows colored pips instead of text numbers. All non-local health bars are removed from the HUD. No compilation errors and all new member variables properly reset in create().
  </done>
</task>

</tasks>

<verification>
1. Start the client dev server (cd client && npm run dev) -- no build errors
2. No TypeScript compilation errors (cd client && npx tsc --noEmit)
3. All 6 icon files present in client/public/icons/
4. BootScene preloads all icons and potion textures with correct color mapping
5. Health display uses heart icons, not rectangle bars
6. Timer shows hourglass icon to the left of the countdown
7. Round score shows colored pips, not "0 - 0" text
8. Scene reuse: all new member variables reset in create()
</verification>

<success_criteria>
- Local player health rendered as filled/empty heart icons (10 HP per heart)
- Heart damage animation (flash + shrink) plays on health loss
- Non-local player health bars completely removed from HUD
- Hourglass icon displayed to the left of the timer countdown
- Timer icon and text both turn red and pulse when below 30 seconds
- Round score shown as colored dot pips (paran color / guardian color / gray empty)
- Potion color mapping consistent: Red=Speed, Blue=Invincibility, Green=Projectile
- No TypeScript compilation errors
</success_criteria>

<output>
After completion, create `.planning/phases/12-hud-icon-overhaul/12-01-SUMMARY.md`
</output>
