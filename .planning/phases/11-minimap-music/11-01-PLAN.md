---
phase: 11-minimap-music
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - client/src/systems/AudioManager.ts
  - client/src/scenes/BootScene.ts
  - client/public/audio/lobby/Pixel Jitter Jive.mp3
  - client/public/audio/stage/Forest Deco Run.mp3
  - client/public/audio/stage/Art Deco Forest Arena.mp3
  - client/public/audio/stage/Per Ropar Glas (Remastered v2).mp3
  - client/public/audio/gameover/victory.mp3
  - client/public/audio/gameover/defeat.mp3
  - client/public/soundeffects/hurt_1.wav
  - client/public/soundeffects/hurt_2.wav
  - client/public/soundeffects/hurt_3.wav
  - client/public/soundeffects/hurt_4.wav
  - client/public/soundeffects/laser_1.wav
  - client/public/soundeffects/laser_4.wav
  - client/public/soundeffects/laser_5.wav
  - client/public/soundeffects/earthquake.wav
  - client/public/soundeffects/lightning.wav
  - client/public/soundeffects/disappear.wav
  - client/public/soundeffects/select_1.wav
  - client/public/soundeffects/select_2.wav
  - client/public/soundeffects/lose_1.wav
  - client/public/soundeffects/fire_1.wav
  - client/public/soundeffects/fire_2.wav
  - client/public/soundeffects/fire_3.wav
autonomous: true
requirements:
  - AUD-01
  - AUD-02
  - AUD-03

must_haves:
  truths:
    - "AudioManager supports crossfade between two music tracks with configurable duration"
    - "AudioManager supports loop-with-pause for lobby music (ended event + setTimeout restart)"
    - "AudioManager supports temporary volume dip and restore for stage transitions"
    - "AudioManager supports playing a random WAV from a set of variants"
    - "AudioManager supports playing multiple WAV files simultaneously"
    - "All 22 WAV SFX files are copied to client/public/soundeffects/ and registered in BootScene"
    - "All 6 MP3 music tracks are copied to client/public/audio/ subdirectories"
  artifacts:
    - path: "client/src/systems/AudioManager.ts"
      provides: "Extended audio system with crossfade, loop-with-pause, volume dip, random WAV, multi WAV"
      contains: "crossfadeTo"
    - path: "client/src/scenes/BootScene.ts"
      provides: "WAV SFX registration for all new sound effects"
      contains: "registerWAV"
  key_links:
    - from: "client/src/scenes/BootScene.ts"
      to: "client/src/systems/AudioManager.ts"
      via: "registerWAV calls for all 22 WAV files"
      pattern: "registerWAV\\("
---

<objective>
Extend AudioManager with crossfade, loop-with-pause, volume dip, and WAV randomization methods. Copy all audio assets to client/public/ and register all WAV SFX in BootScene.

Purpose: Provide the audio infrastructure that Plan 03 will use to wire music and SFX into all game scenes. Separating infrastructure from integration keeps both plans focused.
Output: Extended AudioManager with 7 new methods, 22 WAV files + 6 MP3 tracks in client/public/, all WAVs registered in BootScene.
</objective>

<execution_context>
@/Users/jonasbrandvik/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jonasbrandvik/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/11-minimap-music/11-RESEARCH.md
@client/src/systems/AudioManager.ts
@client/src/scenes/BootScene.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Copy audio assets to client/public/ and extend AudioManager</name>
  <files>
    client/src/systems/AudioManager.ts
    client/public/audio/lobby/
    client/public/audio/stage/
    client/public/audio/gameover/
    client/public/soundeffects/
  </files>
  <action>
  **Step 1: Copy all audio assets from assets/ to client/public/.**

  Create directories and copy files:
  - `assets/soundtrack/lobby/Pixel Jitter Jive.mp3` -> `client/public/audio/lobby/Pixel Jitter Jive.mp3`
  - `assets/soundtrack/stage/Forest Deco Run.mp3` -> `client/public/audio/stage/Forest Deco Run.mp3`
  - `assets/soundtrack/stage/Art Deco Forest Arena.mp3` -> `client/public/audio/stage/Art Deco Forest Arena.mp3`
  - `assets/soundtrack/stage/Per Ropar Glas (Remastered v2).mp3` -> `client/public/audio/stage/Per Ropar Glas (Remastered v2).mp3`
  - `assets/soundtrack/gameover/victory.mp3` -> `client/public/audio/gameover/victory.mp3`
  - `assets/soundtrack/gameover/defeat.mp3` -> `client/public/audio/gameover/defeat.mp3`
  - Copy all WAV files from `assets/soundeffects/` to `client/public/soundeffects/` (hurt_1-4, laser_1/4/5, earthquake, lightning, disappear, select_1/2, lose_1, fire_1/2/3). The existing `powerup_1.wav` is already there.

  **Step 2: Extend AudioManager with 7 new methods.**

  Add these methods to the AudioManager class in `client/src/systems/AudioManager.ts`:

  1. `crossfadeTo(src: string, loop: boolean = true, fadeDuration: number = 1000): void`
     - Creates new Audio element, starts at volume 0, begins playback.
     - If `currentMusic` exists: fade it out to 0 over `fadeDuration` ms, simultaneously fade new track from 0 to `this.musicVolume`.
     - If no current music: just fade in the new track.
     - On old track fade complete: pause + null it.
     - Store the new Audio as `this.currentMusic`.

  2. `fadeOutMusic(duration: number = 500, onComplete?: () => void): void`
     - Fades `currentMusic` from current volume to 0 over `duration` ms.
     - On complete: pause, null currentMusic, call onComplete callback.

  3. `playMusicWithPause(src: string, pauseMs: number = 1000): void`
     - Calls `stopMusic()` first.
     - Creates new Audio, sets volume to `this.musicVolume`, loop=false.
     - Adds 'ended' event listener that: checks if `this.currentMusic === audio` (stale guard), then `setTimeout` to restart (currentTime=0, play()) after `pauseMs`.
     - Starts playback, sets as `this.currentMusic`.

  4. `dipMusicVolume(factor: number = 0.3): void`
     - If `currentMusic`: set `currentMusic.volume = this.musicVolume * factor`.
     - Store the factor in a `private volumeDipFactor: number | null = null` field.

  5. `restoreMusicVolume(): void`
     - If `currentMusic`: set `currentMusic.volume = this.musicVolume`.
     - Clear `volumeDipFactor = null`.

  6. `playRandomWAV(keys: string[]): void`
     - Pick a random key from the array.
     - Call `this.playWAVSFX(key)`.

  7. `playMultipleWAV(keys: string[]): void`
     - For each key, call `this.playWAVSFX(key)`.

  Add a private helper method:
  ```typescript
  private fadeVolume(
    audio: HTMLAudioElement,
    from: number, to: number,
    duration: number,
    onComplete?: () => void
  ): void
  ```
  Uses `setInterval(50ms)` to ramp volume linearly from `from` to `to` over `duration` ms. Clears interval on completion and calls onComplete.

  Add private field: `private volumeDipFactor: number | null = null;`

  **Important:** In `setMusicVolume()`, after updating `this.musicVolume`, also check `volumeDipFactor` -- if it's non-null, set `currentMusic.volume = this.musicVolume * volumeDipFactor` instead of raw `this.musicVolume`. This ensures volume slider changes during a dip still respect the dip factor.

  Also update `destroy()` to clear `volumeDipFactor`.
  </action>
  <verify>
  - Verify all audio files exist in client/public/: `ls client/public/audio/lobby/ client/public/audio/stage/ client/public/audio/gameover/ client/public/soundeffects/`
  - Verify AudioManager.ts compiles: `cd client && npx tsc --noEmit src/systems/AudioManager.ts`
  - Verify all 7 new methods exist: grep for `crossfadeTo`, `fadeOutMusic`, `playMusicWithPause`, `dipMusicVolume`, `restoreMusicVolume`, `playRandomWAV`, `playMultipleWAV` in AudioManager.ts
  </verify>
  <done>
  AudioManager has 7 new methods (crossfadeTo, fadeOutMusic, playMusicWithPause, dipMusicVolume, restoreMusicVolume, playRandomWAV, playMultipleWAV). All audio assets are copied to client/public/ in correct subdirectories.
  </done>
</task>

<task type="auto">
  <name>Task 2: Register all WAV SFX in BootScene</name>
  <files>client/src/scenes/BootScene.ts</files>
  <action>
  In BootScene `create()`, after the existing `audioManager.registerWAV('powerup_pickup', 'soundeffects/powerup_1.wav')` line, add registrations for all new WAV files:

  ```typescript
  // Hurt variants (player damage + Paran wall collision)
  audioManager.registerWAV('hurt_1', 'soundeffects/hurt_1.wav');
  audioManager.registerWAV('hurt_2', 'soundeffects/hurt_2.wav');
  audioManager.registerWAV('hurt_3', 'soundeffects/hurt_3.wav');
  audioManager.registerWAV('hurt_4', 'soundeffects/hurt_4.wav');

  // Guardian fire variants
  audioManager.registerWAV('laser_1', 'soundeffects/laser_1.wav');
  audioManager.registerWAV('laser_4', 'soundeffects/laser_4.wav');
  audioManager.registerWAV('laser_5', 'soundeffects/laser_5.wav');

  // Paran power shot (weapon powerup)
  audioManager.registerWAV('earthquake', 'soundeffects/earthquake.wav');
  audioManager.registerWAV('lightning', 'soundeffects/lightning.wav');

  // Player killed
  audioManager.registerWAV('disappear', 'soundeffects/disappear.wav');

  // Menu navigation
  audioManager.registerWAV('select_1', 'soundeffects/select_1.wav');
  audioManager.registerWAV('select_2', 'soundeffects/select_2.wav');

  // Defeat sting
  audioManager.registerWAV('lose_1', 'soundeffects/lose_1.wav');

  // Firework SFX (victory screen)
  audioManager.registerWAV('fire_1', 'soundeffects/fire_1.wav');
  audioManager.registerWAV('fire_2', 'soundeffects/fire_2.wav');
  audioManager.registerWAV('fire_3', 'soundeffects/fire_3.wav');
  ```

  That's 16 new WAV registrations (total 17 including the existing powerup_pickup).

  **Do NOT modify any existing code in BootScene** -- just add the new registerWAV calls after the existing one.
  </action>
  <verify>
  - Count registerWAV calls in BootScene: `grep -c 'registerWAV' client/src/scenes/BootScene.ts` should return 17
  - Verify BootScene compiles: `cd client && npx tsc --noEmit src/scenes/BootScene.ts`
  </verify>
  <done>
  All 16 new WAV SFX files registered in BootScene alongside the existing powerup_pickup registration. Keys match the file names for easy reference in scene code.
  </done>
</task>

</tasks>

<verification>
1. All audio files exist in client/public/:
   - `client/public/audio/lobby/Pixel Jitter Jive.mp3`
   - `client/public/audio/stage/` (3 MP3 files)
   - `client/public/audio/gameover/` (2 MP3 files)
   - `client/public/soundeffects/` (17 WAV files including existing powerup_1.wav)
2. AudioManager.ts has all 7 new public methods
3. BootScene.ts registers all 17 WAV keys
4. Both files compile without TypeScript errors
</verification>

<success_criteria>
AudioManager extended with crossfade, loop-with-pause, volume dip, WAV randomization, and multi-WAV methods. All audio assets copied to client/public/. All WAV SFX registered in BootScene. No existing functionality broken.
</success_criteria>

<output>
After completion, create `.planning/phases/11-minimap-music/11-01-SUMMARY.md`
</output>
