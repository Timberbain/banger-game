---
phase: 06-ux-polish
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - server/src/rooms/GameRoom.ts
  - server/src/schema/GameState.ts
  - client/src/main.ts
  - client/package.json
autonomous: true

must_haves:
  truths:
    - "Match ends after 5 minutes with guardians winning by timeout"
    - "Server broadcasts kill events with killer/victim/role data"
    - "Client can measure round-trip ping to server"
    - "Phaser config has pixelArt: true for crisp rendering"
    - "jsfxr is installed as client dependency"
  artifacts:
    - path: "server/src/rooms/GameRoom.ts"
      provides: "Match timer enforcement, kill broadcast, ping handler"
      contains: "MATCH_DURATION_MS"
    - path: "server/src/schema/GameState.ts"
      provides: "No new schema fields needed (timer uses existing serverTime/matchStartTime)"
    - path: "client/src/main.ts"
      provides: "pixelArt config, HUDScene and HelpScene in scene array"
      contains: "pixelArt: true"
    - path: "client/package.json"
      provides: "jsfxr dependency"
      contains: "jsfxr"
  key_links:
    - from: "server/src/rooms/GameRoom.ts"
      to: "client (kill feed)"
      via: "broadcast('kill')"
      pattern: "this\\.broadcast\\(\"kill\""
    - from: "server/src/rooms/GameRoom.ts"
      to: "client (ping)"
      via: "onMessage('ping') -> client.send('pong')"
      pattern: "onMessage\\(.*ping"
---

<objective>
Add server-side match timer (5 min, guardians win on timeout), kill event broadcasting, ping/pong handler, and prepare client config for pixel art rendering and new scenes.

Purpose: Foundation changes that all other Phase 6 plans depend on. The match timer changes win conditions (gameplay impact), kill broadcast enables the kill feed HUD, ping handler enables connection quality display, and pixelArt config is required before any sprite assets are loaded.

Output: Updated GameRoom with timer/kill/ping, updated Phaser config with pixelArt + scene stubs, jsfxr installed.
</objective>

<execution_context>
@/Users/jonasbrandvik/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jonasbrandvik/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ux-polish/06-RESEARCH.md
@server/src/rooms/GameRoom.ts
@server/src/schema/GameState.ts
@client/src/main.ts
@shared/characters.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Server match timer, kill broadcast, and ping handler</name>
  <files>server/src/rooms/GameRoom.ts</files>
  <action>
    Add three server-side features to GameRoom.ts:

    1. **Match timer (5 minutes):**
       - Add constant `MATCH_DURATION_MS = 5 * 60 * 1000` (300000ms) at top of file.
       - In `fixedTick()`, after incrementing `serverTime`, check if `this.state.serverTime - this.state.matchStartTime >= MATCH_DURATION_MS`.
       - If elapsed, call `this.endMatch("guardians")`. This forces aggressive Paran play per user decision.
       - Add this check BEFORE processing player inputs (early return after endMatch).

    2. **Kill event broadcast:**
       - Wherever a kill occurs (there are 3 locations: projectile kill, Paran contact kill, and potentially player leave), add `this.broadcast("kill", { killer, victim, killerRole, victimRole })` using player names (not sessionIds) for display.
       - For projectile kills: in the projectile collision section where `wasAlive && isDead`, broadcast with `killer = shooter.name`, `victim = target.name`, `killerRole = shooter.role`, `victimRole = target.role`. Get the shooter player via `this.state.players.get(proj.ownerId)`.
       - For Paran contact kills: in the contact kill section where `target.health = 0`, broadcast with killer = paran name, victim = target name.
       - Do NOT broadcast for player leave disconnection deaths.

    3. **Ping/pong handler:**
       - In `onCreate()`, add `this.onMessage('ping', (client, data) => { client.send('pong', { t: data.t }); });`
       - Simple timestamp echo -- client computes RTT from `Date.now() - data.t`.
  </action>
  <verify>
    Run `cd /Users/jonasbrandvik/Projects/banger-game/server && npx tsc --noEmit` to verify TypeScript compiles.
    Grep for "MATCH_DURATION_MS", "broadcast(\"kill\"", and "onMessage('ping'" in GameRoom.ts.
  </verify>
  <done>
    GameRoom enforces 5-minute time limit with guardian timeout win. Kill events are broadcast with killer/victim names and roles. Ping handler echoes client timestamps for RTT measurement.
  </done>
</task>

<task type="auto">
  <name>Task 2: Client config, scene stubs, and jsfxr dependency</name>
  <files>client/src/main.ts, client/package.json, client/src/scenes/HUDScene.ts, client/src/scenes/HelpScene.ts</files>
  <action>
    1. **Install jsfxr:**
       - Run `cd /Users/jonasbrandvik/Projects/banger-game/client && npm install jsfxr`

    2. **Update Phaser config in client/src/main.ts:**
       - Add `pixelArt: true` to the game config object (at the same level as `type`, `width`, etc.). This enables nearest-neighbor filtering and roundPixels globally for crisp pixel art.
       - Add `HUDScene` and `HelpScene` to the `scene` array: `[BootScene, LobbyScene, GameScene, HUDScene, VictoryScene, HelpScene]`
       - Add the imports: `import { HUDScene } from './scenes/HUDScene';` and `import { HelpScene } from './scenes/HelpScene';`

    3. **Create HUDScene stub (client/src/scenes/HUDScene.ts):**
       - Minimal scene class with `constructor() { super({ key: 'HUDScene' }); }` and empty `create()` and `update()` methods.
       - In `create()`, add `this.cameras.main.setBackgroundColor('rgba(0,0,0,0)');` for transparency (per pitfall #2 from research).
       - This is a STUB -- full implementation comes in Plan 03.

    4. **Create HelpScene stub (client/src/scenes/HelpScene.ts):**
       - Minimal scene class with `constructor() { super({ key: 'HelpScene' }); }` and empty `create()`.
       - This is a STUB -- full implementation comes in Plan 06.
  </action>
  <verify>
    Run `cd /Users/jonasbrandvik/Projects/banger-game/client && npx tsc --noEmit` to verify TypeScript compiles.
    Verify `pixelArt: true` exists in main.ts config.
    Verify jsfxr is in package.json dependencies.
  </verify>
  <done>
    Phaser config has pixelArt: true for crisp rendering. HUDScene and HelpScene registered in scene array (stubs). jsfxr installed for procedural SFX generation.
  </done>
</task>

</tasks>

<verification>
1. Server compiles without errors: `cd server && npx tsc --noEmit`
2. Client compiles without errors: `cd client && npx tsc --noEmit`
3. GameRoom has MATCH_DURATION_MS constant set to 300000
4. GameRoom broadcasts "kill" events on projectile and contact kills
5. GameRoom responds to "ping" messages with "pong"
6. client/src/main.ts has `pixelArt: true` in config
7. HUDScene.ts and HelpScene.ts exist as scene stubs
8. jsfxr is in client/package.json dependencies
</verification>

<success_criteria>
Server enforces 5-minute match timer. Kill broadcasts and ping handler are functional. Client is configured for pixel art rendering with all new scenes registered. jsfxr is installed and ready for audio plan.
</success_criteria>

<output>
After completion, create `.planning/phases/06-ux-polish/06-01-SUMMARY.md`
</output>
