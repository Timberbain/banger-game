---
phase: 06-ux-polish
plan: 03
type: execute
wave: 3
depends_on: ["06-01", "06-02"]
files_modified:
  - client/src/scenes/HUDScene.ts
  - client/src/scenes/GameScene.ts
autonomous: true

must_haves:
  truths:
    - "HUD displays all 3 player health bars along the bottom of the screen"
    - "Local player health bar is highlighted/larger than others"
    - "Match timer displays at top center with MM:SS format"
    - "Timer turns red and flashes in the last 30 seconds"
    - "Kill feed appears in top-right corner showing recent eliminations"
    - "Cooldown display shows visual timer that fills up after firing"
    - "Ping displays as actual ms value in the HUD"
    - "Role identity banner shows at match start ('YOU ARE PARAN' etc.)"
    - "HUD has a subtle role reminder visible during gameplay"
    - "Spectator HUD shows who you are spectating"
  artifacts:
    - path: "client/src/scenes/HUDScene.ts"
      provides: "Complete HUD overlay scene with health bars, timer, kill feed, cooldown, ping, role identity"
      contains: "class HUDScene"
    - path: "client/src/scenes/GameScene.ts"
      provides: "HUD scene launch and cross-scene event emission"
      contains: "scene.launch.*HUDScene"
  key_links:
    - from: "client/src/scenes/GameScene.ts"
      to: "client/src/scenes/HUDScene.ts"
      via: "scene.launch('HUDScene', data) + Phaser events"
      pattern: "scene\\.launch.*HUDScene"
    - from: "client/src/scenes/HUDScene.ts"
      to: "room.state"
      via: "room.state.players health listening"
      pattern: "room\\.state\\.players"
    - from: "client/src/scenes/HUDScene.ts"
      to: "room.onMessage('kill')"
      via: "kill feed entries from server broadcast"
      pattern: "onMessage.*kill"
---

<objective>
Implement the complete HUD Scene overlay with health bars, match timer, kill feed, cooldown display, ping indicator, role identity, and spectator HUD.

Purpose: The HUD is the primary information display for gameplay. It replaces the removed floating health bars with a corner-based layout, adds time pressure via the match timer, provides combat awareness via kill feed, and shows connection quality.

Output: Fully functional HUDScene launched in parallel with GameScene.
</objective>

<execution_context>
@/Users/jonasbrandvik/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jonasbrandvik/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ux-polish/06-RESEARCH.md
@.planning/phases/06-ux-polish/06-01-SUMMARY.md
@.planning/phases/06-ux-polish/06-02-SUMMARY.md
@client/src/scenes/GameScene.ts
@client/src/scenes/HUDScene.ts
@server/src/schema/GameState.ts
@shared/characters.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement HUDScene with all HUD elements</name>
  <files>client/src/scenes/HUDScene.ts</files>
  <action>
    Replace the stub HUDScene with full implementation. The scene receives `{ room, localSessionId, localRole }` in create data.

    **Reset pattern (from Phase 5 learnings):** Reset ALL member variables at the top of create() since scene.start() skips constructor.

    **Transparent background:** `this.cameras.main.setBackgroundColor('rgba(0,0,0,0)')` (pitfall #2).

    **1. Health bars (bottom of screen, per user decision):**
    - All 3 player health bars along the bottom (y ~570).
    - Layout: 3 horizontal bars spaced evenly. Local player's bar is larger (200x16 px) and centered. Other two bars smaller (140x12 px) flanking.
    - Each bar has: background (dark red), foreground (color based on role), label showing player name + role.
    - Colors: paran=#ff4444, faran=#4488ff, baran=#44cc66.
    - Update every frame by iterating `room.state.players` and reading health values.
    - Low health effect: when health < 25% of maxHealth, flash the bar (toggle alpha between 0.5 and 1.0 every 300ms).

    **2. Match timer (top center, per user decision):**
    - Display remaining time as `M:SS` at position (400, 20), centered.
    - Compute: `remaining = max(0, MATCH_DURATION_MS - (serverTime - matchStartTime))` where MATCH_DURATION_MS = 300000.
    - Format: `Math.floor(remaining/60000)` + `:` + `Math.floor((remaining%60000)/1000).padStart(2,'0')`.
    - Low-time warning (last 30s): set text color to #ff0000 and flash alpha between 0.5 and 1.0 every 500ms. No audio cue per user decision.
    - Only show timer when matchState === 'playing'.

    **3. Kill feed (top-right corner, Claude's discretion on design):**
    - Right-aligned text entries at x=790, starting y=60.
    - Listen to `room.onMessage('kill', data => ...)`.
    - Format: `[KillerName] > [VictimName]` with killer name colored by role.
    - Max 4 visible entries. Each fades out after 5 seconds.
    - Semi-transparent dark background on each entry (backgroundColor: '#00000088').
    - New entries push down existing ones.

    **4. Cooldown display (near local player health bar):**
    - Small circular or bar indicator next to the local player's health bar.
    - Track cooldown client-side: listen for `localFired` event from GameScene.
    - When fired: record fireTime and cooldownMs. Each frame: compute progress = min(1, elapsed/cooldownMs).
    - Render as a small rectangle (40x6px) that fills from left to right, above the local health bar.
    - When full (progress >= 1): show green. When not ready: show yellow filling.

    **5. Ping display (top-right corner, below timer or near kill feed):**
    - Show `XXms` text at top-right (x=780, y=20), right-aligned.
    - Start a ping interval: every 2000ms, send `room.send('ping', { t: Date.now() })`.
    - Listen for `room.onMessage('pong', data => { this.currentPing = Date.now() - data.t; })`.
    - Color: green (<50ms), yellow (50-100ms), red (>100ms).
    - Clean up interval on scene shutdown.

    **6. Role identity banner (match start):**
    - On create, show a large centered text: "YOU ARE {ROLE}" (e.g., "YOU ARE PARAN") with role color.
    - Font size 48px, bold, with stroke for readability.
    - Fade out after 3 seconds using tween (alpha 1 -> 0 over 1s after 2s delay).
    - Subtle HUD reminder: small text in top-left corner showing role name (e.g., "Paran" in role color, fontSize 14px) permanently.

    **7. Spectator HUD (Claude's discretion on layout):**
    - When local player is dead and spectating, show bottom bar: "SPECTATING: [PlayerName] ([Role])" in white, centered.
    - Show "Press TAB to cycle" instruction below it.
    - Listen for GameScene events to detect spectator mode changes and target changes.
    - Show the spectated player's health bar prominently (center-bottom, same as local player bar).

    **8. Match countdown (3... 2... 1... FIGHT!):**
    - On match start (detect via room.state.listen('matchState')), show big centered countdown.
    - "3" (1s) -> "2" (1s) -> "1" (1s) -> "FIGHT!" (fades out after 1s).
    - Large font (72px), bold, white with black stroke.
    - Actually, the match starts when 3 players join -- there's no separate countdown in GameRoom. So trigger this when matchState changes to 'playing'. Show "FIGHT!" for 2 seconds then fade.

    **Cross-scene communication:** GameScene emits:
    - `localFired` event with `{ fireTime, cooldownMs }` when local player fires
    - `spectatorChanged` event with `{ targetName, targetRole }` when spectator target changes
    - `localDied` event when local player dies

    **Cleanup:** On scene shutdown, clear the ping interval, destroy all game objects, remove event listeners from GameScene.
  </action>
  <verify>
    Run `cd /Users/jonasbrandvik/Projects/banger-game/client && npx tsc --noEmit` to verify TypeScript compiles.
    Verify HUDScene has health bar rendering, timer computation, kill feed listener, cooldown display, ping measurement, and role banner.
  </verify>
  <done>
    HUDScene displays all required HUD elements: health bars at bottom (local highlighted), match timer at top center with low-time warning, kill feed at top-right, cooldown indicator, ping display in ms, role identity banner at match start, and spectator HUD.
  </done>
</task>

<task type="auto">
  <name>Task 2: Launch HUDScene from GameScene and emit cross-scene events</name>
  <files>client/src/scenes/GameScene.ts</files>
  <action>
    **1. Launch HUDScene after room connection:**
    In GameScene.create(), after the room is connected and the first state change is received (inside the `onStateChange.once` callback, after tilemap creation), launch the HUD scene:
    ```typescript
    this.scene.launch('HUDScene', {
      room: this.room,
      localSessionId: this.room.sessionId,
      localRole: this.localRole
    });
    ```
    Note: localRole may not be known at this point -- it's set in the onAdd handler. Adjust: launch HUDScene from the onAdd handler when the local player is detected and role is known. Check that HUDScene isn't already launched (guard with a flag).

    **2. Emit cross-scene events:**
    - In the fire input section (where `input.fire` is true and input is sent to server), emit:
      ```typescript
      this.events.emit('localFired', {
        fireTime: Date.now(),
        cooldownMs: CHARACTERS[this.localRole].fireRate
      });
      ```
    - Track a `lastLocalFireTime` member variable. Only emit if `Date.now() - this.lastLocalFireTime >= cooldownMs` (client-side approximation). Update `lastLocalFireTime` on each emit.

    - When spectator target changes (in the Tab key handler and when entering spectator mode), emit:
      ```typescript
      const targetPlayer = this.room.state.players.get(this.spectatorTarget);
      this.events.emit('spectatorChanged', {
        targetName: targetPlayer?.name || 'Unknown',
        targetRole: targetPlayer?.role || 'unknown'
      });
      ```

    - When local player dies (in handlePlayerChange when health reaches 0), emit:
      ```typescript
      this.events.emit('localDied');
      ```

    **3. Stop HUDScene on match end:**
    In the matchEnd handler, after launching VictoryScene, stop HUDScene: `this.scene.stop('HUDScene');`

    **4. Stop HUDScene on return to lobby:**
    In `returnToLobby()`, stop HUDScene before starting LobbyScene.

    **5. Handle reconnection:**
    In `attachRoomListeners()`, re-launch HUDScene if it was stopped during disconnection.
  </action>
  <verify>
    Run `cd /Users/jonasbrandvik/Projects/banger-game/client && npx tsc --noEmit` to verify TypeScript compiles.
    Grep for `scene.launch.*HUDScene` in GameScene.ts.
    Grep for `events.emit.*localFired` in GameScene.ts.
  </verify>
  <done>
    HUDScene launches alongside GameScene with room data. Cross-scene events enable cooldown tracking, spectator HUD updates, and death notification. HUDScene properly stopped on match end and lobby return.
  </done>
</task>

</tasks>

<verification>
1. Client compiles without errors
2. HUDScene is launched from GameScene after room connection
3. Health bars render at bottom of screen for all 3 players
4. Match timer shows at top center with MM:SS format
5. Kill feed shows elimination messages from server broadcast
6. Cooldown bar fills up after firing
7. Ping shows actual ms value
8. Role banner appears at match start and fades
9. Spectator HUD shows when dead
10. HUDScene stops on match end
</verification>

<success_criteria>
Complete HUD overlay running in parallel with GameScene. All health bars visible at bottom, timer at top center with low-time warning, kill feed working, cooldown display tracking fire rate, ping measurement functional, role identity clear, spectator mode info displayed.
</success_criteria>

<output>
After completion, create `.planning/phases/06-ux-polish/06-03-SUMMARY.md`
</output>
