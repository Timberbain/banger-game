---
phase: 06-ux-polish
plan: 04
type: execute
wave: 3
depends_on: ["06-02"]
files_modified:
  - client/src/systems/ParticleFactory.ts
  - client/src/scenes/GameScene.ts
autonomous: true

must_haves:
  truths:
    - "Damage causes sprite flash (white/red) and particle burst at impact point"
    - "Death triggers explosion of particles in player's color"
    - "Projectiles have short fading trails behind them"
    - "Paran wall collision creates impact particles at the wall"
    - "Paran at high speed shows speed lines effect"
    - "Projectile wall impacts create small spark/dust particles"
    - "Victory/defeat shows big banner with particle effects"
  artifacts:
    - path: "client/src/systems/ParticleFactory.ts"
      provides: "Reusable particle effect presets for all game events"
      contains: "class ParticleFactory"
    - path: "client/src/scenes/GameScene.ts"
      provides: "Sprite flash on damage, particle triggers, projectile trails, speed lines"
      contains: "ParticleFactory"
  key_links:
    - from: "client/src/scenes/GameScene.ts"
      to: "client/src/systems/ParticleFactory.ts"
      via: "ParticleFactory method calls on game events"
      pattern: "particleFactory\\."
    - from: "client/src/systems/ParticleFactory.ts"
      to: "particle texture"
      via: "this.scene.add.particles(x, y, 'particle', config)"
      pattern: "add\\.particles.*particle"
---

<objective>
Implement all visual feedback effects: sprite flash on damage, particle bursts (hit, death, wall impact, projectile impact), projectile trails, Paran speed lines, and victory/defeat effects.

Purpose: Visual "juice" that makes the game feel responsive and impactful. Every combat event gets visual confirmation without screen shake (per user decision).

Output: ParticleFactory system and all visual effects integrated into GameScene.
</objective>

<execution_context>
@/Users/jonasbrandvik/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jonasbrandvik/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-ux-polish/06-RESEARCH.md
@.planning/phases/06-ux-polish/06-02-SUMMARY.md
@client/src/scenes/GameScene.ts
@client/src/systems/ParticleFactory.ts
@shared/characters.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create ParticleFactory with all effect presets</name>
  <files>client/src/systems/ParticleFactory.ts</files>
  <action>
    Create a centralized ParticleFactory class that provides one-shot particle effects for all game events. All effects use the 'particle' texture (8x8 white circle) tinted at runtime.

    Use Phaser 3.60+ particle API: `this.scene.add.particles(x, y, 'particle', config)` with `emitting: false` + `explode()` for one-shot bursts. Auto-destroy emitters after lifespan.

    **Methods to implement:**

    1. `hitBurst(x, y, tint)` -- Damage impact:
       - 8 particles, speed 50-150, lifespan 300ms, scale 1->0, gravity 100.
       - Auto-destroy after 500ms.

    2. `deathExplosion(x, y, playerColor)` -- Player death:
       - 20 particles, speed 80-250, lifespan 600ms, scale 1.5->0, gravity 200, full 360 angle.
       - Auto-destroy after 800ms.

    3. `wallImpact(x, y)` -- Paran wall collision:
       - 6 particles, tint #888888 (gray/dust), speed 30-80, lifespan 200ms, scale 0.5->0.
       - Auto-destroy after 400ms.

    4. `projectileImpact(x, y, tint)` -- Projectile hitting wall:
       - 4 particles, speed 30-60, lifespan 150ms, scale 0.3->0, spark-like.
       - Auto-destroy after 300ms.

    5. `createTrail(followTarget)` -- Projectile trail:
       - Returns an emitter that follows the target sprite.
       - Continuous emission (frequency 30ms), lifespan 200ms, speed 0, scale 0.5->0, alpha 0.6->0.
       - Tint set by caller. Caller must destroy when projectile is removed.

    6. `speedLines(x, y, angle)` -- Paran high speed effect:
       - 3 particles emitted in the opposite direction of movement.
       - Speed 100-200, lifespan 150ms, scale 0.3->0, alpha 0.4->0, tint #ffffff.
       - Called per frame when Paran velocity magnitude exceeds a threshold (e.g., 200).
       - Use emitting:false + explode(3) for per-frame control.

    7. `victoryBurst(x, y, color)` -- Victory celebration:
       - 30 particles, speed 100-300, lifespan 1000ms, scale 2->0, full angle, gravity 150.
       - Auto-destroy after 1200ms.

    **Constructor:** Takes `scene: Phaser.Scene` and stores reference.

    **Cleanup:** Add `destroy()` method that clears any active trail emitters (stored in a Set).
  </action>
  <verify>
    Run `cd /Users/jonasbrandvik/Projects/banger-game/client && npx tsc --noEmit` to verify TypeScript compiles.
    Verify all 7 particle methods exist in ParticleFactory.
  </verify>
  <done>
    ParticleFactory provides reusable one-shot and continuous particle effects for hit feedback, death, wall impacts, projectile trails, speed lines, and victory effects.
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate visual effects into GameScene</name>
  <files>client/src/scenes/GameScene.ts</files>
  <action>
    Add ParticleFactory and all visual feedback to GameScene.

    **1. Initialize ParticleFactory:**
    - Add member: `private particleFactory: ParticleFactory | null = null;`
    - In create() after tilemap loads, initialize: `this.particleFactory = new ParticleFactory(this);`
    - Reset to null at top of create().

    **2. Damage sprite flash (on health decrease):**
    In `handlePlayerChange()`, detect health decrease:
    - Track previous health per player in a Map: `private prevHealth: Map<string, number> = new Map();`
    - When `player.health < prevHealth`: the player took damage.
      - Flash the sprite white for 100ms then red for 100ms: `sprite.setTintFill(0xffffff)` -> delayedCall 100ms -> `sprite.setTint(0xff0000)` -> delayedCall 100ms -> `sprite.clearTint()`.
      - Trigger `particleFactory.hitBurst(sprite.x, sprite.y, roleColor)` where roleColor maps to the damaged player's role color.
    - Update `prevHealth.set(sessionId, player.health)`.

    **3. Death explosion:**
    In `handlePlayerChange()`, when `player.health <= 0` AND the player was previously alive:
    - Trigger `particleFactory.deathExplosion(sprite.x, sprite.y, roleColor)`.
    - The death animation from Plan 02 already handles sprite visual.

    **4. Projectile trails:**
    In `projectiles.onAdd()`:
    - Get the owner's role from `this.room.state.players.get(projectile.ownerId)?.role`.
    - Map role to trail color: paran=#d4a746 (gold), faran=#4488ff (blue), baran=#44cc66 (green).
    - Create trail: `const trail = this.particleFactory.createTrail(sprite);` with appropriate tint.
    - Store trail in a Map: `private projectileTrails: Map<number, Phaser.GameObjects.Particles.ParticleEmitter> = new Map();`
    In `projectiles.onRemove()`:
    - Destroy the trail emitter and remove from map.
    - Trigger `particleFactory.projectileImpact(sprite.x, sprite.y, projectileColor)` at the last known position.

    **5. Paran wall collision particles:**
    Detect wall collision from client prediction: in PredictionSystem, after resolveCollisions, if result.hitX || result.hitY for paran role, emit an event or set a flag.
    Simpler approach: In GameScene update(), for the local paran player, detect velocity going to zero (predictionState.vx was non-zero last frame, is now zero). When this happens and the player is paran:
    - Trigger `particleFactory.wallImpact(sprite.x, sprite.y)`.
    - Track `prevPredictionVx` and `prevPredictionVy` to detect the stop.

    **6. Paran speed lines:**
    In GameScene update(), for the local paran player, compute velocity magnitude:
    ```
    const speed = Math.sqrt(vx*vx + vy*vy);
    if (speed > 200 && this.particleFactory) {
      const angle = Math.atan2(vy, vx);
      this.particleFactory.speedLines(sprite.x, sprite.y, angle);
    }
    ```
    Rate-limit to every 3 frames to avoid particle spam.

    **7. Victory/defeat effects:**
    In the matchEnd handler, before launching VictoryScene, trigger victory particles:
    ```
    const didWin = (winner matches local role);
    const color = didWin ? 0x00ff00 : 0xff0000;
    this.particleFactory.victoryBurst(400, 300, color);
    ```
    Also add particles to VictoryScene if desired (but VictoryScene is an overlay so GameScene particles will be visible underneath).

    **8. Cleanup:**
    - Reset `prevHealth`, `projectileTrails`, and `particleFactory` in create().
    - Destroy particleFactory in scene shutdown/cleanup.
  </action>
  <verify>
    Run `cd /Users/jonasbrandvik/Projects/banger-game/client && npx tsc --noEmit` to verify TypeScript compiles.
    Grep for "particleFactory" in GameScene.ts to verify integration.
    Verify damage flash logic exists in handlePlayerChange.
  </verify>
  <done>
    All visual feedback effects are integrated: sprite flash on damage, particle burst at impact, death explosion, projectile trails, wall impact particles, Paran speed lines, and victory/defeat effects. No screen shake (per user decision).
  </done>
</task>

</tasks>

<verification>
1. Client compiles without errors
2. ParticleFactory has all 7 effect methods
3. GameScene creates ParticleFactory and calls effects on game events
4. Damage flash (white -> red -> clear) triggers on health decrease
5. Death explosion triggers on player death
6. Projectile trails follow projectile sprites
7. Wall impact particles trigger on Paran wall collision
8. Speed lines show at high Paran velocity
9. No screen shake on any impacts (per user decision)
</verification>

<success_criteria>
Every combat and movement event has appropriate visual feedback. Hits produce sprite flash + particle burst, deaths trigger explosions, projectiles leave trails, wall impacts show dust particles, fast Paran gets speed lines, and match end has celebration particles.
</success_criteria>

<output>
After completion, create `.planning/phases/06-ux-polish/06-04-SUMMARY.md`
</output>
