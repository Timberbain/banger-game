---
phase: 05-multiplayer-lobbies
plan: 08
type: execute
wave: 1
depends_on: []
files_modified:
  - client/src/scenes/LobbyScene.ts
  - server/src/rooms/LobbyRoom.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "All alphanumeric characters (including D, S, W, A) can be typed in room code input"
    - "No character panel is pre-highlighted when joining a new lobby"
    - "Players can click their selected character to deselect it, freeing the role for others"
    - "Browser refresh during lobby reconnects to same lobby (not 'Room not found')"
    - "Browser refresh during active match retries long enough to outlast server ping timeout"
    - "joinPrivateRoom shows actual error (room full vs not found) instead of generic message"
  artifacts:
    - path: "client/src/scenes/LobbyScene.ts"
      provides: "Keyboard disable on input focus, selectedRole reset, deselect toggle, lobby token storage, retry params, better errors"
    - path: "server/src/rooms/LobbyRoom.ts"
      provides: "deselectRole message handler"
  key_links:
    - from: "client/src/scenes/LobbyScene.ts"
      to: "server/src/rooms/LobbyRoom.ts"
      via: "deselectRole message"
      pattern: "send\\('deselectRole'"
    - from: "client/src/scenes/LobbyScene.ts"
      to: "localStorage"
      via: "bangerLobbyRoom token"
      pattern: "localStorage\\.(set|get|remove)Item\\('bangerLobbyRoom'"
---

<objective>
Fix 4 diagnosed UAT gaps in lobby flow: (1) Phaser keyboard capture blocks room code input keys, (2) stale selectedRole causes false character highlight, (3) character deselect never implemented, (4) lobby reconnection token not stored so refresh loses seat, (5) game reconnection retry window too short for server ping timeout, (6) generic error message hides real join failures.

Purpose: Address all lobby-related UAT v2 failures (tests 2, 3, 8) so the multiplayer lobby flow works correctly end-to-end.
Output: Working lobby with all input keys functional, character deselect, lobby reconnection, and reliable game reconnection.
</objective>

<execution_context>
@/Users/jonasbrandvik/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jonasbrandvik/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/debug/room-code-input-keys.md
@.planning/debug/character-deselect-lobby-refresh.md
@.planning/debug/reconnection-allow-reconnection.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix room code input keys, selectedRole reset, and reconnection retry window</name>
  <files>client/src/scenes/LobbyScene.ts</files>
  <action>
  Apply these targeted fixes to LobbyScene.ts:

  **Fix A: Phaser keyboard capture blocks HTML input (Gap 1, Test 2)**
  In showJoinInput(), after the line `this.htmlInput.focus();` (around line 232), add focus/blur event listeners on the HTML input element:
  ```typescript
  this.htmlInput.addEventListener('focus', () => {
    if (this.input.keyboard) {
      this.input.keyboard.enabled = false;
    }
  });
  this.htmlInput.addEventListener('blur', () => {
    if (this.input.keyboard) {
      this.input.keyboard.enabled = true;
    }
  });
  ```
  This disables Phaser's keyboard manager while the HTML input is focused, allowing D, S, W, A and all other keys to reach the input element. Re-enables on blur so game keys work again.

  **Fix B: Reset selectedRole on view transitions (Gap 1, Test 2)**
  In showMainMenu(), right after the `this.clearUI();` call (line 127), add:
  ```typescript
  this.selectedRole = null;
  ```
  In showLobbyView(), right after the `this.clearUI();` call (line 505), add:
  ```typescript
  this.selectedRole = null;
  ```
  This prevents stale selectedRole from a previous session causing a false green border on character panels.

  **Fix C: Increase reconnection retry parameters (Gap 4, Test 8)**
  Change the constants at lines 69-70 from:
  ```typescript
  const MAX_RETRIES = 3;
  const RETRY_DELAY = 800;
  ```
  to:
  ```typescript
  const MAX_RETRIES = 12;
  const RETRY_DELAY = 1000;
  ```
  This gives a ~12 second retry window, exceeding the server's worst-case 9-second ping timeout for disconnect detection. The old 2.4s window was too short -- all reconnection attempts arrived before the server called allowReconnection.

  **Fix D: Show actual error in joinPrivateRoom (Gap 2, Test 3)**
  In joinPrivateRoom(), update the catch block (lines 303-312). Instead of always showing "Room not found!", show the actual error:
  ```typescript
  } catch (e: any) {
    console.error('Failed to join room:', e);
    const errorMsg = e?.message?.includes('full') || e?.message?.includes('locked')
      ? 'Room is full!'
      : 'Room not found!';
    statusText.setText(errorMsg);
    statusText.setColor('#ff0000');
    this.time.delayedCall(3000, () => this.showMainMenu());
  }
  ```
  </action>
  <verify>
  1. Run `cd /Users/jonasbrandvik/Projects/banger-game/client && npx tsc --noEmit` to confirm no TypeScript errors.
  2. Verify showJoinInput() has focus/blur listeners that toggle this.input.keyboard.enabled.
  3. Verify showMainMenu() and showLobbyView() both set this.selectedRole = null after clearUI().
  4. Verify MAX_RETRIES = 12 and RETRY_DELAY = 1000 in checkReconnection().
  5. Verify joinPrivateRoom catch block distinguishes error types.
  </verify>
  <done>
  - D, S, W, A keys work in room code HTML input (Phaser keyboard disabled on focus)
  - No false character highlight on lobby join (selectedRole reset to null)
  - Reconnection retries for 12 seconds (outlasts 9s server ping timeout)
  - joinPrivateRoom shows "Room is full!" vs "Room not found!" based on error
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement character deselect and lobby reconnection token</name>
  <files>client/src/scenes/LobbyScene.ts, server/src/rooms/LobbyRoom.ts</files>
  <action>
  **Fix E: Character deselect toggle (Gap 2, Test 3) -- Client side**
  In LobbyScene.ts, update selectRole() method (lines 821-828) to toggle when clicking already-selected role:
  ```typescript
  private selectRole(role: string) {
    if (this.room) {
      if (this.selectedRole === role) {
        // Deselect current role
        this.selectedRole = null;
        this.room.send('deselectRole');
      } else {
        // Select new role
        this.selectedRole = role;
        this.room.send('selectRole', { role });
      }
      // Immediate optimistic UI update
      this.characterPanelUpdaters.forEach(fn => fn());
    }
  }
  ```

  **Fix F: Character deselect handler (Gap 2, Test 3) -- Server side**
  In LobbyRoom.ts, add a new message handler for 'deselectRole' after the existing 'selectRole' handler (after line 59):
  ```typescript
  this.onMessage("deselectRole", (client) => {
    const player = this.state.players.get(client.sessionId);
    if (!player) return;

    player.role = "";
    player.ready = false;

    console.log(`Player ${client.sessionId} deselected role`);

    // Cancel countdown if active (role distribution now invalid)
    if (this.countdownInterval) {
      this.countdownInterval.clear();
      this.countdownInterval = undefined;
      this.state.countdown = 0;
    }
  });
  ```

  **Fix G: Lobby reconnection token storage (Gap 2, Test 3) -- Client side**
  In LobbyScene.ts showLobbyView(), after the room is confirmed connected (after the `this.clearUI();` and view setup), add lobby token storage. Insert after the room state listeners are set up (around line 540, after the roomCode listener):
  ```typescript
  // Store lobby reconnection token for browser refresh recovery
  if (this.room.reconnectionToken) {
    localStorage.setItem('bangerLobbyRoom', JSON.stringify({
      token: this.room.reconnectionToken,
      roomId: this.room.id,
      timestamp: Date.now()
    }));
  }
  ```

  **Fix H: Check lobby token on scene create (Gap 2, Test 3) -- Client side**
  In LobbyScene.ts checkReconnection(), BEFORE checking for 'bangerActiveRoom' (game token), check for 'bangerLobbyRoom' (lobby token). Insert after line 35 (`const stored = localStorage.getItem('bangerActiveRoom');`) but restructure the logic:

  First check for lobby token (higher priority since we might be refreshing in lobby):
  ```typescript
  // Check for lobby reconnection token FIRST (lobby refresh)
  const lobbyStored = localStorage.getItem('bangerLobbyRoom');
  if (lobbyStored) {
    try {
      const { token, timestamp } = JSON.parse(lobbyStored);
      const graceMs = LOBBY_CONFIG.LOBBY_RECONNECT_GRACE * 1000;
      const elapsed = Date.now() - timestamp;

      if (elapsed < graceMs) {
        // Show reconnecting message
        const bg = this.add.rectangle(400, 300, 800, 600, 0x1a1a2e);
        this.uiElements.push(bg);
        const text = this.add.text(400, 300, 'Reconnecting to lobby...', {
          fontSize: '24px', color: '#ffff00'
        }).setOrigin(0.5);
        this.uiElements.push(text);

        try {
          this.room = await this.client.reconnect(token);
          console.log('Reconnected to lobby:', this.room.id);

          // Update stored token
          if (this.room.reconnectionToken) {
            localStorage.setItem('bangerLobbyRoom', JSON.stringify({
              token: this.room.reconnectionToken,
              roomId: this.room.id,
              timestamp: Date.now()
            }));
          }

          this.showLobbyView();
          return;
        } catch (e) {
          console.log('Lobby reconnection failed:', e);
          localStorage.removeItem('bangerLobbyRoom');
          this.clearUI();
          // Fall through to check game token or show menu
        }
      } else {
        localStorage.removeItem('bangerLobbyRoom');
      }
    } catch (e) {
      localStorage.removeItem('bangerLobbyRoom');
    }
  }
  ```

  **Fix I: Clear lobby token on appropriate transitions**
  - In the gameReady handler (around line 590, when leaving lobby to join game), add: `localStorage.removeItem('bangerLobbyRoom');`
  - In showMainMenu(), add: `localStorage.removeItem('bangerLobbyRoom');` (player returned to menu intentionally)
  - In shutdown(), add: `localStorage.removeItem('bangerLobbyRoom');`
  </action>
  <verify>
  1. Run `cd /Users/jonasbrandvik/Projects/banger-game/server && npx tsc --noEmit` to confirm no server TypeScript errors.
  2. Run `cd /Users/jonasbrandvik/Projects/banger-game/client && npx tsc --noEmit` to confirm no client TypeScript errors.
  3. Verify LobbyRoom.ts has 'deselectRole' message handler that clears role and ready, cancels countdown.
  4. Verify selectRole() toggles (sends deselectRole when clicking same role).
  5. Verify 'bangerLobbyRoom' token stored in showLobbyView, checked in checkReconnection, cleared on game transition and menu return.
  </verify>
  <done>
  - Clicking already-selected character deselects it (role freed for other players)
  - Server handles deselectRole message (clears role, unreadies, cancels countdown)
  - Lobby reconnection token stored in localStorage on lobby join
  - Browser refresh in lobby reconnects to same lobby instead of returning to menu
  - Lobby token cleared when transitioning to game or returning to menu
  </done>
</task>

</tasks>

<verification>
After both tasks complete:
1. TypeScript compilation passes for both client and server (no type errors)
2. All 6 fixes (A through I) are present in the source files
3. No regressions to existing functionality (room creation, joining, ready system, game transition)
</verification>

<success_criteria>
- All alphanumeric keys work in room code input field
- No pre-highlighted character panel when joining a fresh lobby
- Character deselect works (click selected character to unselect)
- Lobby refresh reconnects to same lobby room
- Game reconnection retries for ~12 seconds (exceeds 9s ping timeout)
- Join errors show meaningful messages (full vs not found)
</success_criteria>

<output>
After completion, create `.planning/phases/05-multiplayer-lobbies/05-08-SUMMARY.md`
</output>
