---
phase: 05-multiplayer-lobbies
plan: 12
type: execute
wave: 1
depends_on: []
files_modified:
  - client/src/scenes/LobbyScene.ts
  - client/src/scenes/GameScene.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "S key (and all WASD keys) work in room code HTML input field after playing a match"
    - "Browser refresh during active match reliably reconnects all tabs (each with unique token)"
    - "Lobby refresh reconnection works reliably for all tabs (no token collision)"
  artifacts:
    - path: "client/src/scenes/LobbyScene.ts"
      provides: "Global keyboard capture disable/enable on input focus/blur, sessionStorage for reconnection tokens"
      contains: "disableGlobalCapture"
      modified_lines: [302-311, 35, 76, 157, 624, 691]
    - path: "client/src/scenes/GameScene.ts"
      provides: "sessionStorage for game reconnection tokens"
      modified_lines: [125, 580, 598]
  key_links:
    - from: "client/src/scenes/LobbyScene.ts"
      to: "Phaser global KeyboardManager"
      via: "disableGlobalCapture() on focus, enableGlobalCapture() on blur"
      pattern: "input\\.keyboard\\.(disable|enable)GlobalCapture"
    - from: "client/src/scenes/LobbyScene.ts"
      to: "sessionStorage API"
      via: "sessionStorage.setItem/getItem for per-tab token persistence"
      pattern: "sessionStorage\\.(get|set)Item\\('banger"
    - from: "client/src/scenes/GameScene.ts"
      to: "sessionStorage API"
      via: "sessionStorage for per-tab game reconnection tokens"
      pattern: "sessionStorage\\.(get|set)Item\\('banger"
---

<objective>
Fix UAT v4 gaps: (1) S key not working in room code input after playing a match, (2) game reconnection flaky due to localStorage key collision between tabs, (3) lobby reconnection flaky due to same token collision issue.

Purpose: Close final Phase 5 gaps to achieve 100% reliable reconnection and consistent input behavior across all game states.
Output: Updated LobbyScene and GameScene with global keyboard capture management and per-tab sessionStorage tokens.
</objective>

<execution_context>
@/Users/jonasbrandvik/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jonasbrandvik/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/Users/jonasbrandvik/Projects/banger-game/.planning/PROJECT.md
@/Users/jonasbrandvik/Projects/banger-game/.planning/ROADMAP.md
@/Users/jonasbrandvik/Projects/banger-game/.planning/STATE.md
@/Users/jonasbrandvik/Projects/banger-game/.planning/phases/05-multiplayer-lobbies/05-UAT-v4.md
@/Users/jonasbrandvik/Projects/banger-game/.planning/phases/05-multiplayer-lobbies/05-11-SUMMARY.md
@/Users/jonasbrandvik/Projects/banger-game/.planning/phases/05-multiplayer-lobbies/05-08-SUMMARY.md
@/Users/jonasbrandvik/Projects/banger-game/client/src/scenes/LobbyScene.ts
@/Users/jonasbrandvik/Projects/banger-game/client/src/scenes/GameScene.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix S key input by adding global keyboard capture control</name>
  <files>client/src/scenes/LobbyScene.ts</files>
  <action>
Add global keyboard capture disable/enable to HTML input focus/blur handlers in showJoinInput() method.

**Root cause:** Phaser's global KeyboardManager.captures persists after GameScene shutdown. The existing fix at lines 302-311 only disables the scene-level KeyboardPlugin (keyboard.enabled=false), which doesn't prevent the global KeyboardManager from calling preventDefault() on captured keys (WASD + arrows + space + tab). After one game session, these keys are permanently captured globally.

**Changes to showJoinInput() method (around lines 302-311):**

Current focus handler:
```typescript
this.htmlInput.addEventListener('focus', () => {
  if (this.input.keyboard) {
    this.input.keyboard.enabled = false;
  }
});
```

Replace with:
```typescript
this.htmlInput.addEventListener('focus', () => {
  if (this.input.keyboard) {
    this.input.keyboard.enabled = false;
    this.input.keyboard.disableGlobalCapture(); // Add this line
  }
});
```

Current blur handler:
```typescript
this.htmlInput.addEventListener('blur', () => {
  if (this.input.keyboard) {
    this.input.keyboard.enabled = true;
  }
});
```

Replace with:
```typescript
this.htmlInput.addEventListener('blur', () => {
  if (this.input.keyboard) {
    this.input.keyboard.enabled = true;
    this.input.keyboard.enableGlobalCapture(); // Add this line
  }
});
```

**Why this works:** disableGlobalCapture() removes ALL key listeners from the global KeyboardManager (not just scene-level), allowing the HTML input to receive all keystrokes. enableGlobalCapture() restores them when input loses focus, so Phaser keybinds work normally in lobby UI.

**What to avoid:** Do NOT add disableGlobalCapture() to GameScene (game needs global capture for WASD controls). Only disable in HTML input context where native browser input needs priority.
  </action>
  <verify>
grep -A 2 "addEventListener('focus'" client/src/scenes/LobbyScene.ts | grep -q "disableGlobalCapture" && echo "PASS: disableGlobalCapture added to focus handler" || echo "FAIL: missing disableGlobalCapture"

grep -A 2 "addEventListener('blur'" client/src/scenes/LobbyScene.ts | grep -q "enableGlobalCapture" && echo "PASS: enableGlobalCapture added to blur handler" || echo "FAIL: missing enableGlobalCapture"
  </verify>
  <done>
LobbyScene.ts focus handler contains `this.input.keyboard.disableGlobalCapture()` and blur handler contains `this.input.keyboard.enableGlobalCapture()`. S key (and all WASD keys) work in room code input after playing a match.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace localStorage with sessionStorage for reconnection tokens</name>
  <files>client/src/scenes/LobbyScene.ts, client/src/scenes/GameScene.ts</files>
  <action>
Replace ALL localStorage usage for reconnection tokens with sessionStorage to eliminate cross-tab token collision.

**Root cause:** All browser tabs share a single localStorage instance. When multiple tabs open the same game, each writes its unique reconnection token to the same key ('bangerActiveRoom' or 'bangerLobbyRoom'). Last writer wins — other tabs' tokens are overwritten and lost. On F5 refresh, all tabs read the same (last-written) token from localStorage. Only the original owner of that token can reconnect; others fail with "Session expired".

**Solution:** sessionStorage is per-tab but survives F5 refresh. Each tab maintains its own unique token that persists across page reload but doesn't affect other tabs.

**Changes to LobbyScene.ts:**

Find and replace ALL occurrences (5 total):

1. Line ~35 (checkReconnection lobby token read):
```typescript
const lobbyStored = localStorage.getItem('bangerLobbyRoom');
```
Replace with:
```typescript
const lobbyStored = sessionStorage.getItem('bangerLobbyRoom');
```

2. Line ~76 (checkReconnection lobby token cleanup):
```typescript
localStorage.setItem('bangerLobbyRoom', JSON.stringify({
```
Replace with:
```typescript
sessionStorage.setItem('bangerLobbyRoom', JSON.stringify({
```

3. Line ~100 (checkReconnection game token read):
```typescript
const stored = localStorage.getItem('bangerActiveRoom');
```
Replace with:
```typescript
const stored = sessionStorage.getItem('bangerActiveRoom');
```

4. Line ~157 (checkReconnection game token cleanup):
```typescript
localStorage.setItem('bangerActiveRoom', JSON.stringify({
```
Replace with:
```typescript
sessionStorage.setItem('bangerActiveRoom', JSON.stringify({
```

5. Line ~624 (createPrivateRoom lobby token storage):
```typescript
localStorage.setItem('bangerLobbyRoom', JSON.stringify({
```
Replace with:
```typescript
sessionStorage.setItem('bangerLobbyRoom', JSON.stringify({
```

6. Line ~691 (matchFound game token storage):
```typescript
localStorage.setItem('bangerActiveRoom', JSON.stringify({
```
Replace with:
```typescript
sessionStorage.setItem('bangerActiveRoom', JSON.stringify({
```

**Changes to GameScene.ts:**

Find and replace ALL occurrences (3 total):

1. Line ~125 (create game token storage):
```typescript
localStorage.setItem('bangerActiveRoom', JSON.stringify({
```
Replace with:
```typescript
sessionStorage.setItem('bangerActiveRoom', JSON.stringify({
```

2. Line ~580 (onLeave token read):
```typescript
const stored = localStorage.getItem('bangerActiveRoom');
```
Replace with:
```typescript
const stored = sessionStorage.getItem('bangerActiveRoom');
```

3. Line ~598 (onLeave token cleanup):
```typescript
localStorage.setItem('bangerActiveRoom', JSON.stringify({
```
Replace with:
```typescript
sessionStorage.setItem('bangerActiveRoom', JSON.stringify({
```

**Why this works:** sessionStorage is per-tab (isolated), survives F5 (persists across page reload), and is automatically cleared when tab closes (no stale tokens). Each tab tracks only its own reconnection token with no cross-tab interference.

**What to avoid:** Do NOT mix localStorage and sessionStorage for the same keys. Do NOT add any additional localStorage calls for reconnection tokens. All reconnection state must use sessionStorage.
  </action>
  <verify>
# Verify NO localStorage calls remain for reconnection tokens
! grep -E "localStorage\.(get|set)Item\('banger" client/src/scenes/LobbyScene.ts client/src/scenes/GameScene.ts && echo "PASS: No localStorage for banger tokens" || echo "FAIL: localStorage still exists"

# Verify sessionStorage is used instead (should find 9 total: 6 in LobbyScene, 3 in GameScene)
LOBBY_COUNT=$(grep -c "sessionStorage\.(get|set)Item('banger" client/src/scenes/LobbyScene.ts)
GAME_COUNT=$(grep -c "sessionStorage\.(get|set)Item('banger" client/src/scenes/GameScene.ts)
TOTAL=$((LOBBY_COUNT + GAME_COUNT))

if [ "$TOTAL" -eq 9 ]; then
  echo "PASS: Found $TOTAL sessionStorage calls (6 LobbyScene + 3 GameScene)"
else
  echo "FAIL: Expected 9 sessionStorage calls, found $TOTAL"
fi
  </verify>
  <done>
All reconnection token storage uses sessionStorage (not localStorage). LobbyScene.ts has 6 sessionStorage calls for bangerLobbyRoom and bangerActiveRoom. GameScene.ts has 3 sessionStorage calls for bangerActiveRoom. No localStorage calls remain for reconnection tokens. Browser refresh during game or lobby reliably reconnects each tab with its unique token.
  </done>
</task>

</tasks>

<verification>
**Pattern verification:**
```bash
# Verify global keyboard capture control added
grep -A 2 "addEventListener('focus'" client/src/scenes/LobbyScene.ts | grep -q "disableGlobalCapture"
grep -A 2 "addEventListener('blur'" client/src/scenes/LobbyScene.ts | grep -q "enableGlobalCapture"

# Verify NO localStorage for reconnection tokens
! grep -E "localStorage\.(get|set)Item\('banger" client/src/scenes/LobbyScene.ts client/src/scenes/GameScene.ts

# Verify sessionStorage used for reconnection tokens (9 total)
grep -c "sessionStorage\.(get|set)Item('banger" client/src/scenes/LobbyScene.ts client/src/scenes/GameScene.ts
```

**TypeScript compilation:**
```bash
cd /Users/jonasbrandvik/Projects/banger-game/client && npm run build
```

**Manual testing (recommended after execution):**
1. Start a match, complete it, return to lobby, click "Join Private Room" — type in room code using S, W, A, D keys (all should work)
2. Open 3 browser tabs, all join same game room, press F5 on each tab — all should reconnect successfully within 12-second window
3. Open 3 browser tabs, all join same lobby, press F5 on each tab — all should reconnect to lobby with preserved roles
</verification>

<success_criteria>
**Artifacts exist:**
- [ ] client/src/scenes/LobbyScene.ts contains `disableGlobalCapture()` in focus handler
- [ ] client/src/scenes/LobbyScene.ts contains `enableGlobalCapture()` in blur handler
- [ ] client/src/scenes/LobbyScene.ts uses sessionStorage (not localStorage) for bangerLobbyRoom and bangerActiveRoom (6 calls)
- [ ] client/src/scenes/GameScene.ts uses sessionStorage (not localStorage) for bangerActiveRoom (3 calls)

**Observable truths:**
- [ ] After playing a match and returning to lobby, all WASD keys work in room code input field
- [ ] Multiple browser tabs can refresh during active game and all reconnect successfully (no "Session expired")
- [ ] Multiple browser tabs can refresh while in lobby and all reconnect successfully (no "Session expired")
- [ ] TypeScript compiles without errors

**Key links verified:**
- [ ] LobbyScene focus/blur handlers call disableGlobalCapture/enableGlobalCapture (not just keyboard.enabled)
- [ ] All reconnection token reads/writes use sessionStorage API (grep confirms 9 occurrences, 0 localStorage)
</success_criteria>

<output>
After completion, create `.planning/phases/05-multiplayer-lobbies/05-12-SUMMARY.md` documenting:
- Both fixes (keyboard capture + sessionStorage migration)
- Why sessionStorage eliminates cross-tab token collision
- Verification results (pattern checks + TypeScript compilation)
- Phase 05 gap closure completion status
</output>
