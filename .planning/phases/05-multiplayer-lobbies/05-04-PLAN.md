---
phase: 05-multiplayer-lobbies
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - server/src/rooms/LobbyRoom.ts
  - server/src/rooms/GameRoom.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "All 3 players transition from lobby to game after countdown completes"
    - "Player's assigned character in GameScene matches lobby selection"
    - "No phantom seat reservation consuming a maxClients slot"
  artifacts:
    - path: "server/src/rooms/LobbyRoom.ts"
      provides: "Room creation without seat reservation"
      contains: "matchMaker.createRoom"
    - path: "server/src/rooms/GameRoom.ts"
      provides: "Role assignment from client options.role"
      contains: "options.role"
  key_links:
    - from: "server/src/rooms/LobbyRoom.ts"
      to: "server/src/rooms/GameRoom.ts"
      via: "matchMaker.createRoom creates room, clients join with role in options"
      pattern: "createRoom.*game_room"
    - from: "client/src/scenes/LobbyScene.ts"
      to: "server/src/rooms/GameRoom.ts"
      via: "client.joinById sends role in options, GameRoom.onJoin reads options.role"
      pattern: "options\\.role"
---

<objective>
Fix two blockers preventing lobby-to-game transitions: phantom seat reservation and wrong role assignment.

Purpose: These are BLOCKERS -- without fixing them, the game is unplayable. The 3rd player gets kicked because matchMaker.create() reserves a phantom seat, and roles are misassigned because GameRoom looks up roles by lobby sessionId (which changes in GameRoom).

Output: All 3 players successfully join GameRoom with correct roles after lobby countdown.
</objective>

<execution_context>
@/Users/jonasbrandvik/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jonasbrandvik/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-multiplayer-lobbies/05-01-SUMMARY.md
@.planning/phases/05-multiplayer-lobbies/05-UAT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix phantom seat and role assignment in LobbyRoom and GameRoom</name>
  <files>server/src/rooms/LobbyRoom.ts, server/src/rooms/GameRoom.ts</files>
  <action>
**Fix 1: LobbyRoom.startMatch() -- phantom seat (LobbyRoom.ts line 255)**

Replace `matchMaker.create()` with `matchMaker.createRoom()`. The `create()` method returns a SeatReservation which consumes 1 of 3 maxClients slots, leaving only 2 slots for real clients. `createRoom()` just creates the room without reserving a seat.

Change line 255 from:
```typescript
const reservation = await matchMaker.create("game_room", {
  fromLobby: true,
  roleAssignments,
});
```
To:
```typescript
const room = await matchMaker.createRoom("game_room", {
  fromLobby: true,
  roleAssignments,
});
```

Also update the broadcast on line 261-263 from `reservation.room.roomId` to `room.roomId`:
```typescript
this.broadcast("gameReady", {
  gameRoomId: room.roomId,
});
```

And the console.log on line 265 from `reservation.room.roomId` to `room.roomId`.

**Fix 2: GameRoom.onJoin() -- role assignment (GameRoom.ts lines 132-143)**

The roleAssignments map is keyed by lobby sessionIds, but clients get NEW sessionIds when they join GameRoom. The client already sends `role: this.selectedRole` in the join options (LobbyScene.ts line 458). GameRoom should read `options.role` instead of doing sessionId lookup.

Replace the role assignment block (lines 128-144) with:
```typescript
let role: string;

// If client sends role from lobby, use it (with validation)
if (options?.role && ["paran", "faran", "baran"].includes(options.role)) {
  role = options.role;
} else if (this.roleAssignments && this.roleAssignments[client.sessionId]) {
  // Fallback to roleAssignments lookup (unlikely to match but kept for safety)
  role = this.roleAssignments[client.sessionId];
} else {
  // Final fallback: assign by join order (backward compatibility for direct joins)
  const playerCount = this.state.players.size;
  if (playerCount === 0) {
    role = "paran";
  } else if (playerCount === 1) {
    role = "faran";
  } else {
    role = "baran";
  }
}
```

Additionally, add server-side role conflict prevention in GameRoom.onJoin(): before accepting the role, check that no other player already has it. If conflict, fall back to first available role:
```typescript
// Validate no duplicate roles
let roleTaken = false;
this.state.players.forEach((p) => {
  if (p.role === role) roleTaken = true;
});
if (roleTaken) {
  // Assign first available role
  const takenRoles = new Set<string>();
  this.state.players.forEach((p) => { takenRoles.add(p.role); });
  const availableRoles = ["paran", "faran", "baran"].filter(r => !takenRoles.has(r));
  role = availableRoles[0] || "baran";
}
```

Place this conflict check right after the role assignment block, before the spawn position logic.

After both fixes, run `cd /Users/jonasbrandvik/Projects/banger-game/server && npx tsc --noEmit` to verify compilation.
  </action>
  <verify>
Run `cd /Users/jonasbrandvik/Projects/banger-game/server && npx tsc --noEmit` -- must pass with zero errors.
Grep for `matchMaker.createRoom` in LobbyRoom.ts -- must find it.
Grep for `options?.role` in GameRoom.ts -- must find it.
Grep for `matchMaker.create(` in LobbyRoom.ts -- must NOT find it (only createRoom).
  </verify>
  <done>
LobbyRoom uses matchMaker.createRoom() (no phantom seat), GameRoom reads role from options.role with validation and conflict prevention. Both files compile cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Rebuild server dist/ to ensure runtime matches source</name>
  <files>server/dist/</files>
  <action>
The server's dist/ directory contains stale compiled JavaScript from before Phase 5 changes. This means the running server may not have any of the lobby/reconnection code.

Run the build:
```bash
cd /Users/jonasbrandvik/Projects/banger-game/server && npx tsc
```

Verify the build output includes the fixes:
- Check `server/dist/rooms/LobbyRoom.js` contains `createRoom` (not just `create`)
- Check `server/dist/rooms/GameRoom.js` contains `options.role` or `options?.role`

This ensures when the server is restarted with `npm start`, it runs the fixed code.
  </action>
  <verify>
Run `cd /Users/jonasbrandvik/Projects/banger-game/server && npx tsc` -- must complete without errors.
Grep for `createRoom` in `server/dist/rooms/LobbyRoom.js` -- must find it.
Grep for `options` and `role` in `server/dist/rooms/GameRoom.js` -- must find role reading from options.
  </verify>
  <done>
Server dist/ is freshly built from the corrected source. Running `npm start` will execute the fixed code with no phantom seats and correct role assignment.
  </done>
</task>

</tasks>

<verification>
1. `server/src/rooms/LobbyRoom.ts` uses `matchMaker.createRoom()` not `matchMaker.create()`
2. `server/src/rooms/GameRoom.ts` reads role from `options.role` with validation
3. GameRoom has role conflict prevention (no duplicate roles)
4. Server TypeScript compiles without errors
5. Server dist/ is rebuilt and matches source
</verification>

<success_criteria>
- matchMaker.createRoom() used in LobbyRoom (no phantom seat consumption)
- GameRoom.onJoin() reads options.role as primary source (not sessionId lookup)
- Role conflict prevention prevents duplicate roles in GameRoom
- Both source and dist/ compile/build successfully
</success_criteria>

<output>
After completion, create `.planning/phases/05-multiplayer-lobbies/05-04-SUMMARY.md`
</output>
