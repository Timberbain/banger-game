---
phase: 05-multiplayer-lobbies
plan: 02
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - client/src/scenes/LobbyScene.ts
  - client/src/scenes/BootScene.ts
  - client/src/main.ts
autonomous: true

must_haves:
  truths:
    - "Player sees main menu with Create Private Room, Join Private Room, and Find Match buttons"
    - "Creating private room displays a 6-character room code to share"
    - "Joining by room code connects to the correct private lobby"
    - "Player can select character role (Paran, Faran, Baran) with unavailable roles grayed out"
    - "Player can toggle ready state after selecting a role"
    - "Lobby displays connected players with their roles and ready status"
    - "Countdown displays when all players ready, then transitions to GameScene"
  artifacts:
    - path: "client/src/scenes/LobbyScene.ts"
      provides: "Full lobby UI scene with create/join/queue, character selection, ready toggle, player list"
      contains: "LobbyScene"
    - path: "client/src/scenes/BootScene.ts"
      provides: "Updated boot scene that transitions to LobbyScene instead of GameScene"
      contains: "LobbyScene"
    - path: "client/src/main.ts"
      provides: "Phaser game config with LobbyScene registered"
      contains: "LobbyScene"
  key_links:
    - from: "client/src/scenes/LobbyScene.ts"
      to: "server LobbyRoom"
      via: "Colyseus client.create/joinById/joinOrCreate"
      pattern: "client\\.(create|joinById|joinOrCreate)"
    - from: "client/src/scenes/LobbyScene.ts"
      to: "client/src/scenes/GameScene.ts"
      via: "scene.start on gameReady message"
      pattern: "scene\\.start.*GameScene"
    - from: "client/src/scenes/BootScene.ts"
      to: "client/src/scenes/LobbyScene.ts"
      via: "scene.start transition"
      pattern: "scene\\.start.*LobbyScene"
---

<objective>
Build the client-side lobby UI: LobbyScene with three entry paths (create private, join private, find match), character selection, ready system, player list, countdown display, and transition to GameScene.

Purpose: Players need a visual interface to find matches, choose characters, and coordinate readiness before gameplay begins.
Output: Working LobbyScene that replaces direct GameScene connection, providing full pre-match lobby flow.
</objective>

<execution_context>
@/Users/jonasbrandvik/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jonasbrandvik/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-multiplayer-lobbies/05-RESEARCH.md
@.planning/phases/05-multiplayer-lobbies/05-01-SUMMARY.md

@client/src/scenes/BootScene.ts
@client/src/scenes/GameScene.ts
@client/src/main.ts
@shared/lobby.ts
@shared/characters.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create LobbyScene with all lobby flows</name>
  <files>
    client/src/scenes/LobbyScene.ts
  </files>
  <action>
    Create `client/src/scenes/LobbyScene.ts` as a Phaser.Scene with key `"LobbyScene"`.

    **State management:**
    - `private client: Client` (Colyseus client, `ws://localhost:2567`)
    - `private room: Room | null` (current lobby room connection)
    - `private currentView: "menu" | "lobby"` (which UI state is shown)
    - `private playerName: string` (default: `"Player"`)

    **Main Menu View (currentView = "menu"):**
    - Title text: "BANGER" centered at top, 48px bold white
    - Three buttons stacked vertically:
      1. "Create Private Room" (blue bg) -> calls `createPrivateRoom()`
      2. "Join Private Room" (blue bg) -> calls `showJoinInput()`
      3. "Find Match" (green bg) -> calls `showRoleSelectForMatchmaking()`
    - Use Phaser Text objects with backgroundColor and padding for buttons
    - Each button has `setInteractive({ useHandCursor: true })` and `pointerdown` handler

    **createPrivateRoom():**
    - `const room = await this.client.create("lobby_room", { private: true, name: this.playerName })`
    - Store as `this.room`
    - Transition to lobby view: call `showLobbyView()`
    - Display room code from `room.state.roomCode` prominently (large yellow text)

    **showJoinInput():**
    - Clear menu UI
    - Show "Enter Room Code:" label
    - Create an HTML input element via `document.createElement('input')` positioned over the Phaser canvas (Phaser lacks native text input). Style it: centered, large text, uppercase, maxLength 6, monospace font.
    - Add "Join" button below
    - On submit: `joinPrivateRoom(inputValue)`
    - Add "Back" button to return to menu

    **joinPrivateRoom(code: string):**
    - Use HTTP GET to query server for room with matching code: `fetch(\`http://localhost:2567/matchmake/lobby_room\`)` is not available directly, so instead use the approach of listing rooms via Colyseus client: `const rooms = await this.client.getAvailableRooms("lobby_room")`
    - IMPORTANT: Private rooms won't appear in getAvailableRooms. Instead, the client needs to use a custom server endpoint. Add a message-based approach: create a temporary connection or use a REST endpoint.
    - SIMPLEST APPROACH: Add a custom HTTP endpoint on the server (in index.ts from Plan 01) `GET /rooms/find?code=XXXXXX` that calls `matchMaker.query({ name: "lobby_room", metadata: { roomCode: code } })` and returns the roomId. The client fetches this endpoint, then calls `client.joinById(roomId, { name: this.playerName })`.
    - On success: store room, call `showLobbyView()`
    - On error: show "Room not found" error text (red, auto-hide after 3s)

    **showRoleSelectForMatchmaking():**
    - Clear menu UI
    - Show "Select Preferred Role" title
    - Three role buttons: "Paran (1v2)" red, "Faran (Guardian)" blue, "Baran (Guardian)" blue
    - On click: `joinMatchmaking(selectedRole)`
    - Add "Back" button

    **joinMatchmaking(preferredRole: string):**
    - Show "Searching for match..." text with optional spinner
    - `const room = await this.client.joinOrCreate("lobby_room", { matchmaking: true, preferredRole, name: this.playerName })`
    - Store room, call `showLobbyView()`

    **showLobbyView() â€” Character Selection + Ready State:**
    - Clear all previous UI elements
    - **Room code display** (if private): "Room Code: XXXXXX" in yellow at top
    - **Character Selection** section (mid-screen):
      - Three character panels side by side, each with:
        - Colored rectangle (red for paran, blue for faran, green for baran)
        - Character name text below
        - Role description (e.g., "Force - 150HP", "Guardian - 50HP")
      - Click handler sends `room.send("selectRole", { role })`
      - Selected character gets green border (strokeStyle)
      - Characters taken by OTHER players get grayed out (alpha 0.5) and disabled
    - **Player List** section (right side or below):
      - For each player in `room.state.players`: show name, role (or "Selecting..."), ready icon (green checkmark or gray circle)
      - Use `room.state.players.onAdd()` and player `.onChange()` to update dynamically
      - On player remove: remove from list
    - **Ready Button** (bottom center):
      - "Ready" / "Not Ready" toggle button
      - Only clickable if player has selected a role
      - Sends `room.send("toggleReady")`
      - Visual feedback: green when ready, gray when not
    - **Countdown Display:**
      - Listen to `room.state.countdown` changes
      - When countdown > 0: show large centered countdown number (3, 2, 1)
      - When countdown resets to 0: hide countdown

    **Role Error Handling:**
    - Listen for `room.onMessage("roleError", ...)`: show error text briefly

    **Game Transition:**
    - Listen for `room.onMessage("gameReady", ...)`:
      - Get `gameRoomId` from message data
      - Call `room.leave()` to leave lobby
      - Call `const gameRoom = await this.client.joinById(gameRoomId, { name: this.playerName, fromLobby: true, role: selectedRole })`
      - Store `gameRoom.reconnectionToken` in `localStorage` with key `"bangerActiveRoom"` along with timestamp
      - Call `this.scene.start("GameScene", { room: gameRoom })`

    **Cleanup:**
    - On scene shutdown: if room connected, leave room
    - Remove any HTML input elements created for room code input
  </action>
  <verify>
    `cd /Users/jonasbrandvik/Projects/banger-game/client && npx tsc --noEmit` compiles without errors. LobbyScene.ts exists with all handlers.
  </verify>
  <done>
    LobbyScene provides complete pre-match flow: menu -> create/join/queue -> character selection -> ready -> countdown -> GameScene transition.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update BootScene, GameScene, and main.ts for lobby flow</name>
  <files>
    client/src/scenes/BootScene.ts
    client/src/scenes/GameScene.ts
    client/src/main.ts
    server/src/index.ts
  </files>
  <action>
    **client/src/scenes/BootScene.ts:**
    - Change `scene.start('GameScene')` to `scene.start('LobbyScene')`
    - Update connecting text to "Loading..." (since connection now happens in LobbyScene)

    **client/src/main.ts:**
    - Import `LobbyScene` from `./scenes/LobbyScene`
    - Add `LobbyScene` to the Phaser `scene` array, positioned between BootScene and GameScene
    - Scene array order: `[BootScene, LobbyScene, GameScene, VictoryScene]`

    **client/src/scenes/GameScene.ts:**
    - Modify `create()` to accept a `room` parameter from scene data (passed from LobbyScene)
    - If `room` is provided in scene init data: use it directly instead of calling `client.joinOrCreate("game_room")`
    - If no room provided (fallback/direct access): keep existing `client.joinOrCreate("game_room")` for backward compatibility during development
    - Store `reconnectionToken` from room in localStorage after connection: `localStorage.setItem("bangerActiveRoom", JSON.stringify({ token: room.reconnectionToken, timestamp: Date.now() }))`
    - Update VictoryScene "Return to Lobby" to go to `"LobbyScene"` instead of `"BootScene"`

    **server/src/index.ts:**
    - Add HTTP endpoint for room code lookup: `app.get('/rooms/find', async (req, res) => { ... })`
    - Import `matchMaker` from `colyseus`
    - Implementation: get `code` from query string, call `matchMaker.query({ name: "lobby_room" })`, filter results to find room where `metadata.roomCode === code.toUpperCase()`, return `{ roomId }` or 404
    - This enables the client to find private rooms by code without exposing them in public room lists
  </action>
  <verify>
    `cd /Users/jonasbrandvik/Projects/banger-game/client && npx tsc --noEmit` compiles. `cd /Users/jonasbrandvik/Projects/banger-game/server && npx tsc --noEmit` compiles. Verify BootScene transitions to LobbyScene. Verify GameScene accepts room from scene data. Verify /rooms/find endpoint exists.
  </verify>
  <done>
    Game flow updated: BootScene -> LobbyScene -> GameScene. GameScene accepts pre-connected room from lobby. VictoryScene returns to LobbyScene. Room code lookup endpoint available.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/jonasbrandvik/Projects/banger-game/client && npx tsc --noEmit` passes
2. `cd /Users/jonasbrandvik/Projects/banger-game/server && npx tsc --noEmit` passes
3. BootScene transitions to LobbyScene (not GameScene directly)
4. LobbyScene has create/join/queue menu buttons
5. Character selection shows 3 roles with availability indicators
6. Player list updates dynamically via Schema callbacks
7. Ready button toggles and sends message to server
8. Countdown displays when server sets countdown > 0
9. gameReady message triggers transition to GameScene with pre-connected room
10. VictoryScene returns to LobbyScene
</verification>

<success_criteria>
- Client compiles without errors
- LobbyScene provides full lobby UI with all three entry paths
- Character selection enforces role constraints visually
- Ready system with countdown display works
- Scene flow: Boot -> Lobby -> Game -> Victory -> Lobby
- Room code lookup via /rooms/find endpoint works
</success_criteria>

<output>
After completion, create `.planning/phases/05-multiplayer-lobbies/05-02-SUMMARY.md`
</output>
