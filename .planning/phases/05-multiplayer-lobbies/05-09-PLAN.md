---
phase: 05-multiplayer-lobbies
plan: 09
type: execute
wave: 1
depends_on: []
files_modified:
  - client/src/scenes/GameScene.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "All 3 players see consistent status text when match starts"
    - "No player sees stale 'Waiting for players...(3/3)' after match begins"
    - "No player sees confusing 'Connected: sessionId' text during gameplay"
    - "Status text hides after 2 seconds once match is playing"
  artifacts:
    - path: "client/src/scenes/GameScene.ts"
      provides: "Schema-based matchState listener for reliable status text, initial state check, no confusing fallback text"
  key_links:
    - from: "client/src/scenes/GameScene.ts"
      to: "room.state.matchState"
      via: "Schema listener"
      pattern: "listen\\(\"matchState\""
---

<objective>
Fix inconsistent status text when 3 players enter game from lobby. Currently players see different text ("Waiting for players...(3/3)", "Match started!", "Connected: playerName") due to race conditions between broadcast timing, initial state sync, and delayed callbacks.

Purpose: Address UAT v2 test 5 failure so all players see consistent, meaningful status text.
Output: Reliable status text driven by Schema state listener instead of one-shot broadcast.
</objective>

<execution_context>
@/Users/jonasbrandvik/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jonasbrandvik/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/debug/inconsistent-status-text.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Replace broadcast-based status text with Schema matchState listener</name>
  <files>client/src/scenes/GameScene.ts</files>
  <action>
  Apply these targeted changes to GameScene.ts to fix the 3 racing status text paths:

  **Change 1: Replace unconditional waiting text with matchState-aware initial check (line 101)**
  Replace line 101:
  ```typescript
  this.statusText.setText(`Waiting for players... (${this.room.state.players.size}/3)`);
  ```
  With a matchState-aware check:
  ```typescript
  // Check initial matchState -- don't show "waiting" if match already started
  if (this.room.state.matchState === 'playing') {
    this.statusText.setText('Match started!');
    this.time.delayedCall(2000, () => {
      if (!this.matchEnded) this.statusText.setVisible(false);
    });
  } else {
    this.statusText.setText(`Waiting for players... (${this.room.state.players.size}/3)`);
  }
  ```

  **Change 2: Add Schema-based matchState listener (after line 131, after the onStateChange.once block)**
  Add a reliable Schema listener that works on both initial sync AND late changes:
  ```typescript
  // Schema-based matchState listener -- reliable regardless of join timing
  this.room.state.listen("matchState", (value: string) => {
    if (value === 'playing' && !this.matchEnded) {
      this.statusText.setText('Match started!');
      this.time.delayedCall(2000, () => {
        if (!this.matchEnded) this.statusText.setVisible(false);
      });
    }
  });
  ```

  **Change 3: Remove the confusing "Connected: sessionId" fallback (lines 134-141)**
  Replace the matchStart message handler block:
  ```typescript
  this.room.onMessage("matchStart", () => {
    this.statusText.setText(`Match started!`);
    // Clear the message after 2 seconds
    this.time.delayedCall(2000, () => {
      if (!this.matchEnded) {
        this.statusText.setText(`Connected: ${this.room!.sessionId}`);
      }
    });
  });
  ```
  With a simplified handler that hides instead of showing confusing text:
  ```typescript
  // Keep matchStart handler as backup (idempotent with Schema listener)
  this.room.onMessage("matchStart", () => {
    if (!this.matchEnded) {
      this.statusText.setText('Match started!');
      this.time.delayedCall(2000, () => {
        if (!this.matchEnded) this.statusText.setVisible(false);
      });
    }
  });
  ```

  **Change 4: Update attachRoomListeners to match (lines 678-685)**
  In the attachRoomListeners() method, update the matchStart handler to match the new pattern:
  ```typescript
  this.room.onMessage("matchStart", () => {
    if (!this.matchEnded) {
      this.statusText.setText('Match started!');
      this.time.delayedCall(2000, () => {
        if (!this.matchEnded) this.statusText.setVisible(false);
      });
    }
  });
  ```
  Also add the matchState Schema listener in attachRoomListeners() (for reconnection cases):
  ```typescript
  this.room.state.listen("matchState", (value: string) => {
    if (value === 'playing' && !this.matchEnded) {
      this.statusText.setText('Match started!');
      this.time.delayedCall(2000, () => {
        if (!this.matchEnded) this.statusText.setVisible(false);
      });
    }
  });
  ```

  **Change 5: Guard onAdd waiting text update (line 188-190)**
  In the players.onAdd handler, add a guard for matchState. Change:
  ```typescript
  if (!this.matchEnded) {
    const count = this.room!.state.players.size;
    if (count < 3) {
      this.statusText.setText(`Waiting for players... (${count}/3)`);
    }
  }
  ```
  To:
  ```typescript
  if (!this.matchEnded && this.room!.state.matchState !== 'playing') {
    const count = this.room!.state.players.size;
    if (count < 3) {
      this.statusText.setText(`Waiting for players... (${count}/3)`);
    }
  }
  ```
  This prevents the onAdd handler from overwriting "Match started!" when the 3rd player addition triggers onAdd AFTER matchState is already 'playing'.
  </action>
  <verify>
  1. Run `cd /Users/jonasbrandvik/Projects/banger-game/client && npx tsc --noEmit` to confirm no TypeScript errors.
  2. Verify no occurrence of `"Connected: ${this.room"` remains in GameScene.ts (the confusing fallback is removed).
  3. Verify `listen("matchState"` appears in both create() and attachRoomListeners().
  4. Verify the initial status text check at line ~101 checks matchState before showing waiting text.
  5. Verify onAdd handler guards with `matchState !== 'playing'`.
  </verify>
  <done>
  - All players see "Match started!" when match begins (driven by Schema state, not one-shot broadcast)
  - Players who connect after matchState is already 'playing' see "Match started!" immediately (not "Waiting 3/3")
  - Status text hides after 2 seconds (not replaced with confusing "Connected: sessionId")
  - Reconnection path also uses matchState listener for consistency
  </done>
</task>

</tasks>

<verification>
After task completes:
1. TypeScript compilation passes (no type errors)
2. No "Connected: sessionId" text anywhere in status text code paths
3. matchState Schema listener is the primary driver of status text transitions
4. Backward compatible -- matchStart broadcast handler still works as backup
</verification>

<success_criteria>
- All 3 players see "Match started!" on game start (no "Waiting 3/3" or "Connected: name")
- Status text disappears after 2 seconds during active gameplay
- Consistent behavior regardless of join timing or network latency
</success_criteria>

<output>
After completion, create `.planning/phases/05-multiplayer-lobbies/05-09-SUMMARY.md`
</output>
