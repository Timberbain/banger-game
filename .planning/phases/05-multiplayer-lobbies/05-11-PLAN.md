---
phase: 05-multiplayer-lobbies
plan: 11
type: execute
wave: 1
depends_on: []
files_modified:
  - client/src/scenes/LobbyScene.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Matchmaking pre-assigned roles are visually highlighted with green border when entering lobby"
    - "Lobby refresh reconnection works reliably with retry loop matching game reconnection pattern"
  artifacts:
    - path: "client/src/scenes/LobbyScene.ts"
      provides: "Fixed matchmaking role highlight and lobby reconnect retry loop"
      contains: "selectRole"
  key_links:
    - from: "client/src/scenes/LobbyScene.ts"
      to: "matchFound handler"
      via: "selectRole() called AFTER showLobbyView() to properly set UI state"
      pattern: "this\\.selectRole\\(data\\.assignedRole\\)"
    - from: "client/src/scenes/LobbyScene.ts"
      to: "lobby reconnect retry"
      via: "Retry loop with MAX_RETRIES matching game reconnection pattern"
      pattern: "MAX_RETRIES"
---

<objective>
Fix two LobbyScene UAT v3 gaps: (1) matchmaking pre-assigned roles not visually highlighted (minor), and (2) lobby reconnection flaky with single attempt instead of retry loop (major).

Purpose: Gap 2 causes confusing UX after matchmaking. Gap 4 makes lobby reconnection unreliable -- the single attempt fires before the server processes the disconnect.
Output: LobbyScene.ts with proper role highlight after matchmaking and robust lobby reconnect retry loop.
</objective>

<execution_context>
@.claude/get-shit-done/workflows/execute-plan.md
@.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-multiplayer-lobbies/05-08-SUMMARY.md
@client/src/scenes/LobbyScene.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix matchmaking role highlight after lobby join</name>
  <files>client/src/scenes/LobbyScene.ts</files>
  <action>
  **Root cause:** In the matchFound handler (around line 496), after joining the lobby room, the code does:
  1. `this.selectedRole = data.assignedRole` (line 522) -- sets internal state
  2. `this.showLobbyView()` (line 525) -- which calls `this.selectedRole = null` at line 568, CLOBBERING the value just set
  3. A delayed `this.room.send('selectRole', ...)` at lines 528-531 -- bypasses the client-side `selectRole()` method which handles BOTH server message AND UI panel updaters

  **Fix:** Remove the manual `this.selectedRole = data.assignedRole` at line 522 and the entire `this.time.delayedCall(500, ...)` block at lines 528-531. Instead, AFTER calling `this.showLobbyView()`, call `this.selectRole(data.assignedRole)` which properly:
  - Sets `this.selectedRole`
  - Sends `room.send('selectRole', { role })` to server
  - Triggers `characterPanelUpdaters` for immediate green border

  The matchFound handler's lobby join success block should look like:

  ```typescript
  this.room = await this.client.joinById(data.lobbyRoomId, {
    name: this.playerName,
    fromMatchmaking: true,
    preferredRole: data.assignedRole
  });

  console.log('Joined matchmaking lobby:', this.room.id);
  this.showLobbyView();

  // Select assigned role AFTER showLobbyView (which resets selectedRole)
  // Use a short delay to ensure characterPanelUpdaters are registered
  this.time.delayedCall(100, () => {
    if (this.room && data.assignedRole) {
      this.selectRole(data.assignedRole);
    }
  });
  ```

  Key differences from the broken version:
  - Removed `this.selectedRole = data.assignedRole` before showLobbyView (it gets clobbered)
  - Call `this.selectRole()` instead of `this.room.send()` -- selectRole() handles BOTH server AND UI
  - Reduced delay from 500ms to 100ms (just need panels registered, not full sync)
  </action>
  <verify>
  Run `cd /Users/jonasbrandvik/Projects/banger-game/client && npx tsc --noEmit` -- must pass.
  Grep for "this.selectRole(data.assignedRole)" in LobbyScene.ts -- must exist in matchFound handler.
  Grep to confirm NO bare `this.room.send('selectRole'` exists in the matchFound handler (the selectRole method handles sending).
  </verify>
  <done>
  After matchmaking places a player into a lobby, the assigned role is visually highlighted with a green border immediately. The selectRole() method handles both server communication and UI updates in a single call.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add retry loop to lobby reconnection</name>
  <files>client/src/scenes/LobbyScene.ts</files>
  <action>
  **Root cause:** Lobby reconnection (around line 51) makes a single `this.client.reconnect(token)` attempt with no retries. The server needs ~9s (ping timeout) to detect an F5 disconnect and register the token in its `_reconnections` map. The single client attempt fires in ~1s, well before the server is ready. The game reconnection path (lines 114-132) already has MAX_RETRIES=12 with RETRY_DELAY=1000ms -- this exact pattern needs to be applied to lobby reconnection.

  **Fix:** Replace the single reconnect attempt in checkReconnection() (the lobby token block, around lines 50-64) with a retry loop matching the game reconnection pattern:

  ```typescript
  // Attempt lobby reconnection with retries (server needs ~9s to process F5 disconnect)
  const LOBBY_MAX_RETRIES = 12;
  const LOBBY_RETRY_DELAY = 1000; // ms

  let reconnectedLobby: Room | null = null;

  for (let attempt = 1; attempt <= LOBBY_MAX_RETRIES; attempt++) {
    try {
      reconnectedLobby = await this.client.reconnect(token);
      console.log(`Successfully reconnected to lobby on attempt ${attempt}`);
      break;
    } catch (e) {
      console.log(`Lobby reconnection attempt ${attempt}/${LOBBY_MAX_RETRIES} failed:`, e);
      if (attempt < LOBBY_MAX_RETRIES) {
        await new Promise(resolve => setTimeout(resolve, LOBBY_RETRY_DELAY));
        text.setText(`Reconnecting to lobby... (attempt ${attempt + 1}/${LOBBY_MAX_RETRIES})`);
      }
    }
  }

  if (reconnectedLobby) {
    this.room = reconnectedLobby;
    console.log('Reconnected to lobby:', this.room.id);

    // Update stored token
    if (this.room.reconnectionToken) {
      localStorage.setItem('bangerLobbyRoom', JSON.stringify({
        token: this.room.reconnectionToken,
        roomId: this.room.id,
        timestamp: Date.now()
      }));
    }

    this.showLobbyView();
    return;
  } else {
    console.log('All lobby reconnection attempts failed');
    localStorage.removeItem('bangerLobbyRoom');
    this.clearUI();
    // Fall through to check game token or show menu
  }
  ```

  This replaces the existing single-attempt try/catch block (lines ~50-69). The `text` variable (the yellow "Reconnecting to lobby..." text created at line 45-47) is already in scope and should be updated with attempt progress.

  Make sure the status text shows attempt count so the user sees progress during the 12-second retry window, matching the behavior they already see for game reconnection.
  </action>
  <verify>
  Run `cd /Users/jonasbrandvik/Projects/banger-game/client && npx tsc --noEmit` -- must pass.
  Grep for "LOBBY_MAX_RETRIES" in LobbyScene.ts -- must find retry constant.
  Grep for "LOBBY_RETRY_DELAY" in LobbyScene.ts -- must find delay constant.
  Grep for "attempt.*LOBBY_MAX_RETRIES" in LobbyScene.ts -- must find retry loop.
  Confirm no single bare `this.client.reconnect(token)` without retry remains for the lobby path.
  </verify>
  <done>
  Lobby reconnection uses 12 retries with 1000ms delay, giving a 12-second reconnection window that exceeds the server's ~9s ping timeout for disconnect detection. Status text shows attempt progress. Matches the proven game reconnection pattern.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/jonasbrandvik/Projects/banger-game/client && npx tsc --noEmit` passes
2. Matchmaking role highlight: selectRole() called after showLobbyView()
3. Lobby reconnect: retry loop with 12 attempts and 1000ms delay
4. No regression to existing lobby flow (showMainMenu, createPrivateRoom, joinPrivateRoom)
</verification>

<success_criteria>
- Matchmaking-assigned roles show green border immediately on lobby entry
- Lobby F5 reconnection works reliably within 12-second retry window
- Status text shows reconnection attempt progress
- Both fixes pass TypeScript compilation
</success_criteria>

<output>
After completion, create `.planning/phases/05-multiplayer-lobbies/05-11-SUMMARY.md`
</output>
