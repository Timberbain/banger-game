---
phase: 05-multiplayer-lobbies
plan: 03
type: execute
wave: 3
depends_on: ["05-01", "05-02"]
files_modified:
  - server/src/rooms/GameRoom.ts
  - client/src/scenes/GameScene.ts
  - client/src/scenes/LobbyScene.ts
autonomous: true

must_haves:
  truths:
    - "Player who disconnects during active match can rejoin within 60 seconds"
    - "Reconnecting player resumes from current game state without data loss"
    - "Client stores reconnection token in localStorage for browser refresh survival"
    - "Client checks for active session on load and attempts reconnection before showing lobby"
    - "Grace period expiration removes player and triggers win condition check"
    - "Disconnected player shown as disconnected to other players"
  artifacts:
    - path: "server/src/rooms/GameRoom.ts"
      provides: "Reconnection grace period in onLeave with allowReconnection"
      contains: "allowReconnection"
    - path: "client/src/scenes/GameScene.ts"
      provides: "Client-side reconnection handling with localStorage token persistence"
      contains: "reconnect"
    - path: "client/src/scenes/LobbyScene.ts"
      provides: "Reconnection check on scene create before showing lobby menu"
      contains: "checkReconnection"
  key_links:
    - from: "server/src/rooms/GameRoom.ts"
      to: "colyseus allowReconnection"
      via: "Grace period in onLeave"
      pattern: "allowReconnection.*60"
    - from: "client/src/scenes/GameScene.ts"
      to: "localStorage"
      via: "Store reconnection token on join"
      pattern: "localStorage\\.setItem.*bangerActiveRoom"
    - from: "client/src/scenes/LobbyScene.ts"
      to: "client/src/scenes/GameScene.ts"
      via: "Reconnection bypass to GameScene"
      pattern: "client\\.reconnect"
---

<objective>
Add reconnection support: server-side grace period on GameRoom, client-side token persistence in localStorage, and automatic reconnection check on app load.

Purpose: Players who disconnect during an active match (network drop, browser refresh) can rejoin within 60 seconds without losing their place.
Output: Working reconnection flow that survives browser refresh and network interruptions.
</objective>

<execution_context>
@/Users/jonasbrandvik/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jonasbrandvik/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-multiplayer-lobbies/05-RESEARCH.md
@.planning/phases/05-multiplayer-lobbies/05-01-SUMMARY.md
@.planning/phases/05-multiplayer-lobbies/05-02-SUMMARY.md

@server/src/rooms/GameRoom.ts
@client/src/scenes/GameScene.ts
@client/src/scenes/LobbyScene.ts
@shared/lobby.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add reconnection grace period to GameRoom and connected flag to Player schema</name>
  <files>
    server/src/rooms/GameRoom.ts
    server/src/schema/GameState.ts
  </files>
  <action>
    **server/src/schema/GameState.ts:**
    - Add `@type("boolean") connected: boolean = true;` field to `Player` class
    - This field syncs to clients so they can show disconnected player status

    **server/src/rooms/GameRoom.ts:**
    - Import `LOBBY_CONFIG` from `shared/lobby.ts` for `MATCH_RECONNECT_GRACE` constant
    - **Modify `onLeave(client, consented)`:**
      - Get player from state (don't delete yet)
      - If player doesn't exist: return early
      - Mark `player.connected = false`
      - If `consented === true`:
        - Player intentionally left — delete player, delete stats, check win conditions
        - This is the current behavior, keep it
      - If `consented === false` AND `matchState === PLAYING`:
        - try/catch block:
        - `await this.allowReconnection(client, LOBBY_CONFIG.MATCH_RECONNECT_GRACE)` (60s)
        - On success: `player.connected = true`, `player.inputQueue = []` (clear stale inputs), log reconnection
        - On catch: delete player from state, keep stats for display, check win conditions
      - If `consented === false` AND matchState is NOT PLAYING (WAITING or ENDED):
        - Delete player immediately (no point reconnecting to non-active match)
        - Check win conditions if was PLAYING

    - **Ensure player input is ignored while disconnected:**
      - In `fixedTick`, the existing `player.inputQueue` draining already handles this because disconnected players won't send inputs
      - BUT: when `player.connected === false`, also skip the "maintain velocity" fallback (the `!processedAny` block). Set velocity to 0 for disconnected players so they stop moving:
        ```
        if (!player.connected) {
          player.vx = 0;
          player.vy = 0;
          player.inputQueue = [];
          return; // Skip all processing for disconnected player
        }
        ```
      - Place this check at the start of the player forEach in fixedTick, AFTER the dead player check

    - **Do NOT change autoDispose behavior** — room should still auto-dispose when empty. The `allowReconnection` keeps the client "virtually present" so the room doesn't see 0 clients.
  </action>
  <verify>
    `cd /Users/jonasbrandvik/Projects/banger-game/server && npx tsc --noEmit` compiles. Verify `allowReconnection` is called in onLeave. Verify Player schema has `connected` field. Verify disconnected players are frozen in fixedTick.
  </verify>
  <done>
    GameRoom supports 60s reconnection grace period during active matches. Disconnected players are frozen in place and shown as disconnected to other clients. Grace period expiration removes player and checks win conditions.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add client-side reconnection token persistence and auto-reconnect</name>
  <files>
    client/src/scenes/GameScene.ts
    client/src/scenes/LobbyScene.ts
    client/src/scenes/VictoryScene.ts
  </files>
  <action>
    **client/src/scenes/GameScene.ts:**
    - After successfully connecting to game room (both direct and lobby-transitioned), store reconnection token:
      ```typescript
      localStorage.setItem("bangerActiveRoom", JSON.stringify({
        token: this.room.reconnectionToken,
        timestamp: Date.now()
      }));
      ```
    - On `room.onLeave` event:
      - If match is ended (matchEnded flag): clear localStorage (`localStorage.removeItem("bangerActiveRoom")`)
      - If match is NOT ended (unexpected disconnect): show "Reconnecting..." overlay text. Do NOT clear localStorage.
      - Attempt reconnect: `const room = await this.client.reconnect(storedToken)` in try/catch
      - On success: update `this.room`, re-attach all state listeners (onAdd, onChange, onMessage), hide overlay, update localStorage with new token
      - On failure: show "Connection lost. Returning to lobby..." text, clear localStorage, transition to LobbyScene after 3s delay
    - On intentional leave (VictoryScene "Return to Lobby" button): clear localStorage before leaving
    - Add `connected` field rendering: when iterating player sprites, if `player.connected === false`, set sprite alpha to 0.3 and add "DC" label

    **client/src/scenes/LobbyScene.ts:**
    - In `create()`, BEFORE showing the menu, call `checkReconnection()`
    - `async checkReconnection()`:
      - Read `localStorage.getItem("bangerActiveRoom")`
      - If no stored session: show menu normally, return
      - Parse stored JSON: `{ token, timestamp }`
      - Check expiration: if `Date.now() - timestamp > (LOBBY_CONFIG.MATCH_RECONNECT_GRACE * 1000) + 30000` (grace period + 30s buffer), clear storage, show menu, return
      - Show "Reconnecting to match..." text
      - try: `const room = await this.client.reconnect(token)`
      - On success: `this.scene.start("GameScene", { room })` — go directly to game
      - On failure: clear localStorage, show "Session expired" text briefly, then show menu

    **client/src/scenes/VictoryScene.ts:**
    - Update "Return to Lobby" button handler: clear `localStorage.removeItem("bangerActiveRoom")` before transitioning
    - Change transition target from `"BootScene"` to `"LobbyScene"` (if not already done in Plan 02)
  </action>
  <verify>
    `cd /Users/jonasbrandvik/Projects/banger-game/client && npx tsc --noEmit` compiles. Verify GameScene stores reconnection token in localStorage. Verify LobbyScene checks for active session before showing menu. Verify VictoryScene clears localStorage.
  </verify>
  <done>
    Client persists reconnection token in localStorage on game join. On unexpected disconnect, client auto-attempts reconnection. On app load/lobby entry, checks for active session and reconnects if within grace period. Intentional leave clears stored session.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/jonasbrandvik/Projects/banger-game/server && npx tsc --noEmit` passes
2. `cd /Users/jonasbrandvik/Projects/banger-game/client && npx tsc --noEmit` passes
3. GameRoom onLeave calls allowReconnection with 60s for non-consented leaves during PLAYING
4. Player schema has `connected` boolean field synced to clients
5. Disconnected players frozen in fixedTick (vx=0, vy=0, input drained)
6. Client stores reconnection token in localStorage on game join
7. Client auto-reconnects on unexpected disconnect
8. LobbyScene checks localStorage for active session before showing menu
9. VictoryScene clears localStorage on "Return to Lobby"
10. Disconnected players shown at 30% opacity with "DC" label on other clients
</verification>

<success_criteria>
- Server and client compile without errors
- 60s reconnection grace period works on GameRoom
- Client persists and uses reconnection token across browser refresh
- LobbyScene auto-reconnects to active match if token valid
- Disconnected players visually indicated to remaining players
- Grace period expiration properly triggers win condition check
</success_criteria>

<output>
After completion, create `.planning/phases/05-multiplayer-lobbies/05-03-SUMMARY.md`
</output>
