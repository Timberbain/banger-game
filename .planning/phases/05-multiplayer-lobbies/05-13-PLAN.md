---
phase: 05-multiplayer-lobbies
plan: 13
type: execute
wave: 1
depends_on: []
files_modified: [client/src/scenes/LobbyScene.ts]
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "WASD keys type characters into the room code HTML input field after returning from a match"
  artifacts:
    - path: "client/src/scenes/LobbyScene.ts"
      provides: "showJoinInput with correct event listener ordering"
      contains: "addEventListener.*focus"
  key_links:
    - from: "htmlInput focus event"
      to: "disableGlobalCapture()"
      via: "addEventListener registered before focus() call"
      pattern: "addEventListener.*focus.*\\n.*disableGlobalCapture"
---

<objective>
Fix race condition where WASD keys do not work in the room code HTML input field after returning from a match.

Purpose: The focus event listener that calls disableGlobalCapture() is registered AFTER htmlInput.focus() is called. Since focus() fires synchronously, the listener misses the initial focus event and Phaser's global keyboard captures (from GameScene's addKeys) continue intercepting WASD keystrokes via preventDefault().

Output: Working WASD input in room code field regardless of prior scene history.
</objective>

<execution_context>
@/Users/jonasbrandvik/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jonasbrandvik/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@client/src/scenes/LobbyScene.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix focus event listener registration order in showJoinInput</name>
  <files>client/src/scenes/LobbyScene.ts</files>
  <action>
In the showJoinInput() method of LobbyScene.ts, reorder the code so that the focus and blur event listeners are registered BEFORE the htmlInput.focus() call.

Current order (broken):
1. document.body.appendChild(this.htmlInput)  (line 298)
2. this.htmlInput.focus()                      (line 299)
3. addEventListener('focus', ...)              (line 302)
4. addEventListener('blur', ...)               (line 308)

Required order (fixed):
1. document.body.appendChild(this.htmlInput)
2. addEventListener('focus', ...)
3. addEventListener('blur', ...)
4. this.htmlInput.focus()

This ensures that when focus() fires the synchronous focus event, the listener is already registered and disableGlobalCapture() executes immediately. No other changes needed — the listener bodies and blur handler remain identical.
  </action>
  <verify>
1. Build client: cd client && npm run build (no errors)
2. Manual verification sequence:
   - Start server and client
   - Create a lobby, start a match with 3 players, let match end
   - Return to lobby, click "Join Game"
   - Type WASD characters into the room code input — all 4 keys should produce characters in the input field
  </verify>
  <done>WASD keys type characters into the room code HTML input field after returning from a match. The focus event listener fires on the initial focus() call, disabling Phaser's global keyboard capture before any keystrokes occur.</done>
</task>

</tasks>

<verification>
- Client builds without errors
- After returning from a completed match to LobbyScene, clicking "Join Game" and typing WASD produces characters in the input field
- Phaser keyboard input still works correctly in GameScene (not broken by the reorder)
</verification>

<success_criteria>
WASD keys function as normal text input in the room code field regardless of whether the player has just returned from a match or is on a fresh page load.
</success_criteria>

<output>
After completion, create `.planning/phases/05-multiplayer-lobbies/05-13-SUMMARY.md`
</output>
