---
phase: 05-multiplayer-lobbies
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - client/src/scenes/LobbyScene.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Private room code displayed prominently in yellow at the top of lobby view"
    - "Selected character gets a green border (4px stroke) when clicked"
    - "Character availability updates in real-time as other players select"
  artifacts:
    - path: "client/src/scenes/LobbyScene.ts"
      provides: "Room code display via state listener, character selection highlight"
      contains: "listen.*roomCode"
  key_links:
    - from: "client/src/scenes/LobbyScene.ts"
      to: "server LobbyState.roomCode"
      via: "room.state.listen('roomCode') callback"
      pattern: "listen.*roomCode"
    - from: "client/src/scenes/LobbyScene.ts"
      to: "server LobbyPlayer.role"
      via: "player.onChange within onAdd callback"
      pattern: "onAdd.*onChange.*updatePanel"
---

<objective>
Fix two client UI issues: room code not displaying and character selection not highlighting.

Purpose: Without the room code, players cannot share their private room. Without character highlight, players cannot see which character they selected. Both are core lobby usability issues.

Output: Room code appears in yellow when state syncs; clicking a character immediately shows green border; character availability updates in real-time.
</objective>

<execution_context>
@/Users/jonasbrandvik/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jonasbrandvik/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-multiplayer-lobbies/05-02-SUMMARY.md
@.planning/phases/05-multiplayer-lobbies/05-UAT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix room code display with state listener</name>
  <files>client/src/scenes/LobbyScene.ts</files>
  <action>
**Root cause:** `showLobbyView()` checks `this.room.state.roomCode` synchronously (line 393), but Colyseus initial state sync has not arrived yet when this method runs. The roomCode is still an empty string, so the condition `this.room.state.isPrivate && this.room.state.roomCode` is false.

**Fix:** Replace the synchronous room code check (lines 392-401) with a `room.state.listen('roomCode')` callback that creates/updates the room code text whenever the value changes.

In `showLobbyView()`, replace the existing room code block (lines 392-401):
```typescript
// Room code display (if private)
if (this.room.state.isPrivate && this.room.state.roomCode) {
  const codeLabel = this.add.text(400, 40, `Room Code: ${this.room.state.roomCode}`, {
    fontSize: '28px',
    color: '#ffff00',
    fontStyle: 'bold',
    fontFamily: 'monospace'
  }).setOrigin(0.5);
  this.uiElements.push(codeLabel);
}
```

With a listener-based approach:
```typescript
// Room code display -- use listener because state may not be synced yet
let codeLabel: Phaser.GameObjects.Text | null = null;

const updateRoomCode = (value: string) => {
  if (value && this.room?.state.isPrivate) {
    if (!codeLabel) {
      codeLabel = this.add.text(400, 40, `Room Code: ${value}`, {
        fontSize: '28px',
        color: '#ffff00',
        fontStyle: 'bold',
        fontFamily: 'monospace'
      }).setOrigin(0.5);
      this.uiElements.push(codeLabel);
    } else {
      codeLabel.setText(`Room Code: ${value}`);
    }
  }
};

// Show immediately if already synced
if (this.room.state.roomCode) {
  updateRoomCode(this.room.state.roomCode);
}

// Also listen for changes (handles race condition)
this.room.state.listen('roomCode', (value: string) => {
  updateRoomCode(value);
});
```

This ensures the room code displays whether the state has already synced or arrives later.
  </action>
  <verify>
Run `cd /Users/jonasbrandvik/Projects/banger-game/client && npx tsc --noEmit` -- must pass.
Grep for `listen.*roomCode` in LobbyScene.ts -- must find it.
  </verify>
  <done>
Room code text is created/updated via state listener, handling the race condition where showLobbyView() runs before initial state sync.
  </done>
</task>

<task type="auto">
  <name>Task 2: Fix character selection highlight and real-time availability</name>
  <files>client/src/scenes/LobbyScene.ts</files>
  <action>
**Root cause (two bugs):**

1. `onAdd` callback (line 560) only calls `updatePanel()` once but does NOT register `onChange` on the newly added player. So when a new player joins and selects a role, their role change never triggers updatePanel(). The existing code at line 561-563 registers onChange on players that exist at the time `createCharacterSelection()` runs, but misses players who join later.

2. `selectRole()` (lines 670-675) sets `this.selectedRole` locally and sends a message to the server, but does NOT trigger any immediate visual update. The green border only appears when the onChange callback fires (which is broken per bug #1).

**Fix bug #1:** In `createCharacterSelection()`, update the `onAdd` callback (around line 559-564) to also register onChange on the newly added player:

Replace:
```typescript
if (this.room) {
  this.room.state.players.onAdd(() => updatePanel());
  this.room.state.players.forEach((player: any) => {
    player.onChange(() => updatePanel());
  });
}
```

With:
```typescript
if (this.room) {
  this.room.state.players.onAdd((player: any) => {
    updatePanel();
    // Register onChange on NEWLY ADDED players too
    player.onChange(() => updatePanel());
  });
  // Register on existing players
  this.room.state.players.forEach((player: any) => {
    player.onChange(() => updatePanel());
  });
  // Also listen for removals (role becomes available again)
  this.room.state.players.onRemove(() => updatePanel());
}
```

Note: The key difference is `onAdd((player: any) => {` with the player parameter, then calling `player.onChange(() => updatePanel())` inside.

**Fix bug #2:** In `selectRole()` (lines 670-675), add an immediate call to refresh all character panels after setting the local selectedRole. The simplest approach is to trigger `updatePanel` for all panels.

Since `updatePanel` is local to each character panel's forEach iteration and cannot be called externally, refactor the approach: store the updatePanel functions in an array, and call them all from selectRole().

Add a class property at the top of the class (near line 11):
```typescript
private characterPanelUpdaters: (() => void)[] = [];
```

In `createCharacterSelection()`, push each `updatePanel` function to the array. At the start of `createCharacterSelection()`, clear the array:
```typescript
this.characterPanelUpdaters = [];
```

Inside each character's forEach iteration, after defining `updatePanel`, add:
```typescript
this.characterPanelUpdaters.push(updatePanel);
```

Then update `selectRole()` to call all updaters immediately:
```typescript
private selectRole(role: string) {
  if (this.room) {
    this.selectedRole = role;
    this.room.send('selectRole', { role });
    // Immediate optimistic UI update
    this.characterPanelUpdaters.forEach(fn => fn());
  }
}
```

After both fixes, run `cd /Users/jonasbrandvik/Projects/banger-game/client && npx tsc --noEmit` to verify compilation.
  </action>
  <verify>
Run `cd /Users/jonasbrandvik/Projects/banger-game/client && npx tsc --noEmit` -- must pass.
Grep for `characterPanelUpdaters` in LobbyScene.ts -- must find class property and usage in selectRole.
Grep for `onAdd.*player.*onChange` in LobbyScene.ts (in createCharacterSelection context) -- must find onChange registration inside onAdd.
  </verify>
  <done>
Character panels update immediately on click (optimistic UI via characterPanelUpdaters), and onAdd registers onChange on newly added players so remote role selections update availability in real-time.
  </done>
</task>

</tasks>

<verification>
1. LobbyScene has `room.state.listen('roomCode', ...)` for race-condition-safe display
2. Character selection triggers immediate visual update via `characterPanelUpdaters`
3. `onAdd` callback registers `onChange` on new players for real-time availability
4. `onRemove` callback refreshes panels when player leaves (role becomes available)
5. Client compiles without errors
</verification>

<success_criteria>
- Room code appears in yellow at top of lobby view even when state sync arrives after UI render
- Clicking a character panel immediately shows green 4px border
- Other players' role selections update panel availability in real-time
- Client TypeScript compiles cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/05-multiplayer-lobbies/05-05-SUMMARY.md`
</output>
