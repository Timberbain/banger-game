---
phase: 05.1-arena-collisions-contact-kill
plan: 02
subsystem: game-physics
tags: [collision, server-authoritative, contact-kill, destructible-obstacles, tile-collision]

requires:
  - phase: 05.1-01
    provides: CollisionGrid class, resolveCollisions function, OBSTACLE_TILE_IDS, OBSTACLE_TIER_HP
  - phase: 04-match-lifecycle-maps
    provides: Map JSON files, GameRoom with fixedTick, MapMetadata
provides:
  - Server-side tile collision enforcement for all players (every tick, both input and no-input paths)
  - Paran contact kill mechanic (instant death for guardians on body overlap)
  - Destructible obstacle HP system with Schema-based sync to clients
  - Projectile-wall/obstacle collision with destructible HP reduction
  - ObstacleState schema with tileX, tileY, hp, maxHp, destroyed fields
  - ARENA height fix (608px matching 19x32px map dimensions)
affects: [05.1-03-client-prediction-destructible-sync]

tech-stack:
  added: []
  patterns: [resolvePlayerCollision-helper, per-physics-step-collision, contact-kill-circle-overlap]

key-files:
  created:
    - server/src/schema/Obstacle.ts
  modified:
    - server/src/schema/GameState.ts
    - server/src/rooms/GameRoom.ts
    - shared/physics.ts

key-decisions:
  - "Collision resolution after EACH applyMovementPhysics call (not once at end) for precision"
  - "Paran contact kill uses circle overlap (dist < playerRadius*2), Paran keeps velocity"
  - "Projectile center-point tile check sufficient (4px radius vs 32px tile)"
  - "Edge clamp kept as safety net only, no velocity zeroing from edge clamp"

patterns-established:
  - "resolvePlayerCollision: helper wrapping resolveCollisions + role-specific velocity response + Paran destructible break"
  - "Per-physics-step collision: save prevX/prevY before each applyMovementPhysics, resolve after"

duration: 3min
completed: 2026-02-12
---

# Phase 05.1 Plan 02: Server-Side Collision Enforcement Summary

**Server-authoritative tile collision, Paran contact kill (instant guardian death on body overlap), and destructible obstacle HP system with ObstacleState Schema sync**

## Performance

- **Duration:** 3 min
- **Started:** 2026-02-12T07:03:59Z
- **Completed:** 2026-02-12T07:07:19Z
- **Tasks:** 2
- **Files modified:** 4

## Accomplishments
- Full server-side tile collision enforcement running every tick in both input-processing and no-input code paths (prevents clipping during network gaps)
- Paran contact kill: instant death for any guardian when Paran body overlaps (circle check, dist < playerRadius*2), Paran maintains velocity
- Paran loses ALL velocity (vx+vy) on any wall or obstacle hit; guardians stop only on the colliding axis
- Paran instantly destroys any destructible obstacle on contact (HP zeroed, cleared from grid, synced via Schema)
- Projectiles destroyed on solid tile contact; destructible obstacles take 1HP per projectile hit
- ObstacleState schema (uint8 tileX/tileY/hp/maxHp, boolean destroyed) added to GameState for client sync
- ARENA height fixed from 600 to 608 matching actual map pixel dimensions (19 tiles x 32px)

## Task Commits

Each task was committed atomically:

1. **Task 1: Create ObstacleState schema, update GameState, fix ARENA** - `88c6fd7` (feat)
2. **Task 2: Implement collision enforcement, contact kill, destructible obstacles** - `f701b0a` (feat)

## Files Created/Modified
- `server/src/schema/Obstacle.ts` - ObstacleState schema with tileX, tileY, hp, maxHp, destroyed fields
- `server/src/schema/GameState.ts` - Added obstacles MapSchema<ObstacleState> import and field
- `server/src/rooms/GameRoom.ts` - CollisionGrid loading in onCreate, resolvePlayerCollision helper, Paran contact kill, projectile-wall collision, destructible obstacle HP system
- `shared/physics.ts` - ARENA.height 600 -> 608 to match map dimensions

## Decisions Made
- Collision resolution runs after EACH applyMovementPhysics call individually (not once at end of input queue) for maximum precision during rapid direction changes
- Paran contact kill uses circle overlap check (dist < COMBAT.playerRadius * 2) -- one-directional: only Paran kills guardians, not vice versa
- Projectile-wall check uses center-point tile lookup (projectile radius 4px is small relative to 32px tiles, so center check is sufficient)
- Old edge-clamping code simplified to safety-net-only (no velocity zeroing) since tile border walls now handle all collision response
- Map JSON loaded via fs.readFileSync with path relative to __dirname (ts-node-dev: server/src/rooms/ -> client/public/)

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
None.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Server now fully enforces tile collisions and contact kills -- ready for client-side prediction alignment (Plan 03)
- ObstacleState schema syncing to clients enables destructible obstacle rendering on client
- CollisionGrid instance exists on server and can be replicated on client for prediction

## Self-Check: PASSED

All 4 created/modified files verified on disk. Both task commits (88c6fd7, f701b0a) verified in git log.

---
*Phase: 05.1-arena-collisions-contact-kill*
*Completed: 2026-02-12*
