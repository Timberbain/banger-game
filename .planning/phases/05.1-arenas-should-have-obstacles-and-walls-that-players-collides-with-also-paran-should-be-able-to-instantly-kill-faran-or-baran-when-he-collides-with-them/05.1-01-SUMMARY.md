---
phase: 05.1-arena-collisions-contact-kill
plan: 01
subsystem: game-physics
tags: [collision, tilemap, aabb, obstacles, destructible]

requires:
  - phase: 04-match-lifecycle-maps
    provides: Map JSON files, MAPS registry, tileset PNG
provides:
  - CollisionGrid class for AABB-vs-tile collision detection
  - resolveCollisions function with axis-separated resolution
  - OBSTACLE_TILES constants (wall=3, heavy=4, medium=5, light=6)
  - OBSTACLE_TIER_HP mapping (heavy=5HP, medium=3HP, light=2HP)
  - OBSTACLE_TILE_IDS sets for fast tile classification
  - Expanded tileset with 3 visually distinct obstacle tile graphics
  - 4 updated map JSON files with strategically placed destructible obstacles
affects: [05.1-02-server-collision-enforcement, 05.1-03-client-prediction-destructible-sync]

tech-stack:
  added: []
  patterns: [shared-module-no-deps, axis-separated-collision-resolution]

key-files:
  created:
    - shared/collisionGrid.ts
    - shared/obstacles.ts
  modified:
    - client/public/tilesets/placeholder.png
    - client/public/maps/test_arena.json
    - client/public/maps/corridor_chaos.json
    - client/public/maps/cross_fire.json
    - client/public/maps/pillars.json

key-decisions:
  - "Pure TypeScript collision grid with no Phaser/server deps for shared use"
  - "Axis-separated AABB resolution (X first with prevY, then Y with resolved X)"
  - "Three obstacle tiers: Heavy(5HP brown), Medium(3HP orange), Light(2HP gold)"
  - "Corridor_chaos corridors shifted to clear guardian spawn point at tile(3,3)"

patterns-established:
  - "CollisionGrid: parse Tiled JSON wall layer into 2D TileInfo grid with Set-based classification"
  - "resolveCollisions: axis-separated push-back using movement direction for stable resolution"

duration: 7min
completed: 2026-02-12
---

# Phase 05.1 Plan 01: Shared Collision Infrastructure Summary

**AABB-vs-tile collision grid with axis-separated resolution, 3-tier obstacle constants, and 4 maps updated with destructible obstacle layouts**

## Performance

- **Duration:** 7 min
- **Started:** 2026-02-12T06:53:35Z
- **Completed:** 2026-02-12T07:01:00Z
- **Tasks:** 2
- **Files modified:** 7

## Accomplishments
- CollisionGrid class parses Tiled JSON wall layer data into queryable 2D grid with solid/destructible classification
- resolveCollisions function performs axis-separated AABB-vs-tile collision with stable push-back resolution
- Three distinct obstacle tiers with HP values (Heavy=5, Medium=3, Light=2) and visual tileset tiles
- All 4 arena maps updated with strategically placed destructible obstacles (14, 8, 10, 6 obstacles respectively)
- All spawn points verified clear, all map borders intact, TypeScript compiles cleanly for both server and client

## Task Commits

Each task was committed atomically:

1. **Task 1: Create shared collision grid and obstacle constants** - `6969430` (feat)
2. **Task 2: Expand tileset and update all 4 map JSON files** - `b8f1b9a` (feat)

## Files Created/Modified
- `shared/collisionGrid.ts` - CollisionGrid class, TileInfo/CollidableEntity interfaces, resolveCollisions function
- `shared/obstacles.ts` - OBSTACLE_TILES constants, OBSTACLE_TIER_HP mapping, OBSTACLE_TILE_IDS classification sets
- `client/public/tilesets/placeholder.png` - Added heavy (brown), medium (orange), light (gold) obstacle tiles
- `client/public/maps/test_arena.json` - 14 destructibles (5M + 9L) in scattered center clusters
- `client/public/maps/corridor_chaos.json` - 8 destructibles (1H + 3M + 4L) inside corridor paths
- `client/public/maps/cross_fire.json` - 10 destructibles (2H + 4M + 4L) near center cross
- `client/public/maps/pillars.json` - 6 destructibles (2M + 4L) as barricades between pillar pairs

## Decisions Made
- Pure TypeScript collision grid with no Phaser or server dependencies, enabling shared use by both server and client prediction
- Axis-separated AABB resolution (resolve X first using prevY for stability, then Y using resolved X) for robust corner handling
- Three obstacle tiers with distinct colors: Heavy=brown(5HP), Medium=orange(3HP), Light=gold(2HP)
- Corridor_chaos corridor walls shifted 2 tiles right to accommodate guardian1 spawn at tile(3,3)

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed corridor_chaos guardian spawn blocked by wall**
- **Found during:** Task 2 (Map JSON updates)
- **Issue:** Guardian1 spawn at pixel(100,100) maps to tile(3,3) which was inside an existing corridor wall structure
- **Fix:** Shifted corridor wall columns from col 3 to col 5 in corridor_chaos layout, keeping corridor structure intact
- **Files modified:** client/public/maps/corridor_chaos.json
- **Verification:** Spawn point tile(3,3) confirmed empty (tileId=0)
- **Committed in:** b8f1b9a (Task 2 commit)

**2. [Rule 1 - Bug] Fixed cross_fire left border gap at row 9**
- **Found during:** Task 2 (Map JSON updates)
- **Issue:** Original cross_fire map had open left border at row 9 (cross arm extending to edge), could allow players to exit arena
- **Fix:** Set tile(0,9) to wall (tileId=3) to close the border gap
- **Files modified:** client/public/maps/cross_fire.json
- **Verification:** All border tiles verified as wall (tileId=3)
- **Committed in:** b8f1b9a (Task 2 commit)

---

**Total deviations:** 2 auto-fixed (2 bugs)
**Impact on plan:** Both fixes ensure gameplay correctness (valid spawn positions, closed arena borders). No scope creep.

## Issues Encountered
None beyond the auto-fixed deviations above.

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Collision grid and obstacle constants ready for server-side enforcement (Plan 02)
- Maps contain destructible obstacles ready for server HP tracking and sync (Plan 03)
- Tileset ready for client-side rendering of obstacle tiers

## Self-Check: PASSED

All 7 created/modified files verified on disk. Both task commits (6969430, b8f1b9a) verified in git log.

---
*Phase: 05.1-arena-collisions-contact-kill*
*Completed: 2026-02-12*
