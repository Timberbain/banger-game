---
phase: 05.1-arena-collisions-contact-kill
plan: 04
subsystem: physics
tags: [collision, aabb, tile-resolution, epsilon, math-floor, shared]

# Dependency graph
requires:
  - phase: 05.1-arena-collisions-contact-kill (plan 01)
    provides: CollisionGrid class and resolveCollisions function
provides:
  - Symmetric AABB-vs-tile collision resolution for all 4 directions
  - COLLISION_EPSILON constant preventing Math.floor boundary re-collision
affects: [client-prediction, server-collision, future-map-changes]

# Tech tracking
tech-stack:
  added: []
  patterns: [epsilon-offset-for-tile-boundary-collision]

key-files:
  created: []
  modified: [shared/collisionGrid.ts]

key-decisions:
  - "COLLISION_EPSILON = 0.001 -- small enough to be invisible (sub-pixel) but large enough to prevent Math.floor boundary overlap"
  - "Epsilon applied to RIGHT/DOWN push-backs and right/bottom tile range calcs only -- LEFT/UP already correct due to Math.floor rounding behavior"

patterns-established:
  - "Epsilon offset pattern: when push-back lands entity edge exactly on tile boundary, subtract epsilon to prevent Math.floor mapping into the solid tile"

# Metrics
duration: 2min
completed: 2026-02-12
---

# Phase 05.1 Plan 04: Collision Boundary Fix Summary

**Fix Math.floor boundary asymmetry in AABB collision with COLLISION_EPSILON offset for symmetric right/bottom/left/top wall resolution**

## Performance

- **Duration:** 2 min
- **Started:** 2026-02-12T14:20:46Z
- **Completed:** 2026-02-12T14:22:21Z
- **Tasks:** 1
- **Files modified:** 1

## Accomplishments
- Fixed right/bottom wall collision jitter, super speed, and wall clipping
- Added COLLISION_EPSILON (0.001) constant for sub-pixel boundary offset
- Applied epsilon to 2 push-back positions (RIGHT, DOWN) and 4 tile range calculations (right/bottom in both X and Y axis blocks)
- Both server and client prediction get the fix automatically via shared import
- TypeScript compiles cleanly for both server and client

## Task Commits

Each task was committed atomically:

1. **Task 1: Fix Math.floor boundary asymmetry in resolveCollisions** - `b7ae276` (fix)

## Files Created/Modified
- `shared/collisionGrid.ts` - Added COLLISION_EPSILON constant, epsilon offset on RIGHT/DOWN push-backs, epsilon subtraction on right/bottom tile range calculations

## Decisions Made
- COLLISION_EPSILON = 0.001: sub-pixel offset large enough to prevent Math.floor(exactInteger/tileSize) mapping into the solid tile, small enough to be invisible to players
- Only RIGHT/DOWN push-backs and right/bottom tile range calcs modified; LEFT/UP already correct because Math.floor naturally rounds down away from the solid tile

## Deviations from Plan
None - plan executed exactly as written.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- All 4 UAT failure root causes (tests 1, 2, 4, 10) addressed by this single shared fix
- Previously passing tests (3, 5, 6, 7, 8, 9, 11, 12) unaffected by 0.001px epsilon
- Phase 05.1 gap closure complete; ready for Phase 6 (UX Polish)

## Self-Check: PASSED

- FOUND: shared/collisionGrid.ts
- FOUND: b7ae276 (Task 1 commit)
- FOUND: 05.1-04-SUMMARY.md

---
*Phase: 05.1-arena-collisions-contact-kill*
*Completed: 2026-02-12*
