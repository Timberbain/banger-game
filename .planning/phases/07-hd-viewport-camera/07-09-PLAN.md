---
phase: 07-hd-viewport-camera
plan: 09
type: execute
wave: 1
depends_on: []
files_modified:
  - client/src/scenes/GameScene.ts
  - client/src/scenes/HelpScene.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Match start overview reliably shows full arena then zooms to player for all 3 players, every match"
    - "Help screen text is fully contained within panel backgrounds with no horizontal overflow"
    - "Help screen elements have comfortable spacing with no text crowding"
  artifacts:
    - path: "client/src/scenes/GameScene.ts"
      provides: "overviewActive guard in createTilemap preventing camera clobber"
      contains: "overviewActive"
    - path: "client/src/scenes/HelpScene.ts"
      provides: "Properly sized panels with word-wrapped, well-spaced text"
      contains: "wordWrap"
  key_links:
    - from: "GameScene.createTilemap()"
      to: "GameScene.startMatchOverview()"
      via: "overviewActive flag guards camera setup"
      pattern: "this\\.overviewActive"
---

<objective>
Close two remaining UAT gaps from Phase 7 retest: (1) flaky match-start overview caused by createTilemap() clobbering an in-progress overview animation, and (2) help screen text overflowing panel containers with insufficient spacing.

Purpose: These are the final two issues blocking Phase 7 sign-off before moving to Phase 8.
Output: Two fixed source files, both gaps resolved.
</objective>

<execution_context>
@/Users/jonasbrandvik/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jonasbrandvik/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-hd-viewport-camera/07-07-SUMMARY.md
@.planning/phases/07-hd-viewport-camera/07-08-SUMMARY.md
@.planning/phases/07-hd-viewport-camera/07-retest-UAT.md
@.planning/debug/overview-camera-still-flaky.md
@.planning/debug/help-text-containment-spacing.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Guard createTilemap camera setup with overviewActive flag</name>
  <files>client/src/scenes/GameScene.ts</files>
  <action>
In createTilemap(), around lines 1325-1338, add an overviewActive guard so that the camera setup does NOT clobber an in-progress overview animation.

Specifically, change the camera setup block (lines 1325-1338) to:

1. Keep `cam.setBounds()` UNCONDITIONAL -- the overview needs correct bounds to centerOn properly.
2. Wrap `cam.setZoom(2)` in `if (!this.overviewActive)` -- when the overview is active, zoom is controlled by the overview animation (starts at 1.0, then zoomTo(2)).
3. Wrap the entire fallback follow block (lines 1332-1337) in the same `if (!this.overviewActive)` guard -- when overview is active, it will handle starting follow after the 1.5s delay.

The resulting code should look like:

```typescript
if (this.mapMetadata) {
  const cam = this.cameras.main;
  cam.setBounds(0, 0, this.mapMetadata.width, this.mapMetadata.height);

  if (!this.overviewActive) {
    cam.setZoom(2);

    // Fallback: if no overview animation is pending and camera isn't following anyone,
    // start following local player directly (safety net for any missed code path)
    if (!this.pendingOverview && !(cam as any)._follow && this.room) {
      const localSprite = this.playerSprites.get(this.room.sessionId);
      if (localSprite) {
        cam.startFollow(localSprite, true, 0.12, 0.12);
        cam.setDeadzone(20, 15);
      }
    }
  }
}
```

This fixes the race condition where: matchState='playing' arrives after mapMetadata is set (so startMatchOverview runs directly, not deferred), then tilemap assets finish loading and createTilemap fires during the 1.5s overview pause, resetting zoom to 2 and starting follow -- which destroys the overview animation.
  </action>
  <verify>
Read back the modified createTilemap method and confirm:
1. cam.setBounds is outside the overviewActive guard (unconditional)
2. cam.setZoom(2) is inside `if (!this.overviewActive)`
3. The fallback follow block is inside the same `if (!this.overviewActive)` guard
4. The pendingOverview deferred trigger at lines 1344-1347 is NOT affected (remains outside the guard)
5. TypeScript compiles: `cd /Users/jonasbrandvik/Projects/banger-game/client && npx tsc --noEmit`
  </verify>
  <done>createTilemap() no longer clobbers an in-progress overview animation -- cam.setZoom(2) and fallback follow are skipped when overviewActive is true, while setBounds remains unconditional</done>
</task>

<task type="auto">
  <name>Task 2: Fix HelpScene panel sizing, sprite position, word wrap, and line spacing</name>
  <files>client/src/scenes/HelpScene.ts</files>
  <action>
Fix four layout issues in the role panel section of HelpScene.create():

1. INCREASE PANEL HEIGHT (line 89): Change panel size from `280, 220` to `280, 260`. This gives 40px more vertical room. Update the panel center Y from `rolesY + 110` to `rolesY + 130` to keep the panel top at the same position (170) while extending the bottom edge from 390 to 430.

2. MOVE SPRITE DOWN (line 95): Change sprite Y from `rolesY + 10` to `rolesY + 45`. This places the sprite center at Y=215, with top edge at Y=183 (well inside panel top at Y=170). The sprite is 64px tall at 2x scale, so it needs its center at least 32px below the panel top edge.

3. ADD WORD WRAP TO DESCRIPTIONS (lines 126-133): Add `wordWrap: { width: 250 }` to the text style object for description lines. This constrains text to 250px (leaving 15px padding on each side of the 280px panel). The updated text creation:
```typescript
const descText = this.add.text(x, rolesY + 128 + lineIdx * 28, line, {
  fontSize: '13px',
  color: Colors.text.secondary,
  fontFamily: 'monospace',
  wordWrap: { width: 250 },
}).setOrigin(0.5);
```

4. INCREASE LINE SPACING (line 127): Change description line spacing from `lineIdx * 22` to `lineIdx * 28`. This increases the gap between description lines from ~9px to ~15px.

5. SHIFT NAME AND TAGLINE DOWN to match the new sprite position:
   - Role name Y: change from `rolesY + 50` to `rolesY + 85` (line 106)
   - Tagline Y: change from `rolesY + 72` to `rolesY + 105` (line 117)
   - Description start Y: change from `rolesY + 98` to `rolesY + 128` (line 127)

6. SHIFT WIN CONDITIONS SECTION DOWN to avoid overlap with taller panels:
   - winY: change from `480` to `510` (line 137)

7. SHIFT BACK BUTTON DOWN to maintain spacing:
   - Back button Y: change from `600` to `640` (line 169)

Summary of all Y-coordinate changes (rolesY = 170):
| Element          | Old Y offset     | New Y offset     | Old absolute | New absolute |
|------------------|------------------|------------------|--------------|--------------|
| Panel center     | rolesY + 110     | rolesY + 130     | 280          | 300          |
| Panel size       | 280 x 220        | 280 x 260        | -            | -            |
| Sprite           | rolesY + 10      | rolesY + 45      | 180          | 215          |
| Name             | rolesY + 50      | rolesY + 85      | 220          | 255          |
| Tagline          | rolesY + 72      | rolesY + 105     | 242          | 275          |
| Desc start       | rolesY + 98      | rolesY + 128     | 268          | 298          |
| Desc spacing     | 22px             | 28px             | -            | -            |
| winY             | 480              | 510              | 480          | 510          |
| Back button      | 600              | 640              | 600          | 640          |
  </action>
  <verify>
1. Read back the modified HelpScene.ts and confirm all 7 changes are applied correctly
2. Verify panel dimensions are 280x260
3. Verify wordWrap: { width: 250 } is present on description text
4. Verify description line spacing uses * 28 (not * 22)
5. Verify sprite Y is rolesY + 45
6. TypeScript compiles: `cd /Users/jonasbrandvik/Projects/banger-game/client && npx tsc --noEmit`
  </verify>
  <done>Help screen panels are 280x260, sprites contained within panels, all text word-wrapped to 250px, description lines spaced 28px apart, all elements shifted down for comfortable breathing room with no overflow or crowding</done>
</task>

</tasks>

<verification>
1. TypeScript compiles for client: `cd /Users/jonasbrandvik/Projects/banger-game/client && npx tsc --noEmit`
2. GameScene.ts createTilemap has overviewActive guard around setZoom and fallback follow, but NOT around setBounds
3. HelpScene.ts has wordWrap on descriptions, 280x260 panels, 28px line spacing, sprite at rolesY+45
</verification>

<success_criteria>
- Match-start overview animation cannot be clobbered by createTilemap running during the 1.5s overview pause
- Help screen text fits within panel backgrounds with visible padding on all sides
- Description lines have readable spacing (28px intervals instead of 22px)
- Both files compile without TypeScript errors
</success_criteria>

<output>
After completion, create `.planning/phases/07-hd-viewport-camera/07-09-SUMMARY.md`
</output>
