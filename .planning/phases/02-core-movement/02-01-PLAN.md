---
phase: 02-core-movement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/physics.ts
  - server/src/schema/GameState.ts
  - server/src/rooms/GameRoom.ts
  - server/src/config.ts
autonomous: true

must_haves:
  truths:
    - "Server applies acceleration-based movement (velocity accumulates from input, decays via drag)"
    - "Player velocity is synced to clients (vx, vy fields in schema)"
    - "Server tracks last processed input sequence per player for reconciliation"
    - "Physics constants are shared between client and server from a single source"
    - "Diagonal movement is normalized (not faster than cardinal)"
  artifacts:
    - path: "shared/physics.ts"
      provides: "Shared physics constants and applyMovementPhysics function"
      contains: "applyMovementPhysics"
    - path: "server/src/schema/GameState.ts"
      provides: "Player schema with vx, vy, lastProcessedSeq fields"
      contains: "lastProcessedSeq"
    - path: "server/src/rooms/GameRoom.ts"
      provides: "Acceleration-based fixedTick with sequence tracking"
      contains: "applyMovementPhysics"
  key_links:
    - from: "server/src/rooms/GameRoom.ts"
      to: "shared/physics.ts"
      via: "import applyMovementPhysics and PHYSICS constants"
      pattern: "applyMovementPhysics"
    - from: "server/src/schema/GameState.ts"
      to: "shared/physics.ts"
      via: "velocity fields enable prediction reconciliation"
      pattern: "lastProcessedSeq"
---

<objective>
Implement shared acceleration-based physics and upgrade the server to use velocity-based movement with input sequence tracking.

Purpose: Replace Phase 1's placeholder 2px movement with proper acceleration/drag/maxVelocity physics. Add velocity and sequence fields to schema so the client can perform prediction and reconciliation in Plan 02.

Output: Shared physics module used by server, Player schema with velocity sync, server fixedTick processing acceleration physics with sequence tracking.
</objective>

<execution_context>
@/Users/jonasbrandvik/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jonasbrandvik/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-core-movement/02-RESEARCH.md
@.planning/phases/01-foundation-server-architecture/01-03-SUMMARY.md
@server/src/schema/GameState.ts
@server/src/rooms/GameRoom.ts
@server/src/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared physics constants and movement function</name>
  <files>shared/physics.ts</files>
  <action>
Create `shared/physics.ts` at the project root level (not inside client/ or server/). This file will be imported by both client and server via relative paths.

Define and export:

1. `PHYSICS` constants object:
   - `acceleration: 600` (px/s^2 applied when input held)
   - `drag: 0.85` (exponential damping factor per second)
   - `maxVelocity: 200` (px/s max speed cap)
   - `minVelocity: 0.01` (threshold below which velocity snaps to 0)
   - `facingThreshold: 10` (speed threshold for updating facing angle)

2. `ARENA` constants object:
   - `width: 800`
   - `height: 600`

3. `NETWORK` constants object:
   - `tickRate: 60`
   - `fixedTimeStep: 1000 / 60` (16.67ms)
   - `interpolationDelay: 100` (ms behind server time for remote rendering)

4. `InputState` interface: `{ left: boolean; right: boolean; up: boolean; down: boolean }`

5. `applyMovementPhysics(player, input, dt)` function:
   - `player` has `{ x, y, vx, vy, angle }` (mutated in place)
   - `input` is `InputState`
   - `dt` is delta time in seconds (e.g., 1/60)
   - Apply acceleration from input directions
   - Normalize diagonal (divide by sqrt(2) when both axes active)
   - Integrate velocity: `vx += ax * dt`, `vy += ay * dt`
   - Apply drag: `vx *= Math.pow(drag, dt)`, `vy *= Math.pow(drag, dt)`
   - Clamp to maxVelocity
   - Snap to 0 if below minVelocity
   - Integrate position: `x += vx * dt`, `y += vy * dt`

6. `updateFacingDirection(player)` function:
   - Only update `angle` if speed > `facingThreshold`
   - `angle = Math.atan2(vy, vx)`

Keep this file pure TypeScript with no dependencies on Phaser, Colyseus, or Node.js APIs. It must be importable from both environments.
  </action>
  <verify>
Run: `npx tsc --noEmit shared/physics.ts` (or verify it compiles by checking imports from server side). The file should export PHYSICS, ARENA, NETWORK, InputState, applyMovementPhysics, and updateFacingDirection.
  </verify>
  <done>
shared/physics.ts exists with all constants and functions. No external dependencies. Types are clean and importable from both client and server.
  </done>
</task>

<task type="auto">
  <name>Task 2: Upgrade Player schema and server physics to acceleration-based movement</name>
  <files>server/src/schema/GameState.ts, server/src/rooms/GameRoom.ts, server/src/config.ts</files>
  <action>
**GameState.ts changes:**
- Add `@type("number") vx: number = 0` to Player schema (synced velocity X)
- Add `@type("number") vy: number = 0` to Player schema (synced velocity Y)
- Add `@type("number") lastProcessedSeq: number = 0` to Player schema (for client reconciliation)
- Update `inputQueue` type from `any[]` to `Array<{ seq: number } & InputState>` (import InputState from shared/physics.ts — use relative path `../../shared/physics`)

**GameRoom.ts changes:**
- Import `applyMovementPhysics`, `updateFacingDirection`, `PHYSICS`, `ARENA` from `../../shared/physics`
- Update `isValidInput()` to also accept `seq` field (number type). The valid keys become `['left', 'right', 'up', 'down', 'seq']`. The `seq` field must be a number if present.
- Update `onMessage("input")` handler: extract `seq` from message, store `{ seq, ...input }` in inputQueue (keep existing latency simulation and rate limiting logic)
- Replace the placeholder movement in `fixedTick()`:
  ```
  while (player.inputQueue.length > 0) {
    const { seq, ...input } = player.inputQueue.shift()!;
    applyMovementPhysics(player, input, FIXED_DT);
    updateFacingDirection(player);
    player.lastProcessedSeq = seq;
  }
  ```
  Where `FIXED_DT = 1/60` (constant, not derived from deltaTime parameter, to ensure determinism with client prediction)
- Keep arena bounds clamping after physics: use `ARENA.width` and `ARENA.height` instead of `GAME_CONFIG`
- After clamping, also clamp velocity to 0 if player is at arena edge (prevent sliding along walls with accumulated velocity that would cause misprediction)

**config.ts changes:**
- Remove `arenaWidth` and `arenaHeight` from GAME_CONFIG (now in shared/physics.ts ARENA)
- Keep `maxPlayers` and `playerStartHealth` in GAME_CONFIG
- Remove `tickRate`, `fixedTimeStep`, `patchRate` from SERVER_CONFIG, replace with imports from shared/physics NETWORK constants
- Keep `port` in SERVER_CONFIG

Update any remaining references to removed config values to use the shared imports instead.

**Important:** The fixed deltaTime for physics must be `1/60` (0.016667s), NOT the `deltaTime` parameter passed to `fixedTick()` (which is in milliseconds). This ensures client and server use identical timestep for deterministic prediction.
  </action>
  <verify>
1. `cd server && npx tsc --noEmit` — TypeScript compiles with zero errors
2. `cd server && npm run dev` — Server starts without errors
3. Open browser to http://localhost:8080 — Player can still move with WASD (now with acceleration feel instead of fixed 2px)
4. Check server console: no errors on input processing
5. Open Colyseus monitor (http://localhost:2567/colyseus) — Player state shows vx, vy, lastProcessedSeq fields
  </verify>
  <done>
Server uses acceleration-based physics from shared module. Player schema includes vx, vy, lastProcessedSeq. Physics constants centralized in shared/physics.ts. Server compiles and runs. Movement feels different from Phase 1 (acceleration/deceleration instead of fixed speed).
  </done>
</task>

</tasks>

<verification>
1. `shared/physics.ts` exists and exports PHYSICS, ARENA, NETWORK, InputState, applyMovementPhysics, updateFacingDirection
2. Server compiles with `npx tsc --noEmit` (no errors)
3. Player schema has vx, vy, lastProcessedSeq fields (visible in Colyseus monitor)
4. Server applies acceleration physics (player accelerates/decelerates, doesn't teleport)
5. Diagonal movement is not faster than cardinal movement
6. Player stops when no input (drag brings velocity to 0)
7. Player cannot move outside arena bounds
</verification>

<success_criteria>
- Shared physics module exists and is importable from both environments
- Server movement uses acceleration/drag/maxVelocity instead of fixed 2px increments
- Player velocity and sequence number synced to clients via schema
- Server and client will use identical physics timestep (1/60s) for deterministic prediction
</success_criteria>

<output>
After completion, create `.planning/phases/02-core-movement/02-01-SUMMARY.md`
</output>
