---
phase: 03-combat-system
plan: 02
type: execute
wave: 2
depends_on: ["03-01"]
files_modified:
  - client/src/scenes/GameScene.ts
  - client/src/systems/Prediction.ts
autonomous: false

must_haves:
  truths:
    - "Pressing fire key (spacebar or left-click) sends fire input to server"
    - "Projectiles appear on screen when server spawns them and move smoothly"
    - "Projectiles disappear when they hit a player or expire"
    - "Player health displayed visually (health bar or text)"
    - "Dead players (health=0) visually indicated"
    - "Different character roles visually distinguishable (color or size)"
    - "Combat feels responsive -- fire-to-visual delay under 50ms at 0 latency"
  artifacts:
    - path: "client/src/scenes/GameScene.ts"
      provides: "Fire input, projectile rendering, health display, role visualization"
      contains: "projectiles.onAdd"
    - path: "client/src/systems/Prediction.ts"
      provides: "Updated prediction to include fire input in sent messages"
      contains: "fire"
  key_links:
    - from: "client/src/scenes/GameScene.ts"
      to: "server fire handler"
      via: "room.send input with fire:true"
      pattern: "fire.*true"
    - from: "client/src/scenes/GameScene.ts"
      to: "server/src/schema/GameState.ts"
      via: "room.state.projectiles.onAdd/onRemove"
      pattern: "projectiles\\.onAdd"
---

<objective>
Add client-side combat rendering: fire input, projectile visualization, health display, and character role differentiation.

Purpose: Makes the combat system visible and interactive. Players can fire, see projectiles, track health, and distinguish character roles. Completes the combat loop from server-only to full client-server gameplay.

Output: Client that sends fire input, renders projectiles from server state, shows health per player, distinguishes Paran from guardians visually, and handles dead player state.
</objective>

<execution_context>
@/Users/jonasbrandvik/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jonasbrandvik/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-combat-system/03-RESEARCH.md
@.planning/phases/03-combat-system/03-01-SUMMARY.md

Key existing code:
@client/src/scenes/GameScene.ts
@client/src/systems/Prediction.ts
@shared/characters.ts
@shared/physics.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add fire input, projectile rendering, health display, and role differentiation to client</name>
  <files>client/src/scenes/GameScene.ts, client/src/systems/Prediction.ts</files>
  <action>
    **Update `client/src/systems/Prediction.ts`:**
    The sendInput method currently sends `{ seq, left, right, up, down }`. Update it to also include `fire` from InputState (which now has fire:boolean from Plan 01's physics.ts update). The prediction system itself doesn't predict fire (no client-side projectile prediction), but it must forward the fire flag to the server.

    **Update `client/src/scenes/GameScene.ts`:**

    **1. Fire input binding:**
    Add spacebar key binding in create():
    ```typescript
    this.fireKey = this.input.keyboard!.addKey(Phaser.Input.Keyboard.KeyCodes.SPACE);
    ```
    Also support left mouse click: `this.input.on('pointerdown', ...)` -- but for simplicity start with spacebar only. Mouse aiming is a Phase 7 concern.

    In update(), read fire state:
    ```typescript
    const input: InputState = {
      left: ...,
      right: ...,
      up: ...,
      down: ...,
      fire: this.fireKey.isDown,
    };
    ```

    **2. Projectile rendering:**
    Add a Map to track projectile sprites: `private projectileSprites: Map<number, Phaser.GameObjects.Arc> = new Map()`

    In create(), after room connection, listen for projectile add/remove:
    ```typescript
    this.room.state.projectiles.onAdd((projectile: any, index: number) => {
      const color = projectile.ownerId === this.room!.sessionId ? 0xffff00 : 0xff6600;
      const circle = this.add.circle(projectile.x, projectile.y, 4, color);
      circle.setDepth(5);
      this.projectileSprites.set(index, circle);

      projectile.onChange(() => {
        circle.x = projectile.x;
        circle.y = projectile.y;
      });
    });

    this.room.state.projectiles.onRemove((projectile: any, index: number) => {
      const sprite = this.projectileSprites.get(index);
      if (sprite) {
        sprite.destroy();
        this.projectileSprites.delete(index);
      }
    });
    ```

    Color own projectiles yellow (0xffff00), enemy projectiles orange (0xff6600).

    **3. Health display:**
    Add a Map for health bars: `private healthBars: Map<string, Phaser.GameObjects.Graphics> = new Map()`

    In the player onAdd handler, create a health bar above each player:
    - Green bar (width proportional to health/maxHealth)
    - Position above the player sprite (y - 25)
    - Update on player.onChange (redraw bar width based on current health)

    Import CHARACTERS from shared/characters.ts for maxHealth lookup based on player.role.

    In update(), update health bar positions to follow player sprites.

    **4. Role visualization:**
    In the player onAdd handler, differentiate visuals by role:
    - Paran: larger rectangle (32x32), color 0xff4444 (red), thicker border
    - Guardians (faran/baran): smaller rectangle (24x24), color 0x00ff88 (green) for local, 0x4488ff (blue) for remote guardian

    Listen for role changes via player.onChange -- update sprite size/color when role is assigned (role may not be set at the exact moment of onAdd if there's a race).

    **5. Dead player state:**
    When player.health reaches 0 (detected in onChange):
    - Set sprite alpha to 0.3 (ghosted)
    - Stop processing input for dead local player (skip sendInput if health <= 0)
    - Show "ELIMINATED" text above dead player

    **6. Input sending update:**
    The existing condition `if (hasInput || hasVelocity)` should also consider fire: send input if fire is pressed even if not moving. Update to: `if (hasInput || hasVelocity || input.fire)`.
  </action>
  <verify>
    Run `cd /Users/jonasbrandvik/Projects/banger-game/client && npx tsc --noEmit` -- must compile with zero errors.
    Run both server and client. Open two browser tabs. Verify:
    - First player appears larger (Paran)
    - Second player appears smaller (guardian)
    - Pressing spacebar fires projectiles
    - Projectiles visible as colored circles
    - Health bars visible above players
    - Projectile hitting player reduces health bar
  </verify>
  <done>
    Spacebar sends fire input to server via prediction system.
    Projectiles render as circles (yellow for own, orange for enemy).
    Projectiles appear on add, update position on change, disappear on remove.
    Health bars display above each player, proportional to current/max health.
    Paran visually distinct (larger, red) from guardians (smaller, green/blue).
    Dead players shown ghosted with "ELIMINATED" text.
    Client compiles cleanly.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify combat gameplay feel</name>
  <files>N/A (verification only)</files>
  <action>
Human verification checkpoint. Verify the full combat loop: fire input, projectile rendering, collision damage, health display, character differentiation, and Paran wall penalty.

**Setup:**
1. Start server: `cd server && npx ts-node-dev src/index.ts`
2. Start client: `cd client && npx vite --port 8080`
3. Open http://localhost:8080 in two browser tabs

**Test 1 -- Character differentiation:**
- First tab (Paran): larger red square, health bar showing 150 HP
- Second tab (guardian): smaller green/blue square, health bar showing 50 HP

**Test 2 -- Combat firing:**
- Press spacebar in either tab -- projectile should fire in facing direction
- Move to change facing direction, then fire -- projectile should follow facing
- Fire at the other player -- health bar should decrease on hit
- Guardian should die in 2 hits from Paran (40 damage x2 > 50 HP) -- verify "ELIMINATED" state
- Paran should take many guardian hits (10 damage each, 150 HP = 15 hits)

**Test 3 -- Fire rate:**
- Hold spacebar as guardian -- should fire rapidly (~5/sec)
- Hold spacebar as Paran -- should fire slowly (~1/sec)

**Test 4 -- Paran wall penalty:**
- As Paran, build up speed, then hit arena edge
- Paran should stop COMPLETELY (both axes)
- As guardian, hit arena edge -- should only stop on the axis that hit

**Test 5 -- Projectile cleanup:**
- Fire projectiles that miss -- they should disappear after ~2 seconds
- Fire at arena edge -- projectiles should despawn at boundary

**Optional: Test with latency**
- Set SIMULATE_LATENCY=150 on server
- Verify combat still feels playable (projectiles appear within reasonable delay)
  </action>
  <verify>Human approves combat feel in all 5 test areas</verify>
  <done>Combat loop feels responsive. Character differentiation is clear. Paran wall penalty is observable. Fire rates match character types. Projectiles spawn, collide, and despawn correctly.</done>
</task>

</tasks>

<verification>
1. `cd /Users/jonasbrandvik/Projects/banger-game/client && npx tsc --noEmit` compiles without errors
2. `cd /Users/jonasbrandvik/Projects/banger-game/server && npx tsc --noEmit` compiles without errors
3. Projectiles fire in facing direction on spacebar press
4. Projectiles deal damage on hit (health bar decreases)
5. Players die at 0 health (ghosted + eliminated text)
6. Paran visually distinct from guardians
7. Fire rate matches character type (5/sec guardian, 1/sec Paran)
8. Paran loses all velocity on wall collision
9. Projectiles despawn after 2s or on bounds exit
</verification>

<success_criteria>
- Full combat loop visible and playable in browser
- Character differentiation clear (size, color, health, fire rate)
- Paran wall penalty observable (full velocity loss vs axis-only for guardians)
- Human approves combat feel at checkpoint
</success_criteria>

<output>
After completion, create `.planning/phases/03-combat-system/03-02-SUMMARY.md`
</output>
