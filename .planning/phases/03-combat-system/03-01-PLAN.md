---
phase: 03-combat-system
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/characters.ts
  - shared/physics.ts
  - server/src/schema/Projectile.ts
  - server/src/schema/GameState.ts
  - server/src/rooms/GameRoom.ts
  - server/src/config.ts
autonomous: true

must_haves:
  truths:
    - "Server assigns character roles (faran, baran, paran) with distinct stats on join"
    - "Fire input spawns a projectile at player position traveling in facing direction"
    - "Projectiles deal damage on collision with non-owner players"
    - "Players die (health=0) when hit enough times"
    - "Paran loses ALL velocity on wall collision; guardians only lose axis velocity"
    - "Server enforces fire rate cooldown per character type"
    - "Projectiles despawn after 2s lifetime or when leaving arena bounds"
  artifacts:
    - path: "shared/characters.ts"
      provides: "Character stat definitions for faran, baran, paran"
      exports: ["CharacterStats", "CHARACTERS", "COMBAT"]
    - path: "server/src/schema/Projectile.ts"
      provides: "Colyseus schema for projectile state sync"
      exports: ["Projectile"]
    - path: "server/src/schema/GameState.ts"
      provides: "Updated state with projectiles ArraySchema and player role"
      contains: "projectiles"
    - path: "server/src/rooms/GameRoom.ts"
      provides: "Fire handling, projectile simulation, collision detection, Paran wall penalty"
      contains: "onMessage.*fire"
  key_links:
    - from: "shared/characters.ts"
      to: "server/src/rooms/GameRoom.ts"
      via: "CHARACTERS import for stat lookup"
      pattern: "CHARACTERS\\[.*role\\]"
    - from: "server/src/schema/Projectile.ts"
      to: "server/src/schema/GameState.ts"
      via: "ArraySchema<Projectile>"
      pattern: "ArraySchema.*Projectile"
    - from: "server/src/rooms/GameRoom.ts"
      to: "server/src/schema/Projectile.ts"
      via: "new Projectile() spawn in fire handler"
      pattern: "new Projectile"
---

<objective>
Implement server-authoritative combat: character stats, projectile lifecycle, collision detection, and Paran-specific wall penalty.

Purpose: Establishes the core combat loop server-side. All hit detection, damage, and death are server-authoritative. Character differentiation (guardian vs Paran) creates the asymmetric gameplay foundation.

Output: Server that assigns character roles, handles fire input with cooldown, simulates projectiles at 60Hz, detects collisions (projectile-player and player-wall), applies damage, and enforces Paran's velocity-loss-on-wall-collision mechanic.
</objective>

<execution_context>
@/Users/jonasbrandvik/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jonasbrandvik/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-combat-system/03-RESEARCH.md
@.planning/phases/02-core-movement/02-01-SUMMARY.md

Key existing code to understand before modifying:
@shared/physics.ts
@server/src/schema/GameState.ts
@server/src/rooms/GameRoom.ts
@server/src/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create character stats module and projectile schema</name>
  <files>shared/characters.ts, shared/physics.ts, server/src/schema/Projectile.ts, server/src/schema/GameState.ts</files>
  <action>
    **Create `shared/characters.ts`:**
    Define CharacterStats interface and CHARACTERS record with three archetypes:

    ```typescript
    interface CharacterStats {
      maxHealth: number;
      acceleration: number;
      maxVelocity: number;
      drag: number;
      damage: number;
      fireRate: number;      // ms between shots
      projectileSpeed: number;
    }
    ```

    Character values (these are balance levers -- tunable later):
    - **faran** (guardian): maxHealth=50, acceleration=800, maxVelocity=220, drag=0.88, damage=10, fireRate=200 (5 shots/sec), projectileSpeed=300
    - **baran** (guardian): identical to faran (same archetype, differentiation in Phase 7)
    - **paran** (force): maxHealth=150, acceleration=300, maxVelocity=300, drag=0.95, damage=40, fireRate=1000 (1 shot/sec), projectileSpeed=400

    Also export COMBAT constants:
    ```typescript
    export const COMBAT = {
      playerRadius: 12,
      projectileRadius: 4,
      projectileLifetime: 2000, // ms
    };
    ```

    **Update `shared/physics.ts`:**
    Add `fire: boolean` to InputState interface. This allows fire input to travel through the existing input pipeline alongside movement.

    **Create `server/src/schema/Projectile.ts`:**
    Colyseus schema class with @type decorators for state sync:
    - x, y (number) -- position
    - vx, vy (number) -- velocity
    - ownerId (string) -- sessionId of shooter (prevents self-hit)
    - damage (number) -- damage on hit
    - spawnTime (number) -- for lifetime checks

    Import Schema and type from @colyseus/schema. Use same import pattern as GameState.ts.

    **Update `server/src/schema/GameState.ts`:**
    - Import Projectile and ArraySchema
    - Add `@type([Projectile]) projectiles = new ArraySchema<Projectile>()` to GameState
    - Add server-only `lastFireTime: number = 0` to Player (NO @type decorator -- cooldown enforcement is server-authoritative and does not need client sync, so keep it as a plain class property)
    - Player.role already exists as @type("string") -- no change needed there

    **Update `shared/physics.ts` applyMovementPhysics:**
    Add an optional `stats` parameter to `applyMovementPhysics` that overrides the default PHYSICS constants for acceleration, drag, and maxVelocity. Signature becomes:
    ```typescript
    export function applyMovementPhysics(
      player: { ... },
      input: InputState,
      dt: number,
      stats?: { acceleration: number; drag: number; maxVelocity: number }
    )
    ```
    Inside the function, use `stats?.acceleration ?? PHYSICS.acceleration` (and likewise for drag, maxVelocity) instead of the hardcoded PHYSICS values. This enables character-specific physics in Task 2 without modifying physics.ts there.
  </action>
  <verify>
    Run `cd /Users/jonasbrandvik/Projects/banger-game/server && npx tsc --noEmit` -- must compile with zero errors.
    Verify shared/characters.ts exports CHARACTERS with faran, baran, paran keys.
    Verify Projectile schema has all @type decorated fields.
    Verify GameState has projectiles ArraySchema.
  </verify>
  <done>
    shared/characters.ts exists with 3 character archetypes and COMBAT constants.
    Projectile schema exists with synced fields (x, y, vx, vy, ownerId, damage, spawnTime).
    GameState has projectiles ArraySchema.
    Player has server-only lastFireTime property.
    InputState includes fire boolean.
    Server compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement server combat logic -- fire handling, projectile simulation, collision detection, Paran wall penalty</name>
  <files>server/src/rooms/GameRoom.ts, server/src/config.ts</files>
  <action>
    **Update `server/src/rooms/GameRoom.ts`:**

    Import CHARACTERS and COMBAT from shared/characters.ts. Import Projectile from schema.

    **1. Character role assignment in onJoin():**
    Assign roles based on join order: first player = "paran", second and third = "faran"/"baran". Apply character stats:
    - Set player.health from CHARACTERS[role].maxHealth
    - Store role in player.role (already a synced field)

    Update physics application to use character-specific stats instead of shared PHYSICS constants. In fixedTick, when calling applyMovementPhysics, pass the character-specific stats via the optional `stats` parameter added to applyMovementPhysics in Task 1. Example call: `applyMovementPhysics(player, input, FIXED_DT, { acceleration: stats.acceleration, drag: stats.drag, maxVelocity: stats.maxVelocity })`. No modification to shared/physics.ts needed here -- Task 1 already added the stats override parameter.

    **2. Input validation update:**
    Add 'fire' to validKeys in isValidInput(). fire must be boolean if present.

    **3. Fire input handling:**
    In the input message handler (or in fixedTick when processing queued inputs), when input.fire is true:
    - Check player.health > 0 (dead players can't fire)
    - Check cooldown: `serverTime - player.lastFireTime >= CHARACTERS[player.role].fireRate` (use this.state.serverTime which is in ms -- note: serverTime accumulates deltaTime in ms from fixedTick)
    - Wait -- serverTime accumulates `deltaTime` which is `SERVER_CONFIG.fixedTimeStep` (16.67ms). So serverTime IS in ms. Good.
    - Actually, looking at the code: `this.state.serverTime += deltaTime` where deltaTime is `SERVER_CONFIG.fixedTimeStep` which is `1000/60 = 16.67`. So serverTime is in ms. Cooldown comparison works directly.
    - Spawn Projectile: x=player.x, y=player.y, vx=cos(player.angle)*projectileSpeed, vy=sin(player.angle)*projectileSpeed, ownerId=sessionId, damage=stats.damage, spawnTime=this.state.serverTime
    - Push to this.state.projectiles
    - Set player.lastFireTime = this.state.serverTime

    Fire should be processed as part of the input queue drain in fixedTick, not as a separate message handler. This way fire is synchronized with movement inputs. When draining inputQueue, check if input.fire is true and handle the fire logic.

    **4. Projectile simulation in fixedTick():**
    After player movement processing, add projectile simulation loop. Iterate BACKWARDS (critical -- ArraySchema splice during iteration):

    ```
    for (let i = this.state.projectiles.length - 1; i >= 0; i--) {
      const proj = this.state.projectiles[i];

      // Move
      proj.x += proj.vx * FIXED_DT;
      proj.y += proj.vy * FIXED_DT;

      // Lifetime check (2s)
      if (this.state.serverTime - proj.spawnTime > COMBAT.projectileLifetime) {
        this.state.projectiles.splice(i, 1);
        continue;
      }

      // Bounds check
      if (proj.x < 0 || proj.x > ARENA.width || proj.y < 0 || proj.y > ARENA.height) {
        this.state.projectiles.splice(i, 1);
        continue;
      }

      // Collision with players
      let hit = false;
      this.state.players.forEach((target, targetId) => {
        if (hit) return;
        if (targetId === proj.ownerId) return; // No self-hit
        if (target.health <= 0) return; // Skip dead

        const dx = proj.x - target.x;
        const dy = proj.y - target.y;
        const dist = Math.sqrt(dx * dx + dy * dy);

        if (dist < COMBAT.playerRadius + COMBAT.projectileRadius) {
          target.health = Math.max(0, target.health - proj.damage);
          hit = true;
        }
      });

      if (hit) {
        this.state.projectiles.splice(i, 1);
      }
    }
    ```

    **5. Paran wall collision penalty:**
    In the existing arena edge clamping section, change behavior based on player.role:
    - If player.role === "paran" AND player hits wall: set BOTH vx=0 AND vy=0 (lose ALL velocity)
    - If guardian (faran/baran): keep existing behavior (only zero the axis that hit the wall)

    This is the core asymmetric mechanic -- Paran's momentum penalty.

    **6. Update `server/src/config.ts`:**
    Update playerStartHealth to reference note that it's now per-character (the actual health is set from CHARACTERS in onJoin, so GAME_CONFIG.playerStartHealth becomes a fallback/default). Or simply remove the playerStartHealth usage and use CHARACTERS directly. The cleanest approach: keep GAME_CONFIG.playerStartHealth as a fallback but set player.health from CHARACTERS[role].maxHealth in onJoin.
  </action>
  <verify>
    Run `cd /Users/jonasbrandvik/Projects/banger-game/server && npx tsc --noEmit` -- must compile with zero errors.
    Start server with `cd /Users/jonasbrandvik/Projects/banger-game/server && npx ts-node-dev src/index.ts` and verify it starts without errors.
    Check console output for role assignment on player join.
  </verify>
  <done>
    First player joining gets role "paran" with 150 health; subsequent players get guardian roles with 50 health.
    Fire input in input queue spawns projectile with correct velocity direction and character-specific damage.
    Server enforces fire rate cooldown per character type (200ms for guardians, 1000ms for Paran).
    Projectiles move at 60Hz, despawn after 2s or on bounds exit.
    Projectile-player collision deals damage; self-hit prevented via ownerId check.
    Paran loses ALL velocity on wall collision; guardians only lose axis velocity.
    Movement physics use character-specific acceleration/drag/maxVelocity (not hardcoded PHYSICS defaults).
    Server compiles and starts cleanly.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/jonasbrandvik/Projects/banger-game/server && npx tsc --noEmit` compiles without errors
2. Server starts and accepts connections
3. First player assigned "paran" role with 150 health
4. Second/third players assigned guardian roles with 50 health
5. shared/characters.ts exports CHARACTERS with correct stats for all 3 archetypes
6. Projectile schema has all required @type fields
7. GameState.projectiles is an ArraySchema<Projectile>
</verification>

<success_criteria>
- Server compiles with zero TypeScript errors
- Character roles assigned on join with correct stats
- Fire input spawns projectiles (visible in GameState.projectiles)
- Projectiles collide with players, deal damage, and despawn
- Paran loses all velocity on wall collision
- Fire rate cooldown enforced server-side
</success_criteria>

<output>
After completion, create `.planning/phases/03-combat-system/03-01-SUMMARY.md`
</output>
