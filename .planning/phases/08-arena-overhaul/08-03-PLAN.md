---
phase: 08-arena-overhaul
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - client/src/systems/Prediction.ts
  - client/src/scenes/GameScene.ts
  - shared/physics.ts
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "PredictionSystem uses correct 1600x1216 arena bounds for edge clamping, not 800x608"
    - "Player movement prediction matches server physics with no position jumping or invisible wall collisions"
    - "ARENA fallback constant reflects actual arena dimensions so any code path using it as default is safe"
  artifacts:
    - path: "client/src/systems/Prediction.ts"
      provides: "setArenaBounds() method for dynamic bound updates"
      contains: "setArenaBounds"
    - path: "shared/physics.ts"
      provides: "Updated ARENA fallback constant matching new arena size"
      contains: "1600"
  key_links:
    - from: "client/src/scenes/GameScene.ts"
      to: "PredictionSystem.setArenaBounds()"
      via: "call in createTilemap after mapMetadata is confirmed"
      pattern: "prediction.*setArenaBounds"
---

<objective>
Fix collision desync caused by PredictionSystem using wrong arena bounds (800x608 instead of 1600x1216).

Purpose: The `onAdd` callback fires before `onStateChange.once`, so `mapMetadata` is null when PredictionSystem is constructed. It falls back to the old `ARENA` constant (800x608), clamping all predicted positions to a quarter of the actual arena. This causes massive desync -- invisible walls, position jumping, characters clipping through geometry.

Output: PredictionSystem dynamically receives correct bounds after map loads, ARENA fallback updated.
</objective>

<execution_context>
@/Users/jonasbrandvik/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jonasbrandvik/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-arena-overhaul/08-UAT.md
@client/src/systems/Prediction.ts
@client/src/scenes/GameScene.ts
@shared/physics.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add setArenaBounds to PredictionSystem and update ARENA fallback</name>
  <files>client/src/systems/Prediction.ts, shared/physics.ts</files>
  <action>
1. In `shared/physics.ts`, update the ARENA fallback constant from `{width: 800, height: 608}` to `{width: 1600, height: 1216}` (50*32, 38*32). Keep the comment explaining it is a fallback default -- map-specific bounds should be used instead.

2. In `client/src/systems/Prediction.ts`, add a `setArenaBounds(bounds: { width: number; height: number })` method to the PredictionSystem class. This method updates `this.arenaBounds` to the provided bounds. Place it after the existing `setCollisionGrid` method (around line 44) for logical grouping.

The constructor already accepts optional `arenaBounds` and falls back to `ARENA`. The new method allows updating bounds after construction, which is the fix for the race condition where onAdd fires before mapMetadata is available.
  </action>
  <verify>
Run `cd /Users/jonasbrandvik/Projects/banger-game/client && npx tsc --noEmit` to verify TypeScript compiles. Grep for `setArenaBounds` in Prediction.ts to confirm method exists. Grep for `1600` in shared/physics.ts to confirm ARENA update.
  </verify>
  <done>
PredictionSystem has setArenaBounds() method. ARENA fallback constant is 1600x1216. TypeScript compiles cleanly.
  </done>
</task>

<task type="auto">
  <name>Task 2: Call setArenaBounds from createTilemap in GameScene</name>
  <files>client/src/scenes/GameScene.ts</files>
  <action>
In `GameScene.createTilemap()`, after the collision grid is passed to prediction (around line 1331-1333), add a call to update arena bounds on the prediction system using mapMetadata.

The code should be placed right after the existing `if (this.prediction) { this.prediction.setCollisionGrid(this.collisionGrid); }` block (inside the `if (mapData)` check). Add:

```typescript
// Update prediction arena bounds now that mapMetadata is confirmed
if (this.prediction && this.mapMetadata) {
  this.prediction.setArenaBounds({
    width: this.mapMetadata.width,
    height: this.mapMetadata.height,
  });
}
```

This ensures that even when PredictionSystem was constructed with the fallback ARENA bounds (because onAdd fired before onStateChange.once), it gets corrected as soon as the tilemap loads and mapMetadata is available.

IMPORTANT: Do NOT change the PredictionSystem constructor call in `createPlayerSprite` -- the existing fallback logic is fine as a temporary default. The createTilemap call is the authoritative correction.
  </action>
  <verify>
Run `cd /Users/jonasbrandvik/Projects/banger-game/client && npx tsc --noEmit` to verify TypeScript compiles. Grep for `setArenaBounds` in GameScene.ts to confirm the call exists in createTilemap.
  </verify>
  <done>
GameScene.createTilemap() calls prediction.setArenaBounds() with mapMetadata dimensions after collision grid is set. The race condition between onAdd and onStateChange.once no longer causes wrong bounds. TypeScript compiles cleanly.
  </done>
</task>

</tasks>

<verification>
1. `cd /Users/jonasbrandvik/Projects/banger-game/client && npx tsc --noEmit` -- zero errors
2. `cd /Users/jonasbrandvik/Projects/banger-game/server && npx tsc --noEmit` -- zero errors (shared/physics.ts is imported by server)
3. Grep confirms: `setArenaBounds` exists in Prediction.ts AND is called in GameScene.ts
4. Grep confirms: ARENA in shared/physics.ts shows 1600 and 1216
</verification>

<success_criteria>
- PredictionSystem.setArenaBounds() method exists and updates internal arenaBounds
- GameScene.createTilemap() calls setArenaBounds() with mapMetadata after collision grid setup
- ARENA fallback constant is 1600x1216
- Both client and server TypeScript compile with zero errors
- Edge clamping in prediction uses correct 1600x1216 bounds regardless of construction timing
</success_criteria>

<output>
After completion, create `.planning/phases/08-arena-overhaul/08-03-SUMMARY.md`
</output>
