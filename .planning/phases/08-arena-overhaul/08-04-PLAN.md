---
phase: 08-arena-overhaul
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - shared/maps.ts
  - scripts/generate-arenas.py
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "Each map has unique spawn points positioned on empty ground tiles with clearance from walls and obstacles"
    - "Paran spawns in center area of each map, separated from guardians"
    - "Guardians spawn in opposite quadrants (faran top-left area, baran bottom-right area)"
    - "No spawn point overlaps with or is adjacent to solid tiles (walls or obstacles)"
  artifacts:
    - path: "shared/maps.ts"
      provides: "Per-map spawn points validated against tile data"
    - path: "scripts/generate-arenas.py"
      provides: "Spawn validation function that verifies all spawns are on open ground"
  key_links:
    - from: "shared/maps.ts"
      to: "server/src/rooms/GameRoom.ts"
      via: "spawnPoints read during onJoin"
      pattern: "mapMetadata.spawnPoints"
    - from: "scripts/generate-arenas.py"
      to: "shared/maps.ts"
      via: "spawn coordinates are derived from map analysis, manually transferred"
      pattern: "spawnPoints"
---

<objective>
Fix spawn positions so players never spawn inside walls or obstacles on any map.

Purpose: All 3 maps currently share identical hardcoded spawn points (paran:800,608 faran:200,200 baran:1400,1016) that were never validated against each map's unique obstacle layout. Analysis shows 8 of 9 spawn-map combinations land on or adjacent to solid tiles, causing players to spawn stuck in geometry.

Output: Each map has unique, validated spawn coordinates on open ground with buffer clearance.
</objective>

<execution_context>
@/Users/jonasbrandvik/.claude/get-shit-done/workflows/execute-plan.md
@/Users/jonasbrandvik/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-arena-overhaul/08-UAT.md
@shared/maps.ts
@scripts/generate-arenas.py
@server/src/rooms/GameRoom.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add spawn validation to generate-arenas.py and update shared/maps.ts with safe per-map spawns</name>
  <files>scripts/generate-arenas.py, shared/maps.ts</files>
  <action>
**Part A: Add spawn validation to generate-arenas.py**

Add a `find_safe_spawn(data, w, h, region, buffer=1)` function that finds spawn-safe coordinates. Parameters:
- `data`: walls layer tile array
- `w`, `h`: map dimensions
- `region`: tuple (x1, y1, x2, y2) defining search area in tile coords
- `buffer`: number of clear tiles required around spawn (default 1)

The function scans the region for a tile where ALL tiles in a (2*buffer+1)x(2*buffer+1) area centered on the candidate are empty (value 0). Returns the first match as pixel coordinates (tileX * 32 + 16, tileY * 32 + 16) -- center of tile.

Add a `validate_spawns()` function called after map generation that:
1. For each generated map, loads the JSON and extracts the Walls layer
2. Defines 3 search regions per map:
   - paran (center): tiles 16-33, 12-25
   - faran (top-left): tiles 3-20, 3-15
   - baran (bottom-right): tiles 30-46, 23-34
3. Calls find_safe_spawn for each role
4. Prints the validated spawn coordinates for manual transfer to maps.ts
5. Raises an error if any spawn cannot be found (should never happen with current layouts)

Call validate_spawns() at the end of main, after map connectivity verification.

**Part B: Update shared/maps.ts with validated per-map spawn points**

Based on analysis of the actual map tile data, update each map entry with these verified-safe spawn points (all confirmed to have 1+ tile buffer of empty ground):

hedge_garden:
- paran: { x: 800, y: 480 } -- tile (25, 15), center of large open area
- faran: { x: 512, y: 96 } -- tile (16, 3), open corridor north
- baran: { x: 960, y: 736 } -- tile (30, 23), open area south-east

brick_fortress:
- paran: { x: 768, y: 384 } -- tile (24, 12), open corridor above central chamber
- faran: { x: 288, y: 96 } -- tile (9, 3), inside top-left room
- baran: { x: 1088, y: 640 } -- tile (34, 20), open corridor near bottom-right room

timber_yard:
- paran: { x: 640, y: 384 } -- tile (20, 12), open area left of vertical spine gap
- faran: { x: 128, y: 96 } -- tile (4, 3), open corner top-left
- baran: { x: 1216, y: 640 } -- tile (38, 20), open area right of horizontal spine

These coordinates were pre-validated: each has a 1-tile buffer of empty ground tiles in all directions per the generated map data.
  </action>
  <verify>
1. Run `cd /Users/jonasbrandvik/Projects/banger-game && python3 scripts/generate-arenas.py` -- should complete with spawn validation passing for all 9 spawn points
2. Run `cd /Users/jonasbrandvik/Projects/banger-game/server && npx tsc --noEmit` -- verify shared/maps.ts compiles
3. Run `cd /Users/jonasbrandvik/Projects/banger-game/client && npx tsc --noEmit` -- verify shared/maps.ts compiles
4. Run a quick Python check: for each map JSON, confirm the tile at each spawn coordinate (px/32, py/32) and its 1-tile neighbors are all 0 in the Walls layer
  </verify>
  <done>
Each of the 3 maps has unique spawn points verified to be on empty ground with 1-tile buffer clearance. generate-arenas.py includes spawn validation that runs automatically. No spawn-map combination lands on or adjacent to solid tiles.
  </done>
</task>

</tasks>

<verification>
1. Python spawn validation passes for all 9 spawn points across 3 maps
2. Both client and server TypeScript compile with zero errors
3. Spawn coordinates in maps.ts match the validated positions (not the old shared 800,608 / 200,200 / 1400,1016)
4. Each map has DIFFERENT spawn coordinates (not identical across maps)
</verification>

<success_criteria>
- All 3 maps have unique per-map spawn points in shared/maps.ts
- No spawn point is on or adjacent to a solid tile (wall or obstacle)
- Paran spawns in center area, guardians in opposite corners of each map
- generate-arenas.py validates spawns automatically when run
- Server and client TypeScript compile cleanly
</success_criteria>

<output>
After completion, create `.planning/phases/08-arena-overhaul/08-04-SUMMARY.md`
</output>
